########################################
# ğŸ§ª WORKFLOW REUSABLE: QA Pipeline
# Ejecuta tests unitarios, integraciÃ³n, linting y anÃ¡lisis de calidad
# de cÃ³digo usando SonarCloud y CodeQL para entornos QA.
########################################

name: Reusable QA Workflow

# ğŸ”§ Definir como workflow reusable con entradas y secretos configurables
on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: true
    inputs:
      branch:
        description: "Rama donde se ejecutarÃ¡n los anÃ¡lisis (por defecto: qa)"
        required: false
        type: string
        default: "qa"
      projectBaseDir:
        description: "Directorio base del proyecto para SonarCloud"
        required: false
        type: string
        default: "./pipeline-build"
      sonar_args:
        description: "Argumentos adicionales para SonarCloud"
        required: false
        type: string
        default: ""

# ğŸ” Permisos globales requeridos
permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§© JOB 1: TEST UNITARIOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-qa:
    name: Ejecutar Tests Unitarios
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Configurar entorno Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: âš™ï¸ Instalar dependencias
        run: |
          pip install flask pytest

      - name: ğŸ§ª Ejecutar tests unitarios
        run: pytest -v

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”— JOB 2: TEST DE INTEGRACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-integration-qa:
    name: Ejecutar Tests de IntegraciÃ³n
    runs-on: ubuntu-latest
    needs: test-qa

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” AnÃ¡lisis de integraciÃ³n
        run: echo "Comprueba que cada funciÃ³n o mÃ³dulo funciona correctamente en conjunto"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§¹ JOB 3: LINTING Y ANÃLISIS ESTÃTICO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-lint-qa:
    name: AnÃ¡lisis de Estilo y Linting
    runs-on: ubuntu-latest
    needs: test-integration-qa

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” AnÃ¡lisis de estilo
        run: echo "Control de estilo y detecciÃ³n de errores comunes"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # â˜ï¸ JOB 4: ANÃLISIS DE SONARCLOUD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sonarcloud-qa:
    name: AnÃ¡lisis de Calidad con SonarCloud
    runs-on: ubuntu-latest
    needs: test-lint-qa

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Configurar entorno Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: ğŸ”„ Clonar el repositorio app
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/app
          ref: main
          path: pipeline-build
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Instalar dependencias del proyecto
        working-directory: ./pipeline-build
        run: |
          python -m pip install --upgrade pip
          pip install -r local/requirements.txt

      - name: ğŸ§  Ejecutar anÃ¡lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: ${{ inputs.projectBaseDir }}
          args: ${{ inputs.sonar_args }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

      - name: ğŸ”— Mostrar enlace de resultados
        run: |
          echo "âœ… RevisiÃ³n completada. Puedes ver los resultados en:"
          echo "https://sonarcloud.io/project/overview?id=dariasmoises979-blip_app"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ•µï¸ JOB 5: DETECCIÃ“N DE SECRETOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secrets_detection:
    name: DetecciÃ³n de Claves o Secretos
    runs-on: ubuntu-latest
    needs: sonarcloud-qa
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: ğŸ§  Ejecutar anÃ¡lisis de CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "secret"

      - name: âœ… ConfirmaciÃ³n de seguridad
        run: echo "Asegura que no se suban claves o contraseÃ±as al repositorio"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ›¡ï¸ JOB 6: ANÃLISIS DE VULNERABILIDADES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security_vulnerabilities:
    name: AnÃ¡lisis de Vulnerabilidades de Seguridad
    runs-on: ubuntu-latest
    needs: secrets_detection

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: ğŸ§  Ejecutar anÃ¡lisis de seguridad
        uses: github/codeql-action/analyze@v3
        with:
          category: "security"

      - name: âœ… ConfirmaciÃ³n final
        run: echo "Identifica vulnerabilidades de seguridad en el cÃ³digo y dependencias"
