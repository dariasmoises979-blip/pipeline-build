########################################
# ğŸ§ª WORKFLOW REUSABLE: QA Pipeline
# Ejecuta tests unitarios, integraciÃ³n, linting y anÃ¡lisis de calidad
# de cÃ³digo usando SonarCloud y CodeQL para entornos QA.
########################################

name: Reusable QA Workflow

# ğŸ”§ Definir como workflow reusable con entradas y secretos configurables
on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: true
    inputs:
      branch:
        description: "Rama donde se ejecutarÃ¡n los anÃ¡lisis (por defecto: qa)"
        required: false
        type: string
        default: "qa"
      projectBaseDir:
        description: "Directorio base del proyecto para SonarCloud"
        required: false
        type: string
        default: "./pipeline-build"
      sonar_args:
        description: "Argumentos adicionales para SonarCloud"
        required: false
        type: string
        default: ""

# ğŸ” Permisos globales requeridos
permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  #  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #âš™ï¸ JOB 0: PREPARACIÃ“N DEL ENTORNO (clona y empaqueta)
  #â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup-qa:
    name: Preparar entorno QA
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout del workflow repo
        uses: actions/checkout@v4

      - name: ğŸ”„ Clonar el repositorio externo (app)
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/app
          ref: main
          path: pipeline-build
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¾ Empaquetar cÃ³digo del proyecto
        run: tar -czf pipeline-build.tar.gz pipeline-build

      - name: ğŸ“¤ Subir artefacto para siguientes jobs
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: pipeline-build.tar.gz
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§© JOB 1: TEST UNITARIOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-qa:
    name: Ejecutar Tests Unitarios
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ’¾ Descargar artefacto del proyecto
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: ğŸ“¦ Extraer proyecto
        run: tar -xzf pipeline-build.tar.gz

      - name: ğŸ Configurar entorno Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: âš™ï¸ Instalar dependencias
        working-directory: ./pipeline-build/local
        run: pip install -r requirements.txt

      - name: ğŸ§ª Ejecutar tests unitarios
        working-directory: ./pipeline-build/system_info_app
        run: pytest -v


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”— JOB 2: TEST DE INTEGRACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-integration-qa:
    name: Ejecutar Tests de IntegraciÃ³n
    runs-on: ubuntu-latest
    needs: test-qa

    steps:
      - name: ğŸ’¾ Descargar artefacto del proyecto
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: ğŸ“¦ Extraer proyecto
        run: tar -xzf pipeline-build.tar.gz

      - name: ğŸ” Pruebas de integraciÃ³n
        working-directory: ./pipeline-build/system_info_app
        run: echo "Ejecutar pruebas de integraciÃ³n aquÃ­"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§¹ JOB 3: LINTING Y ANÃLISIS ESTÃTICO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-lint-qa:
    name: AnÃ¡lisis de Estilo y Linting
    runs-on: ubuntu-latest
    needs: test-integration-qa

    steps:
      - name: ğŸ’¾ Descargar artefacto del proyecto
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: ğŸ“¦ Extraer proyecto
        run: tar -xzf pipeline-build.tar.gz

      - name: ğŸ” AnÃ¡lisis de estilo (flake8 o similar)
        working-directory: ./pipeline-build/system_info_app
        run: echo "AnÃ¡lisis de estilo o linting con flake8/pylint"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # â˜ï¸ JOB 4: ANÃLISIS DE SONARCLOUD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sonarcloud-qa:
    name: AnÃ¡lisis de Calidad con SonarCloud
    runs-on: ubuntu-latest
    needs: test-lint-qa

    steps:
      - name: ğŸ’¾ Descargar artefacto del proyecto
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: ğŸ“¦ Extraer proyecto
        run: tar -xzf pipeline-build.tar.gz

      - name: ğŸ Configurar entorno Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: âš™ï¸ Instalar dependencias
        working-directory: ./pipeline-build/local
        run: pip install -r requirements.txt

      - name: ğŸ§  Ejecutar anÃ¡lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: ${{ inputs.projectBaseDir }}
          args: ${{ inputs.sonar_args }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

      - name: ğŸ”— Mostrar enlace de resultados
        run: |
          echo "âœ… RevisiÃ³n completada. Resultados:"
          echo "https://sonarcloud.io/project/overview?id=dariasmoises979-blip_app"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ•µï¸ JOB 5: DETECCIÃ“N DE SECRETOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secrets_detection:
    name: DetecciÃ³n de Claves o Secretos
    runs-on: ubuntu-latest
    needs: sonarcloud-qa
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: ğŸ’¾ Descargar artefacto del proyecto
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: ğŸ“¦ Extraer proyecto
        run: tar -xzf pipeline-build.tar.gz

      - name: ğŸ” Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: ğŸ§  Ejecutar anÃ¡lisis de CodeQL (secret detection)
        uses: github/codeql-action/analyze@v3
        with:
          category: "secret"

      - name: âœ… ConfirmaciÃ³n de seguridad
        run: echo "VerificaciÃ³n de secretos completada"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ›¡ï¸ JOB 6: ANÃLISIS DE VULNERABILIDADES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security_vulnerabilities:
    name: AnÃ¡lisis de Vulnerabilidades de Seguridad
    runs-on: ubuntu-latest
    needs: secrets_detection

    steps:
      - name: ğŸ’¾ Descargar artefacto del proyecto
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: ğŸ“¦ Extraer proyecto
        run: tar -xzf pipeline-build.tar.gz

      - name: ğŸ” Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: ğŸ§  Ejecutar anÃ¡lisis de seguridad
        uses: github/codeql-action/analyze@v3
        with:
          category: "security"

      - name: âœ… ConfirmaciÃ³n final
        run: echo "AnÃ¡lisis de vulnerabilidades completado"
