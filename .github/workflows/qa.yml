name: Reusable Date Workflow

on:
  workflow_call:  # permite que otro workflow (padre) lo invoque
    #secrets:
    #  SONAR_TOKEN:
    #    required: true
    #inputs:
    #  branch:
    #    required: false
    #    type: string
    #    default: "qa"

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  test-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Instalar dependencias
        run: |
          pip install flask pytest

      - name: Ejecutar tests
        run: pytest -v
        
  test-integration-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Ejecutar análisis de SonarCloud
        run: echo "Comprueba que cada función o módulo funciona bien individualmente"
    needs: test-qa

  test-lint-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Ejecutar análisis
        run: echo "DControl de estilo, errores comunes"
    needs: test-integration-qa

  sonarcloud-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Ejecutar análisis de SonarCloud
        run: echo "Detección temprana de errores y malas prácticas"
    needs: test-lint-qa

  secrets_detection:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript  # o el lenguaje que uses

      - name: Ejecutar análisis CodeQL
        uses: github/codeql-action/analyze@v2
        with:
          category: "secret"

      - name: Ejecutar análisis de SonarCloud
        run: echo "Asegura que no se suban claves o contraseñas"
    needs: sonarcloud-qa


  security_vulnerabilities:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      # Paso 1: Inicializa CodeQL
      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python  # o python, java, cpp, etc. según tu proyecto
          # Puedes agregar más lenguajes separados por coma

      # Paso 2: Compila o prepara el código si es necesario
      # (por ejemplo, npm install, mvn package, etc.)
      # - run: npm install

      # Paso 3: Ejecuta el análisis de CodeQL
      - name: Ejecutar análisis de CodeQL
        uses: github/codeql-action/analyze@v2
        with:
          category: "security"

      # Paso 4: Ejecutar análisis adicional (opcional)
      - name: Ejecutar análisis de SonarCloud
        run: echo "Identifica vulnerabilidades de seguridad en el código"
    needs: secrets_detection
