########################################
# üß™ WORKFLOW REUSABLE: Date Workflow
# Ejecuta pruebas unitarias, de integraci√≥n, lint y an√°lisis de calidad.
# Pensado para reutilizar en pipelines automatizados.
# test.yml
########################################

name: Reusable Date Workflow

# üîß Definir como workflow reusable
on:
  workflow_call:
    inputs:
      external_repo:
        required: true
        type: string
        description: 'Nombre del repositorio externo'
      external_repo_ref:
        required: true
        type: string
        description: 'Rama o tag del repositorio externo'
      external_repo_path:
        required: false
        type: string
        default: 'app-build'
        description: 'Ruta donde clonar el repositorio externo'
      python_version:
        required: false
        type: string
        default: '3.12'
        description: 'Versi√≥n de Python a usar'
      coverage_threshold:
        required: false
        type: number
        default: 80
        description: 'Umbral m√≠nimo de cobertura de c√≥digo (%)'
      sonar_args:
        required: false
        type: string
        default: ''
        description: 'Argumentos adicionales para SonarCloud'
    secrets:
      EXTERNAL_REPO_TOKEN: 
        required: true
        description: 'Token para acceder al repositorio app'
      SONAR_TOKEN:
        required: false
        description: 'Token de SonarCloud'

permissions:
  actions: read
  contents: write
  security-events: write
  checks: write
  pull-requests: write

# üåç Variables de entorno globales
env:
  PYTHONUNBUFFERED: '1'
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  PIP_NO_CACHE_DIR: '0'

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ‚öôÔ∏è JOB 0: PREPARACI√ìN Y VALIDACI√ìN
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  setup:
    name: ‚öôÔ∏è Setup & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      python-version: ${{ steps.python-info.outputs.version }}
    
    steps:
      - name: üîÑ Clonar el repositorio app
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.external_repo }}
          ref: ${{ inputs.external_repo_ref }}
          path: ${{ inputs.external_repo_path }}
          fetch-depth: 0
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: üêç Configurar Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: üìù Info de Python
        id: python-info
        run: |
          echo "version=${{ steps.setup-python.outputs.python-version }}" >> $GITHUB_OUTPUT
          python --version
          pip --version

      - name: üîë Generar cache key
        id: cache-key
        run: |
          echo "key=${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}" >> $GITHUB_OUTPUT

      - name: üíæ Cache de dependencias pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì• Instalar dependencias base
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f local/requirements.txt ]; then
            pip install -r local/requirements.txt
          fi
          pip install pytest pytest-cov pytest-html pytest-xdist flake8 black pylint bandit safety

      - name: üìä Listar dependencias instaladas
        run: pip list

      - name: üóúÔ∏è Empaquetar c√≥digo del proyecto
        run: tar -czf app-build.tar.gz ${{ inputs.external_repo_path }}

      - name: üì§ Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: app-source
          path: app-build.tar.gz
          retention-days: 1
          compression-level: 9

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üß™ JOB 1: TESTS UNITARIOS CON COBERTURA
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  test-unit:
    name: üß™ Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    
    steps:
      - name: üíæ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source

      - name: üì¶ Extraer c√≥digo
        run: tar -xzf app-build.tar.gz

      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: üíæ Restaurar cache de pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì• Instalar dependencias
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          pip install --upgrade pip
          if [ -f local/requirements.txt ]; then
            pip install -r local/requirements.txt
          fi
          pip install pytest pytest-cov pytest-html pytest-xdist coverage[toml]

      - name: üß™ Ejecutar tests unitarios con cobertura
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          pytest -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=${{ inputs.coverage_threshold }} \
            --html=pytest-report.html \
            --self-contained-html \
            -n auto \
            --maxfail=3 \
            --tb=short
        continue-on-error: false

      - name: üìä Resumen de cobertura
        if: always()
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          if [ -f coverage.xml ]; then
            echo "üìä Cobertura de c√≥digo generada correctamente"
            coverage report
          fi

      - name: üì§ Subir reporte de cobertura
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            ${{ inputs.external_repo_path }}/system_info_app/htmlcov/
            ${{ inputs.external_repo_path }}/system_info_app/coverage.xml
            ${{ inputs.external_repo_path }}/system_info_app/pytest-report.html
          retention-days: 30

      - name: üìà Comentar cobertura en PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.EXTERNAL_REPO_TOKEN }}

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üîó JOB 2: TESTS DE INTEGRACI√ìN
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  test-integration:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: setup

    steps:
      - name: üíæ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source

      - name: üì¶ Extraer c√≥digo
        run: tar -xzf app-build.tar.gz

      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: üíæ Restaurar cache de pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}

      - name: üì• Instalar dependencias
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          pip install --upgrade pip
          if [ -f local/requirements.txt ]; then
            pip install -r local/requirements.txt
          fi
          pip install pytest pytest-integration

      - name: üîó Ejecutar pruebas de integraci√≥n
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          if [ -d "tests/integration" ]; then
            pytest tests/integration/ -v --tb=short
          else
            echo "‚ö†Ô∏è No se encontr√≥ directorio tests/integration/"
            echo "Ejecutando tests de integraci√≥n b√°sicos..."
            python -c "import sys; print('‚úÖ Importaci√≥n de m√≥dulos OK')"
          fi

      - name: üì§ Subir logs de integraci√≥n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs
          path: ${{ inputs.external_repo_path }}/system_info_app/logs/
          retention-days: 7
          if-no-files-found: ignore

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üßπ JOB 3: LINTING Y AN√ÅLISIS DE ESTILO
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  test-lint:
    name: üßπ Lint & Code Style
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup

    steps:
      - name: üíæ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source

      - name: üì¶ Extraer c√≥digo
        run: tar -xzf app-build.tar.gz

      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: üíæ Restaurar cache de pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}

      - name: üì• Instalar herramientas de linting
        run: |
          pip install --upgrade pip
          pip install flake8 black pylint isort mypy

      - name: üîç Flake8 - An√°lisis de errores
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "üîç Ejecutando Flake8..."
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --max-line-length=120 \
            --exclude=__pycache__,.git,venv,env
        continue-on-error: true

      - name: üé® Black - Verificaci√≥n de formato
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "üé® Verificando formato con Black..."
          black --check --diff --color .
        continue-on-error: true

      - name: üìê isort - Orden de imports
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "üìê Verificando imports con isort..."
          isort --check-only --diff .
        continue-on-error: true

      - name: üîé Pylint - An√°lisis de calidad
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "üîé Ejecutando Pylint..."
          pylint **/*.py \
            --fail-under=7.0 \
            --max-line-length=120 \
            --disable=C0111 \
            --output-format=colorized || true

      - name: üìä Generar reporte de linting
        if: always()
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "# üìä Reporte de Linting" > lint-report.md
          echo "" >> lint-report.md
          echo "## Flake8" >> lint-report.md
          flake8 . --statistics --format=default >> lint-report.md || true
          echo "" >> lint-report.md
          echo "## Pylint" >> lint-report.md
          pylint **/*.py --output-format=text >> lint-report.md || true

      - name: üì§ Subir reporte de linting
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: ${{ inputs.external_repo_path }}/system_info_app/lint-report.md
          retention-days: 30

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üîí JOB 4: AN√ÅLISIS DE SEGURIDAD
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  security-scan:
    name: üîí Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup

    steps:
      - name: üíæ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source

      - name: üì¶ Extraer c√≥digo
        run: tar -xzf app-build.tar.gz

      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: üì• Instalar herramientas de seguridad
        run: |
          pip install --upgrade pip
          pip install bandit safety

      - name: üîê Bandit - An√°lisis de c√≥digo
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "üîê Ejecutando Bandit..."
          bandit -r . \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium || true
          bandit -r . -ll

      - name: üõ°Ô∏è Safety - Vulnerabilidades en dependencias
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          echo "üõ°Ô∏è Verificando vulnerabilidades con Safety..."
          if [ -f local/requirements.txt ]; then
            safety check --file=local/requirements.txt --json > safety-report.json || true
            safety check --file=local/requirements.txt
          fi
        continue-on-error: true

      - name: üì§ Subir reportes de seguridad
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            ${{ inputs.external_repo_path }}/system_info_app/bandit-report.json
            ${{ inputs.external_repo_path }}/safety-report.json
          retention-days: 30
          if-no-files-found: ignore

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üìä JOB 5: SONARCLOUD (AN√ÅLISIS DE CALIDAD)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  sonarcloud:
    name: üìä SonarCloud Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test-unit, test-lint]
    if: ${{ secrets.SONAR_TOKEN != '' }}

    steps:
      - name: üíæ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source

      - name: üì¶ Extraer c√≥digo
        run: tar -xzf app-build.tar.gz

      - name: üíæ Descargar reporte de cobertura
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
        continue-on-error: true

      - name: üîé An√°lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: ${{ inputs.external_repo_path }}
          args: ${{ inputs.sonar_args }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: üîó Enlace a resultados
        run: |
          echo "‚úÖ An√°lisis completado"
          echo "üìä Revisa los resultados en SonarCloud"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ‚úÖ JOB 6: RESUMEN Y VALIDACI√ìN FINAL
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  validation-summary:
    name: ‚úÖ Quality Gate Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test-unit, test-integration, test-lint, security-scan]
    if: always()

    steps:
      - name: üìä Generar resumen de calidad
        run: |
          echo "# üéØ Resumen de Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üß™ Tests Unitarios | ${{ needs.test-unit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîó Tests Integraci√≥n | ${{ needs.test-integration.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üßπ Linting | ${{ needs.test-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîí Seguridad | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-unit.result }}" == "success" ]] && \
             [[ "${{ needs.test-integration.result }}" == "success" ]] && \
             [[ "${{ needs.test-lint.result }}" == "success" ]] && \
             [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "## ‚úÖ Quality Gate: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Todos los checks pasaron correctamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Quality Gate: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Algunos checks fallaron, revisa los detalles" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚ùå Fallar si alg√∫n check cr√≠tico fall√≥
        if: needs.test-unit.result != 'success' || needs.security-scan.result != 'success'
        run: |
          echo "::error::Quality Gate fall√≥: Tests unitarios o seguridad no pasaron"
          exit 1

      - name: ‚ö†Ô∏è Advertencia por checks opcionales
        if: needs.test-integration.result != 'success' || needs.test-lint.result != 'success'
        run: |
          echo "::warning::Algunos checks opcionales fallaron pero no bloquean el pipeline"