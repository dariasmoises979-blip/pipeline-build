########################################
# ðŸ§ª WORKFLOW REUSABLE: Date Workflow
# Ejecuta pruebas unitarias, de integraciÃ³n, lint y anÃ¡lisis de calidad.
# Pensado para reutilizar en pipelines automatizados.
# test.yml
########################################

name: Reusable Date Workflow

# ðŸ”§ Definir como workflow reusable
on:
  workflow_call:
    inputs:
      external_repo:
        required: true
        type: string
        description: 'Nombre del repositorio externo (e.g., dariasmoises979-blip/app)'
      external_repo_ref:
        required: true
        type: string
        description: 'Rama o tag del repositorio externo (e.g., main)'
      external_repo_path:
        required: false
        type: string
        default: './app-repo'
        description: 'Ruta donde clonar el repositorio externo'
      python_version:
        required: false
        type: string
        default: '3.12'
        description: 'VersiÃ³n de Python a usar'
      coverage_threshold:
        required: false
        type: number
        default: 80
        description: 'Umbral mÃ­nimo de cobertura de cÃ³digo (%)'
      sonar_args:
        required: false
        type: string
        default: ''
        description: 'Argumentos adicionales para SonarCloud'
      run_integration_tests:
        required: false
        type: boolean
        default: true
        description: 'Ejecutar tests de integraciÃ³n'
      run_security_scan:
        required: false
        type: boolean
        default: true
        description: 'Ejecutar anÃ¡lisis de seguridad'
    secrets:
      EXTERNAL_REPO_TOKEN: 
        required: true
        description: 'Token para acceder al repositorio app (e.g., GH_TOKEN2)'
      SONAR_TOKEN:
        required: false
        description: 'Token de SonarCloud para anÃ¡lisis de calidad'

permissions:
  actions: read
  contents: write
  security-events: write
  checks: write
  pull-requests: write

# ðŸŒ Variables de entorno globales
env:
  PYTHONUNBUFFERED: '1'
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  PIP_NO_CACHE_DIR: '0'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âš™ï¸ JOB 0: PREPARACIÃ“N Y VALIDACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup:
    name: âš™ï¸ Setup & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      python-version: ${{ steps.python-info.outputs.version }}
      has-requirements: ${{ steps.check-files.outputs.has-requirements }}
      has-tests: ${{ steps.check-files.outputs.has-tests }}
    
    steps:
      - name: ðŸ”„ Clonar el repositorio app
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.external_repo }}
          ref: ${{ inputs.external_repo_ref }}
          path: ${{ inputs.external_repo_path }}
          fetch-depth: 0
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: ðŸ“ Verificar estructura del proyecto
        id: check-files
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          echo "ðŸ” Verificando estructura del proyecto..."
          
          # Verificar requirements.txt
          if [ -f "local/requirements.txt" ]; then
            echo "âœ… Encontrado: local/requirements.txt"
            echo "has-requirements=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No encontrado: local/requirements.txt"
            echo "has-requirements=false" >> $GITHUB_OUTPUT
          fi
          
          # Verificar directorio de tests
          if [ -d "system_info_app/tests" ] || [ -d "system_info_app/test" ]; then
            echo "âœ… Encontrado: directorio de tests"
            echo "has-tests=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No encontrado: directorio de tests"
            echo "has-tests=false" >> $GITHUB_OUTPUT
          fi
          
          # Mostrar estructura
          echo "ðŸ“‚ Estructura del proyecto:"
          tree -L 3 -I '__pycache__|*.pyc|venv|env' || ls -la

      - name: ðŸ Configurar Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: ðŸ“ Info de Python
        id: python-info
        run: |
          echo "version=${{ steps.setup-python.outputs.python-version }}" >> $GITHUB_OUTPUT
          echo "ðŸ Python version: $(python --version)"
          echo "ðŸ“¦ Pip version: $(pip --version)"

      - name: ðŸ”‘ Generar cache key
        id: cache-key
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          HASH=$(find . -name "requirements*.txt" -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          echo "key=${{ runner.os }}-pip-${{ inputs.python_version }}-${HASH}" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache de dependencias pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ inputs.python_version }}-
            ${{ runner.os }}-pip-

      - name: ðŸ“¥ Instalar dependencias base
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          echo "ðŸ“¦ Actualizando pip, setuptools y wheel..."
          python -m pip install --upgrade pip setuptools wheel
          
          if [ -f "local/requirements.txt" ]; then
            echo "ðŸ“¥ Instalando dependencias del proyecto..."
            pip install -r local/requirements.txt
          else
            echo "âš ï¸ No se encontrÃ³ local/requirements.txt"
          fi
          
          echo "ðŸ› ï¸ Instalando herramientas de testing y calidad..."
          pip install \
            pytest pytest-cov pytest-html pytest-xdist \
            flake8 black pylint isort mypy \
            bandit safety \
            coverage[toml]

      - name: ðŸ“Š Listar dependencias instaladas
        run: |
          echo "ðŸ“‹ Dependencias instaladas:"
          pip list
          echo ""
          echo "ðŸ“¦ Total de paquetes: $(pip list | wc -l)"

      - name: ðŸ—œï¸ Empaquetar cÃ³digo del proyecto
        run: |
          echo "ðŸ“¦ Empaquetando cÃ³digo..."
          tar -czf app-build.tar.gz ${{ inputs.external_repo_path }}
          echo "âœ… TamaÃ±o del artefacto: $(du -h app-build.tar.gz | cut -f1)"

      - name: ðŸ“¤ Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: app-source-${{ github.run_id }}
          path: app-build.tar.gz
          retention-days: 1
          compression-level: 9

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ§ª JOB 1: TESTS UNITARIOS CON COBERTURA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-unit:
    name: ðŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    
    steps:
      - name: ðŸ’¾ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source-${{ github.run_id }}

      - name: ðŸ“¦ Extraer cÃ³digo
        run: tar -xzf app-build.tar.gz

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: ðŸ’¾ Restaurar cache de pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ inputs.python_version }}-
            ${{ runner.os }}-pip-

      - name: ðŸ“¥ Instalar dependencias
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          pip install --upgrade pip
          
          if [ "${{ needs.setup.outputs.has-requirements }}" = "true" ]; then
            pip install -r local/requirements.txt
          fi
          
          pip install pytest pytest-cov pytest-html pytest-xdist coverage[toml]

      - name: ðŸ§ª Ejecutar tests unitarios con cobertura
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ§ª Iniciando tests unitarios..."
          
          if [ "${{ needs.setup.outputs.has-tests }}" = "true" ]; then
            pytest -v \
              --cov=. \
              --cov-report=xml \
              --cov-report=html \
              --cov-report=term-missing \
              --cov-fail-under=${{ inputs.coverage_threshold }} \
              --html=pytest-report.html \
              --self-contained-html \
              -n auto \
              --maxfail=3 \
              --tb=short \
              --color=yes
          else
            echo "âš ï¸ No se encontraron tests, ejecutando validaciÃ³n bÃ¡sica..."
            python -m pytest --collect-only || echo "No hay tests para ejecutar"
          fi
        continue-on-error: false

      - name: ðŸ“Š Resumen de cobertura
        if: always()
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          if [ -f coverage.xml ]; then
            echo "ðŸ“Š REPORTE DE COBERTURA" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            coverage report >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Cobertura generada correctamente"
          else
            echo "âš ï¸ No se generÃ³ reporte de cobertura"
          fi

      - name: ðŸ“¤ Subir reporte de cobertura
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_id }}
          path: |
            ${{ inputs.external_repo_path }}/system_info_app/htmlcov/
            ${{ inputs.external_repo_path }}/system_info_app/coverage.xml
            ${{ inputs.external_repo_path }}/system_info_app/pytest-report.html
            ${{ inputs.external_repo_path }}/system_info_app/.coverage
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ’¬ Comentar cobertura en PR
        if: github.event_name == 'pull_request' && always()
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.EXTERNAL_REPO_TOKEN }}
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ”— JOB 2: TESTS DE INTEGRACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-integration:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: setup
    if: ${{ inputs.run_integration_tests }}

    steps:
      - name: ðŸ’¾ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source-${{ github.run_id }}

      - name: ðŸ“¦ Extraer cÃ³digo
        run: tar -xzf app-build.tar.gz

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: ðŸ’¾ Restaurar cache de pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¥ Instalar dependencias
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          pip install --upgrade pip
          
          if [ "${{ needs.setup.outputs.has-requirements }}" = "true" ]; then
            pip install -r local/requirements.txt
          fi
          
          pip install pytest pytest-integration

      - name: ðŸ”— Ejecutar pruebas de integraciÃ³n
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ”— Iniciando tests de integraciÃ³n..."
          
          if [ -d "tests/integration" ]; then
            echo "âœ… Encontrado directorio tests/integration/"
            pytest tests/integration/ -v --tb=short --color=yes
          elif [ -d "tests" ]; then
            echo "âš ï¸ Ejecutando todos los tests en tests/"
            pytest tests/ -v --tb=short --color=yes -k "integration or Integration"
          else
            echo "âš ï¸ No se encontrÃ³ directorio de tests de integraciÃ³n"
            echo "Ejecutando validaciÃ³n bÃ¡sica de mÃ³dulos..."
            python -c "
              import sys
              import importlib.util
              print('âœ… Verificando importaciÃ³n de mÃ³dulos...')
              # Agregar aquÃ­ validaciones especÃ­ficas segÃºn tu proyecto
              print('âœ… ImportaciÃ³n de mÃ³dulos OK')
                          "
                        fi

                    - name: ðŸ“¤ Subir logs de integraciÃ³n
                      if: always()
                      uses: actions/upload-artifact@v4
                      with:
          name: integration-logs-${{ github.run_id }}
          path: |
            ${{ inputs.external_repo_path }}/system_info_app/logs/
            ${{ inputs.external_repo_path }}/system_info_app/*.log
          retention-days: 7
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ§¹ JOB 3: LINTING Y ANÃLISIS DE ESTILO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-lint:
    name: ðŸ§¹ Lint & Code Style
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: setup

    steps:
      - name: ðŸ’¾ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source-${{ github.run_id }}

      - name: ðŸ“¦ Extraer cÃ³digo
        run: tar -xzf app-build.tar.gz

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: ðŸ’¾ Restaurar cache de pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¥ Instalar herramientas de linting
        run: |
          pip install --upgrade pip
          pip install flake8 black pylint isort mypy

      - name: ðŸ” Flake8 - AnÃ¡lisis de errores sintÃ¡cticos
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ” Ejecutando Flake8..."
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --max-line-length=120 \
            --exclude=__pycache__,.git,venv,env,build,dist,*.egg-info \
            --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s'
        continue-on-error: true

      - name: ðŸ“ Flake8 - AnÃ¡lisis completo de estilo
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ“ AnÃ¡lisis completo de estilo con Flake8..."
          flake8 . \
            --max-line-length=120 \
            --extend-ignore=E203,W503 \
            --exclude=__pycache__,.git,venv,env,build,dist,*.egg-info \
            --statistics \
            --count || echo "âš ï¸ Se encontraron issues de estilo (no crÃ­ticos)"
        continue-on-error: true

      - name: ðŸŽ¨ Black - VerificaciÃ³n de formato
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸŽ¨ Verificando formato con Black..."
          black --check --diff --color . || {
            echo "âŒ CÃ³digo no formateado con Black"
            echo "ðŸ’¡ Ejecuta: black . para formatear automÃ¡ticamente"
            exit 0
          }
        continue-on-error: true

      - name: ðŸ“ isort - Verificar orden de imports
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ“ Verificando imports con isort..."
          isort --check-only --diff --color . || {
            echo "âŒ Imports no ordenados correctamente"
            echo "ðŸ’¡ Ejecuta: isort . para ordenar automÃ¡ticamente"
            exit 0
          }
        continue-on-error: true

      - name: ðŸ”Ž Pylint - AnÃ¡lisis de calidad de cÃ³digo
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ”Ž Ejecutando Pylint..."
          pylint **/*.py \
            --fail-under=7.0 \
            --max-line-length=120 \
            --disable=C0111,C0103,R0903 \
            --output-format=colorized \
            --score=yes || echo "âš ï¸ Score de Pylint por debajo del umbral (no crÃ­tico)"
        continue-on-error: true

      - name: ðŸ” MyPy - Type Checking (opcional)
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ” Ejecutando MyPy (type checking)..."
          mypy . --ignore-missing-imports --no-strict-optional || echo "âš ï¸ Type hints podrÃ­an mejorarse"
        continue-on-error: true

      - name: ðŸ“Š Generar reporte consolidado de linting
        if: always()
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "# ðŸ“Š Reporte Consolidado de Linting" > lint-report.md
          echo "" >> lint-report.md
          echo "ðŸ• Generado: $(date)" >> lint-report.md
          echo "" >> lint-report.md
          
          echo "## ðŸ” Flake8 - Errores crÃ­ticos" >> lint-report.md
          flake8 . --select=E9,F63,F7,F82 --statistics >> lint-report.md 2>&1 || true
          echo "" >> lint-report.md
          
          echo "## ðŸ“ Flake8 - EstadÃ­sticas completas" >> lint-report.md
          flake8 . --statistics >> lint-report.md 2>&1 || true
          echo "" >> lint-report.md
          
          echo "## ðŸ”Ž Pylint Score" >> lint-report.md
          pylint **/*.py --score=yes 2>&1 | tail -n 10 >> lint-report.md || true

      - name: ðŸ“¤ Subir reporte de linting
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report-${{ github.run_id }}
          path: ${{ inputs.external_repo_path }}/system_info_app/lint-report.md
          retention-days: 30

      - name: ðŸ’¬ Comentario en PR con resultados de linting
        if: github.event_name == 'pull_request' && always()
        run: |
          echo "ðŸ“Š Linting completado. Ver artefactos para detalles."

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ”’ JOB 4: ANÃLISIS DE SEGURIDAD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: ðŸ”’ Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: setup
    if: ${{ inputs.run_security_scan }}

    steps:
      - name: ðŸ’¾ Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-source-${{ github.run_id }}

      - name: ðŸ“¦ Extraer cÃ³digo
        run: tar -xzf app-build.tar.gz

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: ðŸ“¥ Instalar herramientas de seguridad
        run: |
          pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: ðŸ” Bandit - AnÃ¡lisis de seguridad en cÃ³digo
        working-directory: ${{ inputs.external_repo_path }}/system_info_app
        run: |
          echo "ðŸ” Ejecutando Bandit..."
          
          # AnÃ¡lisis con reporte JSON
          bandit -r . \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium || true
          
          # AnÃ¡lisis con salida legible
          echo "ðŸ“‹ Reporte de Bandit:" >> $GITHUB_STEP_SUMMARY
          bandit -r . -ll -f screen >> $GITHUB_STEP_SUMMARY || true
          
          # Mostrar en terminal tambiÃ©n
          bandit -r . -ll

      - name: ðŸ›¡ï¸ Safety - Vulnerabilidades en dependencias
        working-directory: ${{ inputs.external_repo_path }}
        run: |
          echo "ðŸ›¡ï¸ Verificando vulnerabilidades con Safety..."
          
          if [ "${{ needs.setup.outputs.has-requirements }}" = "true" ]; then
            # Generar reporte JSON
            safety check \
              --file=local/requirements.txt \
              --json > safety-report.json || true
            
            # Mostrar reporte legible
            echo "ðŸ“‹ Reporte de Safety:" >> $GITHUB_STEP_SUMMARY
            safety check --file=local/requirements.txt >> $GITHUB_STEP_SUMMARY || true
            
            # Mostrar en terminal
            safety check --file=local/requirements.txt || echo "âš ï¸ Se encontraron vulnerabilidades"
          else
            echo "âš ï¸ No se encontrÃ³ requirements.txt para analizar"
          fi
        continue-on-error: true

      - name: ðŸ” pip-audit - AuditorÃ­a de paquetes instalados
        run: |
          echo "ðŸ” Ejecutando pip-audit..."
          pip-audit --desc --format json > pip-audit-report.json || true
          pip-audit --desc || echo "âš ï¸ Se encontraron issues en dependencias"
        continue-on-error: true

      - name: ðŸ“Š Resumen de seguridad
        if: always()
        run: |
          echo "# ðŸ”’ Resumen de AnÃ¡lisis de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… AnÃ¡lisis completado" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Ver artefactos para reportes detallados" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Subir reportes de seguridad
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: |
            ${{ inputs.external_repo_path }}/system_info_app/bandit-report.json
            ${{ inputs.external_repo_path }}/safety-report.json
            pip-audit-report.json
          retention-days: 30
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“Š JOB 5: SONARCLOUD (ANÃLISIS DE CALIDAD)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sonarcloud:
    name: ðŸ“Š SonarCloud Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [setup, test-unit, test-lint]
    if: ${{ secrets.SONAR_TOKEN != '' }}

    steps:
      - name: ðŸ’¾ Descargar artefacto del cÃ³digo
        uses: actions/download-artifact@v4
        with:
          name: app-source-${{ github.run_id }}

      - name: ðŸ“¦ Extraer cÃ³digo
        run: tar -xzf app-build.tar.gz

      - name: ðŸ’¾ Descargar reporte de cobertura
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-${{ github.run_id }}
          path: coverage-data
        continue-on-error: true

      - name: ðŸ“‹ Preparar reportes para SonarCloud
        run: |
          # Mover coverage.xml al directorio esperado por SonarCloud
          if [ -f "coverage-data/coverage.xml" ]; then
            cp coverage-data/coverage.xml ${{ inputs.external_repo_path }}/system_info_app/
            echo "âœ… Reporte de cobertura preparado"
          else
            echo "âš ï¸ No se encontrÃ³ reporte de cobertura"
          fi

      - name: ðŸ”Ž AnÃ¡lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: ${{ inputs.external_repo_path }}
          args: ${{ inputs.sonar_args }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: ðŸ”— Enlace a resultados
        run: |
          echo "âœ… AnÃ¡lisis de SonarCloud completado" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Revisa los resultados en el dashboard de SonarCloud" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âœ… JOB 6: RESUMEN Y VALIDACIÃ“N FINAL (QUALITY GATE)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validation-summary:
    name: âœ… Quality Gate Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test-unit, test-integration, test-lint, security-scan]
    if: always()

    steps:
      - name: ðŸ“Š Generar resumen ejecutivo
        run: |
          echo "# ðŸŽ¯ Quality Gate - Resumen Ejecutivo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** Date Workflow" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“‹ Resultados por Job" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Estado | CrÃ­tico |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          # Test Unitarios (CRÃTICO)
          if [ "${{ needs.test-unit.result }}" == "success" ]; then
            echo "| ðŸ§ª Tests Unitarios | âœ… PASSED | âš ï¸ SÃ­ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª Tests Unitarios | âŒ FAILED | âš ï¸ SÃ­ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Tests de IntegraciÃ³n (OPCIONAL)
          if [ "${{ needs.test-integration.result }}" == "success" ]; then
            echo "| ðŸ”— Tests IntegraciÃ³n | âœ… PASSED | No |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-integration.result }}" == "skipped" ]; then
            echo "| ðŸ”— Tests IntegraciÃ³n | â­ï¸ SKIPPED | No |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”— Tests IntegraciÃ³n | âŒ FAILED | No |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Linting (OPCIONAL)
          if [ "${{ needs.test-lint.result }}" == "success" ]; then
            echo "| ðŸ§¹ Linting | âœ… PASSED | No |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§¹ Linting | âš ï¸ ISSUES | No |" >> $GITHUB_STEP_SUMMARY
          fi
          
          #