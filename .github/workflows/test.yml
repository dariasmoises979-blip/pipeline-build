########################################
# 🧪 WORKFLOW REUSABLE: Date Workflow
# Ejecuta pruebas unitarias, de integración, lint y análisis de calidad.
# Pensado para reutilizar en pipelines automatizados.
#test.yml
########################################

name: Reusable Date Workflow

# 🔧 Definir como workflow reusable
on:
  workflow_call:
    inputs:
      external_repo:
        required: true
        type: string
        description: 'Nombre del repositorio externo'
      external_repo_ref:
        required: true
        type: string
        description: 'Rama o tag del repositorio externo'
      external_repo_path:
        required: false
        type: string
        description: 'Ruta donde clonar el repositorio externo'
    secrets:
      EXTERNAL_REPO_TOKEN: 
        required: true
        description: 'Token para acceder al repositorio app'

permissions:
  actions: read
  contents: write

jobs:
  # ═══════════════════════════════════════════════════════════
  # 🧩 JOB: TEST UNITARIOS
  # ═══════════════════════════════════════════════════════════
  test-unit:
    name: 🧪 Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: 🔄 Clonar el repositorio app
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/app
          ref: main
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: ⚙️ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: 📥 Instalar dependencias
        run: |
          pip install -r local/requirements.txt

  # ═══════════════════════════════════════════════════════════
  # 🔗 JOB: TEST DE INTEGRACIÓN
  # ═══════════════════════════════════════════════════════════
  test-integration:
    name: 🔗 Integration Tests
    runs-on: ubuntu-latest
    needs: test-unit

    steps:
      - name: 🔄 Clonar el repositorio app
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/app
          ref: main
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: 🧩 Ejecutar pruebas de integración
        run: echo "Comprueba que cada función o módulo funciona correctamente en conjunto"

  # ═══════════════════════════════════════════════════════════
  # 🧹 JOB: LINTER Y ANÁLISIS DE ESTILO
  # ═══════════════════════════════════════════════════════════
  test-lint:
    name: 🧹 Lint & Style Check
    runs-on: ubuntu-latest
    needs: test-integration

    steps:
      - name: 🔄 Clonar el repositorio app
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/app
          ref: main
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: 🔍 Ejecutar análisis de estilo
        run: echo "Control de estilo y detección de errores comunes"

  # ═══════════════════════════════════════════════════════════
  # 📊 JOB: ANÁLISIS DE CALIDAD (SONARCLOUD)
  # ═══════════════════════════════════════════════════════════
  sonarcloud:
    name: 📊 SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: test-lint

    steps:
      - name: 🔄 Clonar el repositorio app
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/app
          ref: main
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}

      - name: 🔎 Ejecutar análisis de SonarCloud
        run: echo "Detección temprana de errores y malas prácticas en el código"