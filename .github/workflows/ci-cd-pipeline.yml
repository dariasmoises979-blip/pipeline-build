########################################
# ğŸš€ CI/CD PIPELINE COMPLETO
# Build de imagen Docker + GitOps deployment con ArgoCD
# Usa outputs del workflow de build para deployment
########################################

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop

  # Permitir ejecuciÃ³n manual con selecciÃ³n de entorno
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - pre
          - prod
      force_build:
        description: 'Force rebuild even if no changes'
        required: false
        type: boolean
        default: false

# Prevenir ejecuciones concurrentes por rama
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ¯ JOB 1: DETERMINAR ENTORNO BASADO EN LA RAMA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  determine-environment:
    name: ğŸ¯ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}
      
    steps:
      - name: Determine Environment from Branch
        id: env
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ DETERMINING DEPLOYMENT ENVIRONMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Si es workflow_dispatch, usar el input del usuario
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            SHOULD_DEPLOY="true"
            echo "ğŸ–±ï¸  Manual trigger detected"
            echo "ğŸŒ Selected environment: ${ENVIRONMENT}"
          
          # Si es pull_request, solo build sin deploy
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            ENVIRONMENT="dev"
            SHOULD_DEPLOY="false"
            echo "ğŸ”€ Pull Request detected"
            echo "ğŸ”¨ Will build image but NOT deploy"
          
          # Determinar por rama
          else
            BRANCH="${{ github.ref_name }}"
            echo "ğŸŒ¿ Branch: ${BRANCH}"
            
            case "${BRANCH}" in
              main|master)
                ENVIRONMENT="prod"
                SHOULD_DEPLOY="true"
                ;;
              release/*)
                ENVIRONMENT="pre"
                SHOULD_DEPLOY="true"
                ;;
              staging)
                ENVIRONMENT="staging"
                SHOULD_DEPLOY="true"
                ;;
              develop|development)
                ENVIRONMENT="dev"
                SHOULD_DEPLOY="true"
                ;;
              *)
                ENVIRONMENT="dev"
                SHOULD_DEPLOY="false"
                echo "âš ï¸  Feature branch detected - will build but not deploy"
                ;;
            esac
          fi
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "should_deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“‹ Results:"
          echo "   â€¢ Environment: ${ENVIRONMENT}"
          echo "   â€¢ Should Deploy: ${SHOULD_DEPLOY}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ³ JOB 2: BUILD & PUSH IMAGEN DOCKER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-docker-image:
    name: ğŸ³ Build Docker Image
    needs: determine-environment
    uses: ./.github/workflows/docker-build-push.yml
    with:
      docker_image: "mi-aplicacion"  # ğŸ‘ˆ Cambiar por tu nombre de imagen
      dockerhub_username: "tu-usuario"  # ğŸ‘ˆ Cambiar por tu usuario de Docker Hub
      environment: ${{ needs.determine-environment.outputs.environment }}
      dockerfile_path: "./Dockerfile"
      build_context: "."
      # Opcional: si necesitas clonar un repo externo
      # external_repo: "usuario/repo-externo"
      # external_repo_ref: "main"
      # external_repo_path: "./external"
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      # EXTERNAL_REPO_TOKEN: ${{ secrets.EXTERNAL_REPO_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 3: MOSTRAR INFORMACIÃ“N DEL BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  show-build-info:
    name: ğŸ“Š Build Information
    needs: 
      - determine-environment
      - build-docker-image
    runs-on: ubuntu-latest
    steps:
      - name: Display Build Results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š BUILD COMPLETED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸ¯ Primary Tag: ${{ needs.build-docker-image.outputs.image_tag }}"
          echo "ğŸ“¦ Full Image: ${{ needs.build-docker-image.outputs.full_image }}"
          echo "ğŸ“ Short SHA: ${{ needs.build-docker-image.outputs.short_sha }}"
          echo "ğŸ“‹ All Tags: ${{ needs.build-docker-image.outputs.all_tags }}"
          echo ""
          echo "ğŸš€ Next Step:"
          if [ "${{ needs.determine-environment.outputs.should_deploy }}" == "true" ]; then
            echo "   âœ… Will proceed to deployment"
          else
            echo "   â¸ï¸  Deployment skipped (PR or feature branch)"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 4: DESPLIEGUE GITOPS (DEV & STAGING - AUTOMÃTICO)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-auto:
    name: ğŸš€ Deploy to ${{ needs.determine-environment.outputs.environment }}
    needs: 
      - determine-environment
      - build-docker-image
    if: |
      needs.determine-environment.outputs.should_deploy == 'true' && 
      (needs.determine-environment.outputs.environment == 'dev' || 
       needs.determine-environment.outputs.environment == 'staging')
    uses: ./.github/workflows/deployment-gitops.yml
    with:
      environment: ${{ needs.determine-environment.outputs.environment }}
      image_tag: ${{ needs.build-docker-image.outputs.image_tag }}  # ğŸ¯ Usar el output del build
      dockerhub_username: "tu-usuario"  # ğŸ‘ˆ Debe coincidir con el de build
      docker_image: "mi-aplicacion"      # ğŸ‘ˆ Debe coincidir con el de build
      manifests_path: "k8s"              # ğŸ‘ˆ Ruta a tus manifiestos
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps]"
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 5: DESPLIEGUE GITOPS (PRE & PROD - MANUAL)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-manual:
    name: ğŸ” Deploy to ${{ needs.determine-environment.outputs.environment }} (Requires Approval)
    needs: 
      - determine-environment
      - build-docker-image
    if: |
      needs.determine-environment.outputs.should_deploy == 'true' && 
      (needs.determine-environment.outputs.environment == 'pre' || 
       needs.determine-environment.outputs.environment == 'prod')
    uses: ./.github/workflows/deployment-gitops.yml
    with:
      environment: ${{ needs.determine-environment.outputs.environment }}
      image_tag: ${{ needs.build-docker-image.outputs.image_tag }}  # ğŸ¯ Usar el output del build
      dockerhub_username: "tu-usuario"
      docker_image: "mi-aplicacion"
      manifests_path: "k8s"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps]"
      requires_approval: true
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 6: RESUMEN FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ğŸ“Š Pipeline Summary
    needs:
      - determine-environment
      - build-docker-image
      - show-build-info
      - deploy-auto
      - deploy-manual
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Pipeline Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CI/CD PIPELINE SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— Event: ${{ github.event_name }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ğŸš€ Should Deploy: ${{ needs.determine-environment.outputs.should_deploy }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ³ Docker Image Built:"
          echo "   â€¢ Tag: ${{ needs.build-docker-image.outputs.image_tag }}"
          echo "   â€¢ Full: ${{ needs.build-docker-image.outputs.full_image }}"
          echo "   â€¢ SHA: ${{ needs.build-docker-image.outputs.short_sha }}"
          echo ""
          echo "ğŸ“‹ Job Results:"
          echo "   â€¢ Determine Environment: ${{ needs.determine-environment.result }}"
          echo "   â€¢ Build Docker Image: ${{ needs.build-docker-image.result }}"
          echo "   â€¢ Show Build Info: ${{ needs.show-build-info.result }}"
          echo "   â€¢ Deploy Auto: ${{ needs.deploy-auto.result || 'skipped' }}"
          echo "   â€¢ Deploy Manual: ${{ needs.deploy-manual.result || 'skipped' }}"
          echo ""
          
          if [ "${{ needs.determine-environment.outputs.should_deploy }}" == "true" ]; then
            echo "âœ… Deployment completed to: ${{ needs.determine-environment.outputs.environment }}"
            echo ""
            echo "ğŸ”„ Next Steps:"
            echo "   1. Check ArgoCD for sync status"
            echo "   2. Monitor application health"
            echo "   3. Verify deployment in target environment"
            echo ""
            echo "ğŸ“¦ Deployed Image:"
            echo "   ${{ needs.build-docker-image.outputs.full_image }}"
          else
            echo "â„¹ï¸  Image built but not deployed (PR or feature branch)"
            echo ""
            echo "ğŸ“¦ Built Image (not deployed):"
            echo "   ${{ needs.build-docker-image.outputs.full_image }}"
          fi
          
          echo ""
          echo "ğŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ³ Docker Hub:"
          echo "   https://hub.docker.com/r/tu-usuario/mi-aplicacion/tags?name=${{ needs.build-docker-image.outputs.image_tag }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check for Failures
        if: |
          needs.build-docker-image.result == 'failure' ||
          needs.deploy-auto.result == 'failure' ||
          needs.deploy-manual.result == 'failure'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ PIPELINE FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  One or more jobs failed. Please check the logs above."
          echo ""
          echo "ğŸ” Failed Jobs:"
          [ "${{ needs.build-docker-image.result }}" == "failure" ] && echo "   â€¢ Build Docker Image"
          [ "${{ needs.deploy-auto.result }}" == "failure" ] && echo "   â€¢ Deploy Auto"
          [ "${{ needs.deploy-manual.result }}" == "failure" ] && echo "   â€¢ Deploy Manual"
          echo ""
          echo "ğŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1