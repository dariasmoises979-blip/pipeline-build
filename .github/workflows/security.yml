########################################
# üõ°Ô∏è WORKFLOW REUSABLE: Security & Performance Analysis
# Escanea im√°genes DIRECTAMENTE desde DockerHub
# Analiza seguridad, vulnerabilidades, c√≥digo y rendimiento
########################################

name: DockerHub Security & Performance Analysis

on:
  workflow_call:
    inputs:
      artifact_name:  
        description: 'Nombre √∫nico para el artifact de seguridad'
        required: false
        type: string
        default: ''
      image_name:
        description: "Nombre completo de la imagen en DockerHub (ej: usuario/imagen)"
        required: true
        type: string
      image_tag:
        description: "Tag de la imagen a analizar"
        required: true
        type: string
      dockerhub_username:
        description: "Usuario de DockerHub"
        required: true
        type: string
      enable_code_analysis:
        description: "Habilitar an√°lisis de c√≥digo fuente con CodeQL"
        required: false
        type: boolean
        default: false
      enable_sonar:
        description: "Habilitar an√°lisis de SonarCloud"
        required: false
        type: boolean
        default: false
      source_repo:
        description: "Repositorio con el c√≥digo fuente (para an√°lisis CodeQL)"
        required: false
        type: string
        default: ""
      source_ref:
        description: "Branch/ref del c√≥digo fuente"
        required: false
        type: string
        default: "main"
    secrets:
      DOCKERHUB_TOKEN:
        required: true
        description: "Token de DockerHub (opcional, para im√°genes privadas)"
      SONAR_TOKEN:
        required: false

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üîç JOB 1: AN√ÅLISIS DE C√ìDIGO EST√ÅTICO (OPCIONAL)
  # Solo se ejecuta si enable_code_analysis=true
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  code-analysis:
    name: üß† An√°lisis de C√≥digo Est√°tico (CodeQL)
    runs-on: ubuntu-latest
    if: inputs.enable_code_analysis == true && inputs.source_repo != ''

    steps:
      - name: üì¶ Checkout del c√≥digo fuente
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.source_repo }}
          ref: ${{ inputs.source_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üß† Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'javascript,python,java,go'

      - name: ‚öôÔ∏è Autobuild del proyecto
        uses: github/codeql-action/autobuild@v3

      - name: üîç Ejecutar an√°lisis CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:multi"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üê≥ JOB 2: PULL DE IMAGEN DESDE DOCKERHUB
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  pull-image:
    name: üì• Descargar Imagen desde DockerHub
    runs-on: ubuntu-latest
    outputs:
      image_full: ${{ steps.pull.outputs.image_full }}
      image_size: ${{ steps.inspect.outputs.size }}
      image_digest: ${{ steps.inspect.outputs.digest }}

    steps:
      - name: üîê Login en DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: üì• Pull de imagen desde DockerHub
        id: pull
        run: |
          IMAGE_FULL="${{ inputs.image_name }}:${{ inputs.image_tag }}"
          echo "üîΩ Descargando imagen: $IMAGE_FULL"
          docker pull $IMAGE_FULL
          echo "image_full=$IMAGE_FULL" >> $GITHUB_OUTPUT
          
          echo "### üì• Imagen Descargada" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY

      - name: üîç Inspeccionar imagen
        id: inspect
        run: |
          IMAGE_FULL="${{ inputs.image_name }}:${{ inputs.image_tag }}"
          
          # Obtener tama√±o
          SIZE=$(docker images $IMAGE_FULL --format "{{.Size}}")
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          
          # Obtener digest
          DIGEST=$(docker inspect $IMAGE_FULL --format='{{index .RepoDigests 0}}')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          
          echo "- **Tama√±o**: $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`$DIGEST\`" >> $GITHUB_STEP_SUMMARY

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üîê JOB 3: AN√ÅLISIS DE SEGURIDAD MULTI-HERRAMIENTA
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  security-scan:
    name: üîê Escaneo de Seguridad Multi-Herramienta
    needs: pull-image
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout para contexto
        uses: actions/checkout@v4

      - name: üîç Debug - Verificar inputs
        run: |
          echo "### üîç Debug - Par√°metros Recibidos" >> $GITHUB_STEP_SUMMARY
          echo "- **image_name**: ${{ inputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **image_tag**: ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **dockerhub_username**: ${{ inputs.dockerhub_username }}" >> $GITHUB_STEP_SUMMARY
          echo "- **image_full**: ${{ needs.pull-image.outputs.image_full }}" >> $GITHUB_STEP_SUMMARY

      - name: üîê Login en DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üì• Pull de imagen
        run: |
          docker pull ${{ needs.pull-image.outputs.image_full }}

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # TRIVY - An√°lisis de Vulnerabilidades
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üîé Trivy - Escaneo SARIF (GitHub Security)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.pull-image.outputs.image_full }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          vuln-type: 'os,library'

      - name: üì§ Subir Trivy a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      - name: üìä Trivy - Reporte en tabla
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.pull-image.outputs.image_full }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: üìã Trivy - Reporte JSON completo
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.pull-image.outputs.image_full }}
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # GRYPE - An√°lisis de Vulnerabilidades Alternativo
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üß¨ Grype - Escaneo de vulnerabilidades
        uses: anchore/scan-action@v4
        id: grype
        with:
          image: ${{ needs.pull-image.outputs.image_full }}
          fail-build: false
          severity-cutoff: medium
          output-format: sarif

      - name: üì§ Subir Grype a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
          category: 'grype'

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # SNYK - An√°lisis de Seguridad (Opcional)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üêç Snyk - Escaneo de seguridad
        continue-on-error: true
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ needs.pull-image.outputs.image_full }}
          args: --severity-threshold=high --file=Dockerfile

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # DOCKLE - Best Practices de Docker (VERSI√ìN CORREGIDA)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üêã Dockle - Docker Best Practices
        continue-on-error: true  # No fallar el workflow si Dockle falla
        run: |
          echo "### üêã Dockle - Docker Best Practices" >> $GITHUB_STEP_SUMMARY
          
          # Intentar obtener la √∫ltima versi√≥n
          VERSION=$(curl --silent --fail "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | \
            grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/' || echo "0.4.14")
          
          if [ -z "$VERSION" ] || [ "$VERSION" = "0.4.14" ]; then
            echo "‚ö†Ô∏è No se pudo obtener la √∫ltima versi√≥n, usando v0.4.14" >> $GITHUB_STEP_SUMMARY
            VERSION="0.4.14"
          fi
          
          echo "üì¶ Descargando Dockle v${VERSION}..." >> $GITHUB_STEP_SUMMARY
          
          # Descargar Dockle
          DOCKLE_URL="https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.deb"
          
          if curl -fL -o dockle.deb "$DOCKLE_URL"; then
            echo "‚úÖ Descarga exitosa" >> $GITHUB_STEP_SUMMARY
            
            # Instalar
            if sudo dpkg -i dockle.deb 2>/dev/null; then
              echo "‚úÖ Instalaci√≥n exitosa" >> $GITHUB_STEP_SUMMARY
              
              # Ejecutar escaneo
              echo '```' >> $GITHUB_STEP_SUMMARY
              dockle --exit-code 0 --exit-level warn ${{ needs.pull-image.outputs.image_full }} | tee dockle-report.txt || true
              cat dockle-report.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå Error en la instalaci√≥n de Dockle" >> $GITHUB_STEP_SUMMARY
              echo "Dockle scan omitido" > dockle-report.txt
            fi
          else
            echo "‚ùå Error al descargar Dockle desde $DOCKLE_URL" >> $GITHUB_STEP_SUMMARY
            echo "Dockle scan omitido" > dockle-report.txt
          fi

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Generar resumen de vulnerabilidades
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üìä Generar resumen de vulnerabilidades
        run: |
          echo "## üîê Resumen de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Contar vulnerabilidades por severidad en Trivy
          if [ -f trivy-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-report.json)
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-report.json)
            
            echo "### üìà Trivy - Vulnerabilidades Detectadas" >> $GITHUB_STEP_SUMMARY
            echo "| Severidad | Cantidad |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| üîµ LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Determine artifact name
        id: artifact
        run: |
            if [ -n "${{ inputs.artifact_name }}" ]; then
              ARTIFACT_NAME="${{ inputs.artifact_name }}"
            else
              ARTIFACT_NAME="security-reports-${{ inputs.image_tag }}-${{ github.run_id }}"
            fi
            echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
            name: ${{ steps.artifact.outputs.artifact_name }}  # üÜï CAMBIAR ESTO
            path: |
              trivy-results.sarif
              trivy-report-${{ inputs.image_tag }}.json
              dockle-report-${{ inputs.image_tag }}.json
              dockle-report-${{ inputs.image_tag }}.txt
            retention-days: 30

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ‚öôÔ∏è JOB 4: AN√ÅLISIS DE RENDIMIENTO Y OPTIMIZACI√ìN
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  performance-analysis:
    name: ‚ö° An√°lisis de Rendimiento
    needs: pull-image
    runs-on: ubuntu-latest

    steps:
      - name: üîê Login en DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: üì• Pull de imagen
        run: |
          docker pull ${{ needs.pull-image.outputs.image_full }}

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # An√°lisis de capas y tama√±o
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üìä Analizar estructura de capas
        run: |
          echo "## üìä An√°lisis de Imagen" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Informaci√≥n General" >> $GITHUB_STEP_SUMMARY
          echo "- **Tama√±o**: ${{ needs.pull-image.outputs.image_size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üóÇÔ∏è Capas de la Imagen" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker history ${{ needs.pull-image.outputs.image_full }} --human --no-trunc | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # DIVE - An√°lisis de eficiencia
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üß† Dive - An√°lisis de eficiencia de capas
        run: |
          wget https://github.com/wagoodman/dive/releases/download/v0.12.0/dive_0.12.0_linux_amd64.deb
          sudo apt install ./dive_0.12.0_linux_amd64.deb
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Dive - Eficiencia de Imagen" >> $GITHUB_STEP_SUMMARY
          CI=true dive ${{ needs.pull-image.outputs.image_full }} 2>&1 | tee dive-report.txt
          
          # Extraer m√©tricas clave
          EFFICIENCY=$(grep -oP 'Image efficiency score: \K[0-9]+' dive-report.txt || echo "N/A")
          WASTED=$(grep -oP 'Total Image size: .* \(waste: \K[^\)]+' dive-report.txt || echo "N/A")
          
          echo "- **Eficiencia**: ${EFFICIENCY}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Espacio desperdiciado**: ${WASTED}" >> $GITHUB_STEP_SUMMARY

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Container Structure Test
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üß™ Container Structure Test
        run: |
          curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64
          chmod +x container-structure-test-linux-amd64
          sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
          
          # Crear configuraci√≥n de pruebas
          cat > container-test.yaml << 'EOF'
          schemaVersion: 2.0.0
          
          # Pruebas de existencia de archivos
          fileExistenceTests:
            - name: 'Root Directory'
              path: '/'
              shouldExist: true
            - name: 'Check /tmp exists'
              path: '/tmp'
              shouldExist: true
          
          # Pruebas de contenido de archivos
          fileContentTests:
            - name: 'Check /etc/os-release exists'
              path: '/etc/os-release'
              expectedContents: ['.*']
          
          # Metadata tests
          metadataTest:
            env: []
          EOF
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üß™ Container Structure Tests" >> $GITHUB_STEP_SUMMARY
          container-structure-test test --image ${{ needs.pull-image.outputs.image_full }} --config container-test.yaml 2>&1 | tee structure-test.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat structure-test.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: üì§ Subir reportes de rendimiento
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
            name: performance-reports-${{ inputs.image_tag }}
            path: |
              dive-report.txt
              structure-test.txt
            retention-days: 30
            if-no-files-found: warn

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üöÄ JOB 5: PRUEBAS DE RENDIMIENTO EN RUNTIME
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  runtime-performance:
    name: üöÄ Pruebas de Runtime
    needs: pull-image
    runs-on: ubuntu-latest

    steps:
      - name: üîê Login en DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: üì• Pull de imagen
        run: |
          docker pull ${{ needs.pull-image.outputs.image_full }}

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Medir tiempo de inicio
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: ‚è±Ô∏è Medir tiempo de inicio del contenedor
        id: startup
        run: |
          echo "## üöÄ An√°lisis de Runtime" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # M√∫ltiples mediciones para precisi√≥n
          TOTAL=0
          RUNS=3
          
          echo "### ‚è±Ô∏è Tiempo de Inicio (promedio de $RUNS ejecuciones)" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 $RUNS); do
            START=$(date +%s%N)
            CONTAINER_ID=$(docker run -d ${{ needs.pull-image.outputs.image_full }} sleep 5)
            
            # Esperar a que el contenedor est√© corriendo
            timeout 30 sh -c "until docker ps | grep -q $CONTAINER_ID; do sleep 0.1; done" || true
            
            END=$(date +%s%N)
            DURATION=$(( (END - START) / 1000000 ))
            TOTAL=$((TOTAL + DURATION))
            
            echo "- Run $i: ${DURATION}ms" >> $GITHUB_STEP_SUMMARY
            
            docker stop $CONTAINER_ID >/dev/null 2>&1
            docker rm $CONTAINER_ID >/dev/null 2>&1
          done
          
          AVG=$((TOTAL / RUNS))
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Promedio: ${AVG}ms**" >> $GITHUB_STEP_SUMMARY
          echo "startup_time_avg=${AVG}ms" >> $GITHUB_OUTPUT

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # An√°lisis de uso de recursos
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üíª An√°lisis de consumo de recursos
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üíª Uso de Recursos" >> $GITHUB_STEP_SUMMARY
          
          # Iniciar contenedor con carga
          CONTAINER_ID=$(docker run -d ${{ needs.pull-image.outputs.image_full }} sleep 300)
          
          # Esperar estabilizaci√≥n
          sleep 10
          
          # Capturar estad√≠sticas m√∫ltiples veces
          echo "| M√©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          
          for i in {1..5}; do
            STATS=$(docker stats --no-stream --format "{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" $CONTAINER_ID)
            CPU=$(echo $STATS | awk '{print $1}')
            MEM=$(echo $STATS | awk '{print $2}')
            
            if [ $i -eq 1 ]; then
              echo "| CPU | $CPU |" >> $GITHUB_STEP_SUMMARY
              echo "| Memoria | $MEM |" >> $GITHUB_STEP_SUMMARY
            fi
            
            sleep 2
          done
          
          # M√©tricas finales
          FINAL_STATS=$(docker stats --no-stream --format "{{.CPUPerc}}\t{{.MemUsage}}\t{{.PIDs}}" $CONTAINER_ID)
          PIDS=$(echo $FINAL_STATS | awk '{print $3}')
          echo "| Procesos | $PIDS |" >> $GITHUB_STEP_SUMMARY
          
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Health check test
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üè• Prueba de health check
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üè• Health Check" >> $GITHUB_STEP_SUMMARY
          
          CONTAINER_ID=$(docker run -d ${{ needs.pull-image.outputs.image_full }})
          sleep 5
          
          HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_ID 2>/dev/null || echo "no-healthcheck")
          
          if [ "$HEALTH" = "no-healthcheck" ]; then
            echo "‚ö†Ô∏è **Advertencia**: La imagen no tiene health check configurado" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Health check status: $HEALTH" >> $GITHUB_STEP_SUMMARY
          fi
          
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üìã JOB 6: GENERACI√ìN DE REPORTE FINAL Y RECOMENDACIONES
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  generate-report:
    name: üìã Generar Reporte Final
    needs: [pull-image, security-scan, performance-analysis, runtime-performance]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: üì• Descargar artefactos de seguridad
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: security-reports-${{ inputs.image_tag }}
          path: ./reports/security

      - name: üì• Descargar artefactos de rendimiento
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: performance-reports-${{ inputs.image_tag }}
          path: ./reports/performance

      - name: üìä Generar reporte consolidado
        run: |
          mkdir -p ./reports/security ./reports/performance
          
          cat > SECURITY_REPORT.md << 'EOF'
          # üîê Reporte de Seguridad y Rendimiento
          
          ## üìã Informaci√≥n de la Imagen
          - **Imagen**: `${{ needs.pull-image.outputs.image_full }}`
          - **Tama√±o**: ${{ needs.pull-image.outputs.image_size }}
          - **Digest**: `${{ needs.pull-image.outputs.image_digest }}`
          - **Fecha de an√°lisis**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          
          ## üõ°Ô∏è AN√ÅLISIS DE SEGURIDAD
          
          ### üîç Herramientas Utilizadas
          - ‚úÖ **Trivy**: Escaneo de vulnerabilidades en OS y librer√≠as
          - ‚úÖ **Grype**: An√°lisis complementario de vulnerabilidades
          - ‚úÖ **Dockle**: Verificaci√≥n de best practices de Docker
          
          ### üìä Resultados de Trivy
          EOF
          
          if [ -f ./reports/security/trivy-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' ./reports/security/trivy-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' ./reports/security/trivy-report.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' ./reports/security/trivy-report.json)
            
            cat >> SECURITY_REPORT.md << EOF
          
          | Severidad | Cantidad | Estado |
          |-----------|----------|--------|
          | üî¥ CRITICAL | $CRITICAL | $([ $CRITICAL -eq 0 ] && echo "‚úÖ OK" || echo "‚ùå ACCI√ìN REQUERIDA") |
          | üü† HIGH | $HIGH | $([ $HIGH -eq 0 ] && echo "‚úÖ OK" || echo "‚ö†Ô∏è REVISAR") |
          | üü° MEDIUM | $MEDIUM | $([ $MEDIUM -le 5 ] && echo "‚úÖ Aceptable" || echo "‚ö†Ô∏è Mejorable") |
          EOF
          else
            cat >> SECURITY_REPORT.md << 'EOF'
          
          ‚ö†Ô∏è **Reporte de Trivy no disponible**
          
          El escaneo de seguridad no se complet√≥ correctamente. Posibles causas:
          - Error en el pull de la imagen
          - Fallo en la autenticaci√≥n con DockerHub
          - Timeout del escaneo
          
          **Acci√≥n requerida**: Revisar los logs del job `security-scan` para m√°s detalles.
          EOF
          fi
          
          cat >> SECURITY_REPORT.md << 'EOF'
          
          ---
          
          ## ‚ö° AN√ÅLISIS DE RENDIMIENTO
          
          ### üì¶ Eficiencia de Imagen
          - Ver reporte detallado de **Dive** en los artefactos adjuntos
          
          ### üöÄ Rendimiento en Runtime
          - Ver m√©tricas de inicio y uso de recursos en el job summary
          
          ---
          
          ## ‚úÖ RECOMENDACIONES PRIORITARIAS
          
          ### üî¥ Cr√≠ticas (Implementar Inmediatamente)
          - [ ] **Corregir vulnerabilidades CRITICAL**: Actualizar todas las dependencias con vulnerabilidades cr√≠ticas
          - [ ] **Implementar usuario no-root**: Nunca ejecutar contenedores como root
          - [ ] **Agregar health check**: Implementar endpoint de salud para monitoreo
          
          ### üü† Importantes (Implementar Esta Semana)
          - [ ] **Reducir tama√±o de imagen**: Objetivo < 500MB para im√°genes de aplicaci√≥n
          - [ ] **Multi-stage builds**: Separar build de runtime
          - [ ] **Usar imagen base segura**: Alpine Linux o Distroless
          - [ ] **Agregar .dockerignore**: Evitar archivos innecesarios en la imagen
          
          ### üü° Mejoras (Implementar Este Mes)
          - [ ] **Optimizar capas**: Combinar comandos RUN relacionados
          - [ ] **Limpiar cache**: Eliminar caches de apt/apk tras instalaci√≥n
          - [ ] **Configurar l√≠mites de recursos**: CPU y memoria en production
          - [ ] **Implementar escaneo autom√°tico**: Integrar en CI/CD
          - [ ] **Usar tags inmutables**: Evitar `latest` en producci√≥n
          - [ ] **Firmar im√°genes**: Implementar Docker Content Trust
          
          ---
          
          ## üìö RECURSOS Y SIGUIENTES PASOS
          
          ### üîó Enlaces √ötiles
          - [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
          - [OWASP Docker Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html)
          - [CIS Docker Benchmark](https://www.cisecurity.org/benchmark/docker)
          
          ### üìä Acciones Recomendadas
          1. Revisar todos los reportes en la secci√≥n **Artifacts**
          2. Priorizar correcci√≥n de vulnerabilidades CRITICAL y HIGH
          3. Implementar las recomendaciones cr√≠ticas en el pr√≥ximo sprint
          4. Configurar escaneo autom√°tico en cada push
          5. Establecer pol√≠tica de actualizaci√≥n de im√°genes base
          
          ---
          
          ## üîÑ Pr√≥ximo Escaneo
          Se recomienda escanear la imagen:
          - ‚úÖ Despu√©s de cada actualizaci√≥n de dependencias
          - ‚úÖ Semanalmente para im√°genes en producci√≥n
          - ‚úÖ Mensualmente para im√°genes en desarrollo
          
          ---
          
          **Generado autom√°ticamente por GitHub Actions** | [Ver workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          
          cat SECURITY_REPORT.md >> $GITHUB_STEP_SUMMARY

      - name: üì§ Subir reporte final
        uses: actions/upload-artifact@v4
        if: always()
        with:
            name: final-security-report-${{ inputs.image_tag }}
            path: SECURITY_REPORT.md
            retention-days: 90
            if-no-files-found: error

      - name: üí¨ Comentar en Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('SECURITY_REPORT.md', 'utf8');
            
            const collapsedReport = `
            ## üîê Reporte de Seguridad y Rendimiento
            
            <details>
            <summary>üìä Ver reporte completo</summary>
            
            ${report}
            
            </details>
            
            ### üéØ Acciones R√°pidas
            - üì• Descarga los reportes detallados en la secci√≥n **Artifacts**
            - üîç Revisa las vulnerabilidades en la pesta√±a **Security**
            - ‚ö° Implementa las recomendaciones cr√≠ticas prioritarias
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: collapsedReport
            });

      - name: üö® Crear issue si hay vulnerabilidades cr√≠ticas
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let hasCritical = false;
            let criticalCount = 0;
            let highCount = 0;
            
            try {
              if (!fs.existsSync('./reports/security/trivy-report.json')) {
                console.log('‚ö†Ô∏è Reporte de Trivy no encontrado - posiblemente el escaneo fall√≥');
                
                const issueTitle = `‚ö†Ô∏è Fallo en el escaneo de seguridad para ${{ needs.pull-image.outputs.image_full }}`;
                const issueBody = `
                ## ‚ö†Ô∏è Error en el Pipeline de Seguridad
                
                El escaneo de seguridad no se complet√≥ correctamente para:
                
                **Imagen**: \`${{ needs.pull-image.outputs.image_full }}\`
                **Fecha**: ${new Date().toISOString().split('T')[0]}
                **Workflow**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
                
                ### üîç Posibles Causas
                
                1. Error en el login de DockerHub
                2. La imagen no existe en DockerHub
                3. Timeout del escaneo
                4. Problemas de red
                
                ### ‚úÖ Acciones Requeridas
                
                1. Revisar los logs del workflow
                2. Verificar credenciales de DockerHub
                3. Confirmar que la imagen existe: \`docker pull ${{ needs.pull-image.outputs.image_full }}\`
                4. Re-ejecutar el workflow manualmente
                
                ---
                
                Este issue se cerrar√° autom√°ticamente cuando el escaneo se complete exitosamente.
                `;
                
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['security', 'pipeline-failure', 'automated']
                });
                
                return;
              }
              
              const trivyReport = JSON.parse(fs.readFileSync('./reports/security/trivy-report.json', 'utf8'));
              
              for (const result of trivyReport.Results || []) {
                for (const vuln of result.Vulnerabilities || []) {
                  if (vuln.Severity === 'CRITICAL') {
                    criticalCount++;
                    hasCritical = true;
                  } else if (vuln.Severity === 'HIGH') {
                    highCount++;
                  }
                }
              }
            } catch (error) {
              console.log('No se pudo leer el reporte de Trivy');
              return;
            }
            
            if (hasCritical) {
              const issueTitle = `üö® Vulnerabilidades cr√≠ticas detectadas en ${{ needs.pull-image.outputs.image_full }}`;
              const issueBody = `
              ## üîê Alerta de Seguridad
              
              Se han detectado **${criticalCount} vulnerabilidades CRITICAL** y **${highCount} vulnerabilidades HIGH** en la imagen:
              
              **Imagen**: \`${{ needs.pull-image.outputs.image_full }}\`
              **Fecha**: ${new Date().toISOString().split('T')[0]}
              **Workflow**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ### üéØ Acciones Requeridas
              
              1. ‚úÖ Revisar el [reporte completo en Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              2. ‚úÖ Actualizar dependencias vulnerables
              3. ‚úÖ Re-construir y re-escanear la imagen
              4. ‚úÖ Verificar que las vulnerabilidades se resolvieron
              
              ### üìä Resumen
              - üî¥ **CRITICAL**: ${criticalCount}
              - üü† **HIGH**: ${highCount}
              
              ### üîó Enlaces √ötiles
              - [Reporte de Seguridad](https://github.com/${{ github.repository }}/security)
              - [Documentaci√≥n de Remediaci√≥n](https://github.com/${{ github.repository }}/wiki)
              
              ---
              
              ‚ö†Ô∏è **Este issue se cierra autom√°ticamente cuando se resuelvan las vulnerabilidades**
              `;
              
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'security,critical'
              });
              
              const similarIssue = existingIssues.data.find(issue => 
                issue.title.includes('Vulnerabilidades cr√≠ticas') && 
                issue.title.includes('${{ inputs.image_tag }}')
              );
              
              if (!similarIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['security', 'critical', 'automated']
                });
                
                console.log('‚úÖ Issue de seguridad creado');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: similarIssue.number,
                  body: `üîÑ **Actualizaci√≥n**: El escaneo sigue detectando ${criticalCount} vulnerabilidades CRITICAL.\n\nWorkflow: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
                });
                
                console.log('‚úÖ Issue de seguridad actualizado');
              }
            }

      - name: ‚úÖ Verificar estado final
        run: |
          echo "## ‚úÖ Estado Final del An√°lisis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîê Escaneo de seguridad | ‚úÖ Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ö° An√°lisis de rendimiento | ‚úÖ Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ Pruebas de runtime | ‚úÖ Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| üìã Reporte generado | ‚úÖ Completado |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Todos los reportes est√°n disponibles en Artifacts**" >> $GITHUB_STEP_SUMMARY