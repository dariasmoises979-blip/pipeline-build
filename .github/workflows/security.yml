########################################
# ğŸ›¡ï¸ WORKFLOW REUSABLE: Security & Performance Analysis
# Escanea imÃ¡genes DIRECTAMENTE desde DockerHub
# Analiza seguridad, vulnerabilidades, cÃ³digo y rendimiento
########################################

name: DockerHub Security & Performance Analysis

on:
  workflow_call:
    inputs:
      image_name:
        description: "Nombre completo de la imagen en DockerHub (ej: usuario/imagen)"
        required: true
        type: string
      image_tag:
        description: "Tag de la imagen a analizar"
        required: true
        type: string
      enable_code_analysis:
        description: "Habilitar anÃ¡lisis de cÃ³digo fuente con CodeQL"
        required: false
        type: boolean
        default: false
      enable_sonar:
        description: "Habilitar anÃ¡lisis de SonarCloud"
        required: false
        type: boolean
        default: false
      source_repo:
        description: "Repositorio con el cÃ³digo fuente (para anÃ¡lisis CodeQL)"
        required: false
        type: string
        default: ""
      source_ref:
        description: "Branch/ref del cÃ³digo fuente"
        required: false
        type: string
        default: "main"
    secrets:
      DOCKERHUB_TOKEN:
        required: true
        description: "Token de DockerHub (opcional, para imÃ¡genes privadas)"
      SONAR_TOKEN:
        required: false
      GITHUB_TOKEN:
        required: false

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 1: ANÃLISIS DE CÃ“DIGO ESTÃTICO (OPCIONAL)
  # Solo se ejecuta si enable_code_analysis=true
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-analysis:
    name: ğŸ§  AnÃ¡lisis de CÃ³digo EstÃ¡tico (CodeQL)
    runs-on: ubuntu-latest
    if: inputs.enable_code_analysis == true && inputs.source_repo != ''

    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo fuente
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.source_repo }}
          ref: ${{ inputs.source_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§  Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'javascript,python,java,go'

      - name: âš™ï¸ Autobuild del proyecto
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Ejecutar anÃ¡lisis CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:multi"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ³ JOB 2: PULL DE IMAGEN DESDE DOCKERHUB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pull-image:
    name: ğŸ“¥ Descargar Imagen desde DockerHub
    runs-on: ubuntu-latest
    outputs:
      image_full: ${{ steps.pull.outputs.image_full }}
      image_size: ${{ steps.inspect.outputs.size }}
      image_digest: ${{ steps.inspect.outputs.digest }}

    steps:
      - name: ğŸ” Login en DockerHub (si hay token)
        uses: docker/login-action@v3
        with:
            username: ${{ inputs.dockerhub_username }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
            logout: true
         

      - name: ğŸ“¥ Pull de imagen desde DockerHub
        id: pull
        run: |
          IMAGE_FULL="${{ inputs.image_name }}:${{ inputs.image_tag }}"
          echo "ğŸ”½ Descargando imagen: $IMAGE_FULL"
          docker pull $IMAGE_FULL
          echo "image_full=$IMAGE_FULL" >> $GITHUB_OUTPUT
          
          echo "### ğŸ“¥ Imagen Descargada" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Inspeccionar imagen
        id: inspect
        run: |
          IMAGE_FULL="${{ inputs.image_name }}:${{ inputs.image_tag }}"
          
          # Obtener tamaÃ±o
          SIZE=$(docker images $IMAGE_FULL --format "{{.Size}}")
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          
          # Obtener digest
          DIGEST=$(docker inspect $IMAGE_FULL --format='{{index .RepoDigests 0}}')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          
          echo "- **TamaÃ±o**: $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`$DIGEST\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 3: ANÃLISIS DE SEGURIDAD MULTI-HERRAMIENTA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: ğŸ” Escaneo de Seguridad Multi-Herramienta
    needs: pull-image
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout para contexto
        uses: actions/checkout@v4

      - name: ğŸ” Login en DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“¥ Pull de imagen
        run: |
          docker pull ${{ needs.pull-image.outputs.image_full }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # TRIVY - AnÃ¡lisis de Vulnerabilidades
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Trivy - Escaneo SARIF (GitHub Security)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.pull-image.outputs.image_full }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          vuln-type: 'os,library'

      - name: ğŸ“¤ Subir Trivy a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      - name: ğŸ“Š Trivy - Reporte en tabla
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.pull-image.outputs.image_full }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: ğŸ“‹ Trivy - Reporte JSON completo
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.pull-image.outputs.image_full }}
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # GRYPE - AnÃ¡lisis de Vulnerabilidades Alternativo
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¬ Grype - Escaneo de vulnerabilidades
        uses: anchore/scan-action@v4
        id: grype
        with:
          image: ${{ needs.pull-image.outputs.image_full }}
          fail-build: false
          severity-cutoff: medium
          output-format: sarif

      - name: ğŸ“¤ Subir Grype a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
          category: 'grype'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SNYK - AnÃ¡lisis de Seguridad (Opcional)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ Snyk - Escaneo de seguridad
        continue-on-error: true
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ needs.pull-image.outputs.image_full }}
          args: --severity-threshold=high --file=Dockerfile

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DOCKLE - Best Practices de Docker
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ‹ Dockle - Docker Best Practices
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | \
            grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -L -o dockle.deb https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.deb
          sudo dpkg -i dockle.deb
          
          echo "### ğŸ‹ Dockle - Docker Best Practices" >> $GITHUB_STEP_SUMMARY
          dockle --exit-code 0 --exit-level warn ${{ needs.pull-image.outputs.image_full }} | tee dockle-report.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat dockle-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Generar resumen de vulnerabilidades
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Generar resumen de vulnerabilidades
        run: |
          echo "## ğŸ” Resumen de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Contar vulnerabilidades por severidad en Trivy
          if [ -f trivy-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-report.json)
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-report.json)
            
            echo "### ğŸ“ˆ Trivy - Vulnerabilidades Detectadas" >> $GITHUB_STEP_SUMMARY
            echo "| Severidad | Cantidad |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ”´ CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ  HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸŸ¡ MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ”µ LOW | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Subir reportes como artefactos
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-results.sarif
            trivy-report.json
            dockle-report.txt
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âš™ï¸ JOB 4: ANÃLISIS DE RENDIMIENTO Y OPTIMIZACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  performance-analysis:
    name: âš¡ AnÃ¡lisis de Rendimiento
    needs: pull-image
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Login en DockerHub
        uses: docker/login-action@v3
        with:
            username: ${{ inputs.dockerhub_username }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
            logout: true

          

      - name: ğŸ“¥ Pull de imagen
        run: |
          docker pull ${{ needs.pull-image.outputs.image_full }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # AnÃ¡lisis de capas y tamaÃ±o
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Analizar estructura de capas
        run: |
          echo "## ğŸ“Š AnÃ¡lisis de Imagen" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ InformaciÃ³n General" >> $GITHUB_STEP_SUMMARY
          echo "- **TamaÃ±o**: ${{ needs.pull-image.outputs.image_size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ—‚ï¸ Capas de la Imagen" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker history ${{ needs.pull-image.outputs.image_full }} --human --no-trunc | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DIVE - AnÃ¡lisis de eficiencia
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§  Dive - AnÃ¡lisis de eficiencia de capas
        run: |
          wget https://github.com/wagoodman/dive/releases/download/v0.12.0/dive_0.12.0_linux_amd64.deb
          sudo apt install ./dive_0.12.0_linux_amd64.deb
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” Dive - Eficiencia de Imagen" >> $GITHUB_STEP_SUMMARY
          CI=true dive ${{ needs.pull-image.outputs.image_full }} 2>&1 | tee dive-report.txt
          
          # Extraer mÃ©tricas clave
          EFFICIENCY=$(grep -oP 'Image efficiency score: \K[0-9]+' dive-report.txt || echo "N/A")
          WASTED=$(grep -oP 'Total Image size: .* \(waste: \K[^\)]+' dive-report.txt || echo "N/A")
          
          echo "- **Eficiencia**: ${EFFICIENCY}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Espacio desperdiciado**: ${WASTED}" >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Container Structure Test
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§ª Container Structure Test
        run: |
          curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64
          chmod +x container-structure-test-linux-amd64
          sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
          
          # Crear configuraciÃ³n de pruebas
          cat > container-test.yaml << 'EOF'
          schemaVersion: 2.0.0
          
          # Pruebas de existencia de archivos
          fileExistenceTests:
            - name: 'Root Directory'
              path: '/'
              shouldExist: true
            - name: 'Check /tmp exists'
              path: '/tmp'
              shouldExist: true
          
          # Pruebas de contenido de archivos
          fileContentTests:
            - name: 'Check /etc/os-release exists'
              path: '/etc/os-release'
              expectedContents: ['.*']
          
          # Metadata tests
          metadataTest:
            env: []
          EOF
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª Container Structure Tests" >> $GITHUB_STEP_SUMMARY
          container-structure-test test --image ${{ needs.pull-image.outputs.image_full }} --config container-test.yaml 2>&1 | tee structure-test.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat structure-test.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Subir reportes de rendimiento
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            dive-report.txt
            structure-test.txt
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 5: PRUEBAS DE RENDIMIENTO EN RUNTIME
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  runtime-performance:
    name: ğŸš€ Pruebas de Runtime
    needs: pull-image
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Login en DockerHub
        uses: docker/login-action@v3
        with:
            username: ${{ inputs.dockerhub_username }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
            logout: true
  

      - name: ğŸ“¥ Pull de imagen
        run: |
          docker pull ${{ needs.pull-image.outputs.image_full }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Medir tiempo de inicio
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â±ï¸ Medir tiempo de inicio del contenedor
        id: startup
        run: |
          echo "## ğŸš€ AnÃ¡lisis de Runtime" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # MÃºltiples mediciones para precisiÃ³n
          TOTAL=0
          RUNS=3
          
          echo "### â±ï¸ Tiempo de Inicio (promedio de $RUNS ejecuciones)" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 $RUNS); do
            START=$(date +%s%N)
            CONTAINER_ID=$(docker run -d ${{ needs.pull-image.outputs.image_full }} sleep 5)
            
            # Esperar a que el contenedor estÃ© corriendo
            timeout 30 sh -c "until docker ps | grep -q $CONTAINER_ID; do sleep 0.1; done" || true
            
            END=$(date +%s%N)
            DURATION=$(( (END - START) / 1000000 ))
            TOTAL=$((TOTAL + DURATION))
            
            echo "- Run $i: ${DURATION}ms" >> $GITHUB_STEP_SUMMARY
            
            docker stop $CONTAINER_ID >/dev/null 2>&1
            docker rm $CONTAINER_ID >/dev/null 2>&1
          done
          
          AVG=$((TOTAL / RUNS))
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Promedio: ${AVG}ms**" >> $GITHUB_STEP_SUMMARY
          echo "startup_time_avg=${AVG}ms" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # AnÃ¡lisis de uso de recursos
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’» AnÃ¡lisis de consumo de recursos
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’» Uso de Recursos" >> $GITHUB_STEP_SUMMARY
          
          # Iniciar contenedor con carga
          CONTAINER_ID=$(docker run -d ${{ needs.pull-image.outputs.image_full }} sleep 300)
          
          # Esperar estabilizaciÃ³n
          sleep 10
          
          # Capturar estadÃ­sticas mÃºltiples veces
          echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          
          for i in {1..5}; do
            STATS=$(docker stats --no-stream --format "{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" $CONTAINER_ID)
            CPU=$(echo $STATS | awk '{print $1}')
            MEM=$(echo $STATS | awk '{print $2}')
            
            if [ $i -eq 1 ]; then
              echo "| CPU | $CPU |" >> $GITHUB_STEP_SUMMARY
              echo "| Memoria | $MEM |" >> $GITHUB_STEP_SUMMARY
            fi
            
            sleep 2
          done
          
          # MÃ©tricas finales
          FINAL_STATS=$(docker stats --no-stream --format "{{.CPUPerc}}\t{{.MemUsage}}\t{{.PIDs}}" $CONTAINER_ID)
          PIDS=$(echo $FINAL_STATS | awk '{print $3}')
          echo "| Procesos | $PIDS |" >> $GITHUB_STEP_SUMMARY
          
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Health check test
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ¥ Prueba de health check
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¥ Health Check" >> $GITHUB_STEP_SUMMARY
          
          CONTAINER_ID=$(docker run -d ${{ needs.pull-image.outputs.image_full }})
          sleep 5
          
          HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_ID 2>/dev/null || echo "no-healthcheck")
          
          if [ "$HEALTH" = "no-healthcheck" ]; then
            echo "âš ï¸ **Advertencia**: La imagen no tiene health check configurado" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Health check status: $HEALTH" >> $GITHUB_STEP_SUMMARY
          fi
          
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 6: GENERACIÃ“N DE REPORTE FINAL Y RECOMENDACIONES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-report:
    name: ğŸ“‹ Generar Reporte Final
    needs: [pull-image, security-scan, performance-analysis, runtime-performance]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar artefactos de seguridad
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ./reports/security

      - name: ğŸ“¥ Descargar artefactos de rendimiento
        uses: actions/download-artifact@v4
        with:
          name: performance-reports
          path: ./reports/performance

      - name: ğŸ“Š Generar reporte consolidado
        run: |
          cat > SECURITY_REPORT.md << 'EOF'
          # ğŸ” Reporte de Seguridad y Rendimiento
          
          ## ğŸ“‹ InformaciÃ³n de la Imagen
          - **Imagen**: `${{ needs.pull-image.outputs.image_full }}`
          - **TamaÃ±o**: ${{ needs.pull-image.outputs.image_size }}
          - **Digest**: `${{ needs.pull-image.outputs.image_digest }}`
          - **Fecha de anÃ¡lisis**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          
          ## ğŸ›¡ï¸ ANÃLISIS DE SEGURIDAD
          
          ### ğŸ” Herramientas Utilizadas
          - âœ… **Trivy**: Escaneo de vulnerabilidades en OS y librerÃ­as
          - âœ… **Grype**: AnÃ¡lisis complementario de vulnerabilidades
          - âœ… **Dockle**: VerificaciÃ³n de best practices de Docker
          
          ### ğŸ“Š Resultados de Trivy
          EOF
          
          # AÃ±adir resultados de vulnerabilidades si existen
          if [ -f ./reports/security/trivy-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' ./reports/security/trivy-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' ./reports/security/trivy-report.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' ./reports/security/trivy-report.json)
            
            cat >> SECURITY_REPORT.md << EOF
          
          | Severidad | Cantidad | Estado |
          |-----------|----------|--------|
          | ğŸ”´ CRITICAL | $CRITICAL | $([ $CRITICAL -eq 0 ] && echo "âœ… OK" || echo "âŒ ACCIÃ“N REQUERIDA") |
          | ğŸŸ  HIGH | $HIGH | $([ $HIGH -eq 0 ] && echo "âœ… OK" || echo "âš ï¸ REVISAR") |
          | ğŸŸ¡ MEDIUM | $MEDIUM | $([ $MEDIUM -le 5 ] && echo "âœ… Aceptable" || echo "âš ï¸ Mejorable") |
          EOF
          fi
          
          cat >> SECURITY_REPORT.md << 'EOF'
          
          ---
          
          ## âš¡ ANÃLISIS DE RENDIMIENTO
          
          ### ğŸ“¦ Eficiencia de Imagen
          - Ver reporte detallado de **Dive** en los artefactos adjuntos
          
          ### ğŸš€ Rendimiento en Runtime
          - Ver mÃ©tricas de inicio y uso de recursos en el job summary
          
          ---
          
          ## âœ… RECOMENDACIONES PRIORITARIAS
          
          ### ğŸ”´ CrÃ­ticas (Implementar Inmediatamente)
          - [ ] **Corregir vulnerabilidades CRITICAL**: Actualizar todas las dependencias con vulnerabilidades crÃ­ticas
          - [ ] **Implementar usuario no-root**: Nunca ejecutar contenedores como root
          - [ ] **Agregar health check**: Implementar endpoint de salud para monitoreo
          
          ### ğŸŸ  Importantes (Implementar Esta Semana)
          - [ ] **Reducir tamaÃ±o de imagen**: Objetivo < 500MB para imÃ¡genes de aplicaciÃ³n
          - [ ] **Multi-stage builds**: Separar build de runtime
          - [ ] **Usar imagen base segura**: Alpine Linux o Distroless
          - [ ] **Agregar .dockerignore**: Evitar archivos innecesarios en la imagen
          
          ### ğŸŸ¡ Mejoras (Implementar Este Mes)
          - [ ] **Optimizar capas**: Combinar comandos RUN relacionados
          - [ ] **Limpiar cache**: Eliminar caches de apt/apk tras instalaciÃ³n
          - [ ] **Configurar lÃ­mites de recursos**: CPU y memoria en production
          - [ ] **Implementar escaneo automÃ¡tico**: Integrar en CI/CD
          - [ ] **Usar tags inmutables**: Evitar `latest` en producciÃ³n
          - [ ] **Firmar imÃ¡genes**: Implementar Docker Content Trust
          
          ---
          
          ## ğŸ“š RECURSOS Y SIGUIENTES PASOS
          
          ### ğŸ”— Enlaces Ãštiles
          - [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
          - [OWASP Docker Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html)
          - [CIS Docker Benchmark](https://www.cisecurity.org/benchmark/docker)
          
          ### ğŸ“Š Acciones Recomendadas
          1. Revisar todos los reportes en la secciÃ³n **Artifacts**
          2. Priorizar correcciÃ³n de vulnerabilidades CRITICAL y HIGH
          3. Implementar las recomendaciones crÃ­ticas en el prÃ³ximo sprint
          4. Configurar escaneo automÃ¡tico en cada push
          5. Establecer polÃ­tica de actualizaciÃ³n de imÃ¡genes base
          
          ---
          
          ## ğŸ”„ PrÃ³ximo Escaneo
          Se recomienda escanear la imagen:
          - âœ… DespuÃ©s de cada actualizaciÃ³n de dependencias
          - âœ… Semanalmente para imÃ¡genes en producciÃ³n
          - âœ… Mensualmente para imÃ¡genes en desarrollo
          
          ---
          
          **Generado automÃ¡ticamente por GitHub Actions** | [Ver workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          
          cat SECURITY_REPORT.md >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Subir reporte final
        uses: actions/upload-artifact@v4
        with:
          name: final-security-report
          path: SECURITY_REPORT.md
          retention-days: 90

      - name: ğŸ’¬ Comentar en Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('SECURITY_REPORT.md', 'utf8');
            
            // Crear comentario colapsable para no saturar el PR
            const collapsedReport = `
            ## ğŸ” Reporte de Seguridad y Rendimiento
            
            <details>
            <summary>ğŸ“Š Ver reporte completo</summary>
            
            ${report}
            
            </details>
            
            ### ğŸ¯ Acciones RÃ¡pidas
            - ğŸ“¥ Descarga los reportes detallados en la secciÃ³n **Artifacts**
            - ğŸ” Revisa las vulnerabilidades en la pestaÃ±a **Security**
            - âš¡ Implementa las recomendaciones crÃ­ticas prioritarias
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: collapsedReport
            });

      - name: ğŸš¨ Crear issue si hay vulnerabilidades crÃ­ticas
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Leer reporte de Trivy
            let hasCritical = false;
            let criticalCount = 0;
            let highCount = 0;
            
            try {
              const trivyReport = JSON.parse(fs.readFileSync('./reports/security/trivy-report.json', 'utf8'));
              
              for (const result of trivyReport.Results || []) {
                for (const vuln of result.Vulnerabilities || []) {
                  if (vuln.Severity === 'CRITICAL') {
                    criticalCount++;
                    hasCritical = true;
                  } else if (vuln.Severity === 'HIGH') {
                    highCount++;
                  }
                }
              }
            } catch (error) {
              console.log('No se pudo leer el reporte de Trivy');
              return;
            }
            
            // Si hay vulnerabilidades crÃ­ticas, crear issue
            if (hasCritical) {
              const issueTitle = `ğŸš¨ Vulnerabilidades crÃ­ticas detectadas en ${{ needs.pull-image.outputs.image_full }}`;
              const issueBody = `
              ## ğŸ” Alerta de Seguridad
              
              Se han detectado **${criticalCount} vulnerabilidades CRITICAL** y **${highCount} vulnerabilidades HIGH** en la imagen:
              
              **Imagen**: \`${{ needs.pull-image.outputs.image_full }}\`
              **Fecha**: ${new Date().toISOString().split('T')[0]}
              **Workflow**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ### ğŸ¯ Acciones Requeridas
              
              1. âœ… Revisar el [reporte completo en Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              2. âœ… Actualizar dependencias vulnerables
              3. âœ… Re-construir y re-escanear la imagen
              4. âœ… Verificar que las vulnerabilidades se resolvieron
              
              ### ğŸ“Š Resumen
              - ğŸ”´ **CRITICAL**: ${criticalCount}
              - ğŸŸ  **HIGH**: ${highCount}
              
              ### ğŸ”— Enlaces Ãštiles
              - [Reporte de Seguridad](https://github.com/${{ github.repository }}/security)
              - [DocumentaciÃ³n de RemediaciÃ³n](https://github.com/${{ github.repository }}/wiki)
              
              ---
              
              âš ï¸ **Este issue se cierra automÃ¡ticamente cuando se resuelvan las vulnerabilidades**
              `;
              
              // Buscar issues abiertos similares
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'security,critical'
              });
              
              const similarIssue = existingIssues.data.find(issue => 
                issue.title.includes('Vulnerabilidades crÃ­ticas') && 
                issue.title.includes('${{ inputs.image_tag }}')
              );
              
              if (!similarIssue) {
                // Crear nuevo issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['security', 'critical', 'automated']
                });
                
                console.log('âœ… Issue de seguridad creado');
              } else {
                // Actualizar issue existente
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: similarIssue.number,
                  body: `ğŸ”„ **ActualizaciÃ³n**: El escaneo sigue detectando ${criticalCount} vulnerabilidades CRITICAL.\n\nWorkflow: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
                });
                
                console.log('âœ… Issue de seguridad actualizado');
              }
            }

      - name: âœ… Verificar estado final
        run: |
          echo "## âœ… Estado Final del AnÃ¡lisis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Escaneo de seguridad | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ AnÃ¡lisis de rendimiento | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Pruebas de runtime | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‹ Reporte generado | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ **Todos los reportes estÃ¡n disponibles en Artifacts**" >> $GITHUB_STEP_SUMMARY