########################################
# 🔄 WORKFLOW REUSABLE: Update Kubernetes Images
# Actualiza automáticamente las imágenes Docker en los
# manifiestos de Kubernetes y hace commit de los cambios
########################################

name: Reusable Update K8s Images

# 🔧 Definir como workflow reusable con inputs configurables
on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag, ej: mi-app)'
        required: true
        type: string
      dockerhub_username:
        description: 'Usuario de Docker Hub (texto literal, no secret)'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/dev)'
        required: true
        type: string
      commit_sha:
        description: 'SHA del commit para generar el tag'
        required: true
        type: string
      k8s_manifests_path:
        description: 'Ruta a los manifiestos de Kubernetes'
        required: false
        type: string
        default: 'kubernetes/entornos'
      git_user_name:
        description: 'Nombre del usuario para el commit'
        required: false
        type: string
        default: 'GitHub Actions Bot'
      git_user_email:
        description: 'Email del usuario para el commit'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
      target_branch:
        description: 'Rama donde hacer el commit (default: rama actual)'
        required: false
        type: string
        default: ''
      create_pr:
        description: 'Crear PR en lugar de commit directo (true/false)'
        required: false
        type: boolean
        default: false
    secrets:
      GH_PAT:
        description: 'Personal Access Token para hacer commits (opcional si se usa GITHUB_TOKEN)'
        required: false

jobs:
  # ═══════════════════════════════════════════════════════════
  # 🔄 JOB: UPDATE KUBERNETES MANIFESTS
  # ═══════════════════════════════════════════════════════════
  update-k8s-manifests:
    name: Update Kubernetes Image Tags
    runs-on: ubuntu-latest
    
    steps:
      # ═══════════════════════════════════════════════════════════
      # 📥 PASO 1: CHECKOUT DEL REPOSITORIO
      # ═══════════════════════════════════════════════════════════
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}
          ref: ${{ inputs.target_branch || github.ref }}

      # ═══════════════════════════════════════════════════════════
      # 🏷️ PASO 2: GENERAR TAG DE LA IMAGEN
      # ═══════════════════════════════════════════════════════════
      - name: Generate image tag
        id: image_tag
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          COMMIT_SHA="${{ inputs.commit_sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          
          # Tag principal: environment-shortsha (ej: pro-a1b2c3d)
          IMAGE_TAG="${ENVIRONMENT}-${SHORT_SHA}"
          FULL_IMAGE="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${IMAGE_TAG}"
          
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🏷️  IMAGEN A ACTUALIZAR EN MANIFIESTOS K8S"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📦 Imagen: ${{ inputs.docker_image }}"
          echo "👤 Usuario: ${{ inputs.dockerhub_username }}"
          echo "🌍 Entorno: ${ENVIRONMENT}"
          echo "🔗 Commit SHA: ${COMMIT_SHA}"
          echo "🏷️  Tag: ${IMAGE_TAG}"
          echo "🐳 Imagen completa: ${FULL_IMAGE}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      # ═══════════════════════════════════════════════════════════
      # 🔍 PASO 3: VERIFICAR ESTRUCTURA DE MANIFIESTOS
      # ═══════════════════════════════════════════════════════════
      - name: Verify manifests structure
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📂 ESTRUCTURA DE MANIFIESTOS KUBERNETES"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          if [[ -d "${{ inputs.k8s_manifests_path }}" ]]; then
            echo "✅ Directorio encontrado: ${{ inputs.k8s_manifests_path }}"
            echo ""
            echo "📋 Archivos YAML encontrados:"
            find "${{ inputs.k8s_manifests_path }}" -type f \( -name "*.yaml" -o -name "*.yml" \) -exec echo "   • {}" \;
            echo ""
            echo "🔍 Buscando referencias de imagen existentes:"
            grep -r "image:" "${{ inputs.k8s_manifests_path }}" --include="*.yaml" --include="*.yml" || echo "   ℹ️  No se encontraron referencias 'image:'"
          else
            echo "❌ Directorio no encontrado: ${{ inputs.k8s_manifests_path }}"
            echo "⚠️  Se creará durante el proceso de actualización si es necesario"
          fi
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      # ═══════════════════════════════════════════════════════════
      # 🔄 PASO 4: ACTUALIZAR IMÁGENES EN MANIFIESTOS
      # ═══════════════════════════════════════════════════════════
      - name: Update image tags in manifests
        id: update
        run: |
          MANIFESTS_PATH="${{ inputs.k8s_manifests_path }}"
          FULL_IMAGE="${{ steps.image_tag.outputs.full_image }}"
          DOCKER_IMAGE="${{ inputs.docker_image }}"
          DOCKERHUB_USER="${{ inputs.dockerhub_username }}"
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🔄 ACTUALIZANDO MANIFIESTOS KUBERNETES"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          if [[ ! -d "${MANIFESTS_PATH}" ]]; then
            echo "❌ Error: Directorio ${MANIFESTS_PATH} no existe"
            exit 1
          fi
          
          # Buscar y actualizar archivos YAML
          FILES_UPDATED=0
          TOTAL_REPLACEMENTS=0
          
          while IFS= read -r -d '' file; do
            echo ""
            echo "📄 Procesando: ${file}"
            
            # Buscar líneas con 'image:' que contengan la imagen objetivo
            if grep -q "image:.*${DOCKERHUB_USER}/${DOCKER_IMAGE}" "${file}"; then
              # Crear backup
              cp "${file}" "${file}.bak"
              
              # Contar ocurrencias antes
              BEFORE_COUNT=$(grep -c "image:.*${DOCKERHUB_USER}/${DOCKER_IMAGE}" "${file}" || echo "0")
              
              # Actualizar imagen usando sed
              # Busca: image: usuario/imagen:cualquier-tag
              # Reemplaza por: image: usuario/imagen:nuevo-tag
              sed -i "s|image: ${DOCKERHUB_USER}/${DOCKER_IMAGE}:.*|image: ${FULL_IMAGE}|g" "${file}"
              
              # También manejar casos sin espacios después de ':'
              sed -i "s|image:${DOCKERHUB_USER}/${DOCKER_IMAGE}:.*|image: ${FULL_IMAGE}|g" "${file}"
              
              # Contar ocurrencias después
              AFTER_COUNT=$(grep -c "image: ${FULL_IMAGE}" "${file}" || echo "0")
              
              if [[ "${AFTER_COUNT}" -gt 0 ]]; then
                echo "   ✅ Actualizado: ${AFTER_COUNT} ocurrencia(s)"
                FILES_UPDATED=$((FILES_UPDATED + 1))
                TOTAL_REPLACEMENTS=$((TOTAL_REPLACEMENTS + AFTER_COUNT))
                
                # Mostrar diferencias
                echo "   📝 Cambios realizados:"
                diff -u "${file}.bak" "${file}" | grep "^[-+]" | grep "image:" || echo "   ℹ️  Sin cambios visibles"
              else
                echo "   ℹ️  Sin cambios"
                mv "${file}.bak" "${file}"  # Restaurar si no hubo cambios
              fi
            else
              echo "   ⏭️  No contiene la imagen ${DOCKERHUB_USER}/${DOCKER_IMAGE}"
            fi
          done < <(find "${MANIFESTS_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) -print0)
          
          # Limpiar backups
          find "${MANIFESTS_PATH}" -name "*.bak" -delete
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 RESUMEN DE ACTUALIZACIÓN"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📁 Archivos actualizados: ${FILES_UPDATED}"
          echo "🔄 Total de reemplazos: ${TOTAL_REPLACEMENTS}"
          echo "🐳 Nueva imagen: ${FULL_IMAGE}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Guardar outputs
          echo "files_updated=${FILES_UPDATED}" >> $GITHUB_OUTPUT
          echo "total_replacements=${TOTAL_REPLACEMENTS}" >> $GITHUB_OUTPUT

      # ═══════════════════════════════════════════════════════════
      # 📊 PASO 5: VERIFICAR CAMBIOS
      # ═══════════════════════════════════════════════════════════
      - name: Check for changes
        id: git_status
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT
          
          if git diff --quiet; then
            echo "ℹ️  No hay cambios para commitear"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Se detectaron cambios en los manifiestos"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "📝 Archivos modificados:"
            git diff --name-only
          fi

      # ═══════════════════════════════════════════════════════════
      # 🔐 PASO 6: CONFIGURAR GIT
      # ═══════════════════════════════════════════════════════════
      - name: Configure Git
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          git config --global user.name "${{ inputs.git_user_name }}"
          git config --global user.email "${{ inputs.git_user_email }}"

      # ═══════════════════════════════════════════════════════════
      # 💾 PASO 7A: COMMIT DIRECTO (si create_pr = false)
      # ═══════════════════════════════════════════════════════════
      - name: Commit and push changes
        if: steps.git_status.outputs.has_changes == 'true' && inputs.create_pr == false
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          IMAGE_TAG="${{ steps.image_tag.outputs.tag }}"
          
          git add ${{ inputs.k8s_manifests_path }}
          git commit -m "🚀 Update K8s image to ${IMAGE_TAG} [${ENVIRONMENT}]

          - Image: ${{ steps.image_tag.outputs.full_image }}
          - Environment: ${ENVIRONMENT}
          - Files updated: ${{ steps.update.outputs.files_updated }}
          - Total replacements: ${{ steps.update.outputs.total_replacements }}
          - Commit SHA: ${{ inputs.commit_sha }}
          - Triggered by: ${{ github.actor }}
          
          Auto-generated by workflow: ${{ github.workflow }}"
          
          git push
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ CAMBIOS COMMITEADOS Y PUSHEADOS"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      # ═══════════════════════════════════════════════════════════
      # 🔀 PASO 7B: CREAR PULL REQUEST (si create_pr = true)
      # ═══════════════════════════════════════════════════════════
      - name: Create Pull Request
        if: steps.git_status.outputs.has_changes == 'true' && inputs.create_pr == true
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_PAT || github.token }}
          commit-message: |
            🚀 Update K8s image to ${{ steps.image_tag.outputs.tag }} [${{ inputs.environment }}]
          branch: update-k8s-image-${{ inputs.environment }}-${{ steps.image_tag.outputs.tag }}
          delete-branch: true
          title: "🚀 Update K8s Image: ${{ inputs.docker_image }}:${{ steps.image_tag.outputs.tag }}"
          body: |
            ## 🐳 Kubernetes Image Update
            
            **Environment:** `${{ inputs.environment }}`
            **New Image:** `${{ steps.image_tag.outputs.full_image }}`
            
            ### 📊 Changes Summary
            - **Files Updated:** ${{ steps.update.outputs.files_updated }}
            - **Total Replacements:** ${{ steps.update.outputs.total_replacements }}
            - **Commit SHA:** `${{ inputs.commit_sha }}`
            
            ### 🔗 Related Links
            - [Docker Hub Image](https://hub.docker.com/r/${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}/tags)
            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *Auto-generated by `${{ github.workflow }}` triggered by @${{ github.actor }}*
          labels: |
            kubernetes
            deployment
            automated
            ${{ inputs.environment }}

      # ═══════════════════════════════════════════════════════════
      # ✅ PASO 8: REPORTE FINAL
      # ═══════════════════════════════════════════════════════════
      - name: Final Report
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 REPORTE FINAL DE ACTUALIZACIÓN"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🐳 Imagen: ${{ steps.image_tag.outputs.full_image }}"
          echo "🌍 Entorno: ${{ inputs.environment }}"
          echo "📁 Archivos actualizados: ${{ steps.update.outputs.files_updated }}"
          echo "🔄 Reemplazos totales: ${{ steps.update.outputs.total_replacements }}"
          echo "💾 Cambios detectados: ${{ steps.git_status.outputs.has_changes }}"
          echo "🔀 Crear PR: ${{ inputs.create_pr }}"
          echo "👤 Ejecutado por: ${{ github.actor }}"
          echo "🕐 Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "🔗 Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"