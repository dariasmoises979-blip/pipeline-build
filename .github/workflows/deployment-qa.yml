########################################
# ğŸ”„ WORKFLOW REUSABLE: Find Latest Image & Update K8s
# Busca la Ãºltima imagen en Docker Hub creada por el pipeline
# y actualiza los manifiestos de Kubernetes automÃ¡ticamente
# deployment-qa.yml
########################################

name: Reusable Find & Update K8s Images

# ğŸ”§ Definir como workflow reusable con inputs configurables
on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag, ej: mi-app)'
        required: true
        type: string
      dockerhub_username:
        description: 'Usuario de Docker Hub (texto literal, no secret)'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/dev)'
        required: true
        type: string
      k8s_manifests_path:
        description: 'Ruta a los manifiestos de Kubernetes'
        required: false
        type: string
        default: 'kubernetes/entornos'
      git_user_name:
        description: 'Nombre del usuario para el commit'
        required: false
        type: string
        default: 'GitHub Actions Bot'
      git_user_email:
        description: 'Email del usuario para el commit'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
      target_branch:
        description: 'Rama donde hacer el commit (default: rama actual)'
        required: false
        type: string
        default: ''
      create_pr:
        description: 'Crear PR en lugar de commit directo (true/false)'
        required: false
        type: boolean
        default: false
      tag_pattern:
        description: 'PatrÃ³n de tag a buscar (ej: pro-*, staging-*)'
        required: false
        type: string
        default: ''
    secrets:
      DOCKERHUB_TOKEN:
        description: 'Token de Docker Hub para consultar API'
        required: true
      GH_PAT:
        description: 'Personal Access Token para hacer commits (opcional si se usa GITHUB_TOKEN)'
        required: false

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB: FIND LATEST IMAGE & UPDATE K8S MANIFESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  find-and-update:
    name: Find Latest Image & Update K8s
    runs-on: ubuntu-latest
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ PASO 1: CHECKOUT DEL REPOSITORIO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}
          ref: ${{ inputs.target_branch || github.ref }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ³ PASO 2: BUSCAR ÃšLTIMA IMAGEN EN DOCKER HUB
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Find latest Docker image
        id: find_image
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_USERNAME: ${{ inputs.dockerhub_username }}
          DOCKER_IMAGE: ${{ inputs.docker_image }}
          ENVIRONMENT: ${{ inputs.environment }}
          TAG_PATTERN: ${{ inputs.tag_pattern }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” BUSCANDO ÃšLTIMA IMAGEN EN DOCKER HUB"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Repositorio: ${DOCKERHUB_USERNAME}/${DOCKER_IMAGE}"
          echo "ğŸŒ Entorno: ${ENVIRONMENT}"
          
          # Determinar patrÃ³n de bÃºsqueda
          if [[ -n "${TAG_PATTERN}" ]]; then
            SEARCH_PATTERN="${TAG_PATTERN}"
          else
            SEARCH_PATTERN="${ENVIRONMENT}-"
          fi
          echo "ğŸ” PatrÃ³n de bÃºsqueda: ${SEARCH_PATTERN}*"
          echo ""
          
          # Obtener token de Docker Hub
          echo "ğŸ” Obteniendo token de autenticaciÃ³n..."
          TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${DOCKERHUB_USERNAME}\",\"password\":\"${DOCKERHUB_TOKEN}\"}" \
            https://hub.docker.com/v2/users/login/)
          
          HUB_TOKEN=$(echo "${TOKEN_RESPONSE}" | jq -r '.token // empty')
          
          if [[ -z "${HUB_TOKEN}" || "${HUB_TOKEN}" == "null" ]]; then
            echo "âŒ Error: No se pudo obtener token de Docker Hub"
            echo "Respuesta: ${TOKEN_RESPONSE}"
            exit 1
          fi
          
          echo "âœ… Token obtenido exitosamente"
          echo ""
          
          # Consultar tags de la imagen
          echo "ğŸ“‹ Consultando tags disponibles..."
          TAGS_RESPONSE=$(curl -s -H "Authorization: Bearer ${HUB_TOKEN}" \
            "https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${DOCKER_IMAGE}/tags?page_size=100")
          
          # Verificar si hay error
          if echo "${TAGS_RESPONSE}" | jq -e '.message' > /dev/null 2>&1; then
            echo "âŒ Error al consultar Docker Hub:"
            echo "${TAGS_RESPONSE}" | jq -r '.message'
            exit 1
          fi
          
          # Filtrar tags que coincidan con el patrÃ³n del entorno
          echo "ğŸ” Filtrando tags con patrÃ³n '${SEARCH_PATTERN}'..."
          MATCHING_TAGS=$(echo "${TAGS_RESPONSE}" | jq -r --arg pattern "${SEARCH_PATTERN}" \
            '.results[] | select(.name | startswith($pattern)) | "\(.last_updated)|\(.name)"' | sort -r)
          
          if [[ -z "${MATCHING_TAGS}" ]]; then
            echo "âŒ No se encontraron tags que coincidan con el patrÃ³n '${SEARCH_PATTERN}'"
            echo ""
            echo "ğŸ“‹ Tags disponibles:"
            echo "${TAGS_RESPONSE}" | jq -r '.results[].name' | head -20
            exit 1
          fi
          
          echo "âœ… Tags encontrados:"
          echo "${MATCHING_TAGS}" | head -10
          echo ""
          
          # Obtener el tag mÃ¡s reciente (primera lÃ­nea despuÃ©s de ordenar)
          LATEST_TAG=$(echo "${MATCHING_TAGS}" | head -1 | cut -d'|' -f2)
          LATEST_DATE=$(echo "${MATCHING_TAGS}" | head -1 | cut -d'|' -f1)
          
          FULL_IMAGE="${DOCKERHUB_USERNAME}/${DOCKER_IMAGE}:${LATEST_TAG}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… IMAGEN MÃS RECIENTE ENCONTRADA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Imagen completa: ${FULL_IMAGE}"
          echo "ğŸ·ï¸  Tag: ${LATEST_TAG}"
          echo "ğŸ“… Fecha: ${LATEST_DATE}"
          echo "ğŸ”— Docker Hub: https://hub.docker.com/r/${DOCKERHUB_USERNAME}/${DOCKER_IMAGE}/tags"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Guardar outputs
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "updated_date=${LATEST_DATE}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 3: VERIFICAR ESTRUCTURA DE MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Verify manifests structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ ESTRUCTURA DE MANIFIESTOS KUBERNETES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ -d "${{ inputs.k8s_manifests_path }}" ]]; then
            echo "âœ… Directorio encontrado: ${{ inputs.k8s_manifests_path }}"
            echo ""
            echo "ğŸ“‹ Archivos YAML encontrados:"
            find "${{ inputs.k8s_manifests_path }}" -type f \( -name "*.yaml" -o -name "*.yml" \) -exec echo "   â€¢ {}" \;
            echo ""
            echo "ğŸ” Buscando referencias de imagen existentes:"
            grep -r "image:" "${{ inputs.k8s_manifests_path }}" --include="*.yaml" --include="*.yml" || echo "   â„¹ï¸  No se encontraron referencias 'image:'"
          else
            echo "âŒ Directorio no encontrado: ${{ inputs.k8s_manifests_path }}"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”„ PASO 4: ACTUALIZAR IMÃGENES EN MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Update image tags in manifests
        id: update
        env:
          MANIFESTS_PATH: ${{ inputs.k8s_manifests_path }}
          FULL_IMAGE: ${{ steps.find_image.outputs.full_image }}
          DOCKER_IMAGE: ${{ inputs.docker_image }}
          DOCKERHUB_USER: ${{ inputs.dockerhub_username }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ ACTUALIZANDO MANIFIESTOS KUBERNETES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ ! -d "${MANIFESTS_PATH}" ]]; then
            echo "âŒ Error: Directorio ${MANIFESTS_PATH} no existe"
            exit 1
          fi
          
          # Buscar y actualizar archivos YAML
          FILES_UPDATED=0
          TOTAL_REPLACEMENTS=0
          
          while IFS= read -r -d '' file; do
            echo ""
            echo "ğŸ“„ Procesando: ${file}"
            
            # Buscar lÃ­neas con 'image:' que contengan la imagen objetivo
            if grep -q "image:.*${DOCKERHUB_USER}/${DOCKER_IMAGE}" "${file}"; then
              # Crear backup
              cp "${file}" "${file}.bak"
              
              # Contar ocurrencias antes
              BEFORE_COUNT=$(grep -c "image:.*${DOCKERHUB_USER}/${DOCKER_IMAGE}" "${file}" || echo "0")
              
              # Actualizar imagen usando sed
              # Busca: image: usuario/imagen:cualquier-tag
              # Reemplaza por: image: usuario/imagen:nuevo-tag
              sed -i "s|image: ${DOCKERHUB_USER}/${DOCKER_IMAGE}:.*|image: ${FULL_IMAGE}|g" "${file}"
              
              # TambiÃ©n manejar casos sin espacios despuÃ©s de ':'
              sed -i "s|image:${DOCKERHUB_USER}/${DOCKER_IMAGE}:.*|image: ${FULL_IMAGE}|g" "${file}"
              
              # Contar ocurrencias despuÃ©s
              AFTER_COUNT=$(grep -c "image: ${FULL_IMAGE}" "${file}" || echo "0")
              
              if [[ "${AFTER_COUNT}" -gt 0 ]]; then
                echo "   âœ… Actualizado: ${AFTER_COUNT} ocurrencia(s)"
                FILES_UPDATED=$((FILES_UPDATED + 1))
                TOTAL_REPLACEMENTS=$((TOTAL_REPLACEMENTS + AFTER_COUNT))
                
                # Mostrar diferencias
                echo "   ğŸ“ Cambios realizados:"
                diff -u "${file}.bak" "${file}" | grep "^[-+]" | grep "image:" || echo "   â„¹ï¸  Sin cambios visibles"
              else
                echo "   â„¹ï¸  Sin cambios"
                mv "${file}.bak" "${file}"  # Restaurar si no hubo cambios
              fi
            else
              echo "   â­ï¸  No contiene la imagen ${DOCKERHUB_USER}/${DOCKER_IMAGE}"
            fi
          done < <(find "${MANIFESTS_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) -print0)
          
          # Limpiar backups
          find "${MANIFESTS_PATH}" -name "*.bak" -delete
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMEN DE ACTUALIZACIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Archivos actualizados: ${FILES_UPDATED}"
          echo "ğŸ”„ Total de reemplazos: ${TOTAL_REPLACEMENTS}"
          echo "ğŸ³ Nueva imagen: ${FULL_IMAGE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Guardar outputs
          echo "files_updated=${FILES_UPDATED}" >> $GITHUB_OUTPUT
          echo "total_replacements=${TOTAL_REPLACEMENTS}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 5: VERIFICAR CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Check for changes
        id: git_status
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT
          
          if git diff --quiet; then
            echo "â„¹ï¸  No hay cambios para commitear"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Se detectaron cambios en los manifiestos"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ“ Archivos modificados:"
            git diff --name-only
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 6: CONFIGURAR GIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Configure Git
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          git config --global user.name "${{ inputs.git_user_name }}"
          git config --global user.email "${{ inputs.git_user_email }}"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ PASO 7A: COMMIT DIRECTO (si create_pr = false)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Commit and push changes
        if: steps.git_status.outputs.has_changes == 'true' && inputs.create_pr == false
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          IMAGE_TAG="${{ steps.find_image.outputs.tag }}"
          UPDATED_DATE="${{ steps.find_image.outputs.updated_date }}"
          
          git add ${{ inputs.k8s_manifests_path }}
          git commit -m "ğŸš€ Update K8s image to ${IMAGE_TAG} [${ENVIRONMENT}]

          - Image: ${{ steps.find_image.outputs.full_image }}
          - Environment: ${ENVIRONMENT}
          - Image Date: ${UPDATED_DATE}
          - Files updated: ${{ steps.update.outputs.files_updated }}
          - Total replacements: ${{ steps.update.outputs.total_replacements }}
          - Triggered by: ${{ github.actor }}
          
          Auto-generated by workflow: ${{ github.workflow }}"
          
          git push
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CAMBIOS COMMITEADOS Y PUSHEADOS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”€ PASO 7B: CREAR PULL REQUEST (si create_pr = true)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Create Pull Request
        if: steps.git_status.outputs.has_changes == 'true' && inputs.create_pr == true
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_PAT || github.token }}
          commit-message: |
            ğŸš€ Update K8s image to ${{ steps.find_image.outputs.tag }} [${{ inputs.environment }}]
          branch: update-k8s-image-${{ inputs.environment }}-${{ steps.find_image.outputs.tag }}
          delete-branch: true
          title: "ğŸš€ Update K8s Image: ${{ inputs.docker_image }}:${{ steps.find_image.outputs.tag }}"
          body: |
            ## ğŸ³ Kubernetes Image Update
            
            **Environment:** `${{ inputs.environment }}`
            **New Image:** `${{ steps.find_image.outputs.full_image }}`
            **Image Date:** `${{ steps.find_image.outputs.updated_date }}`
            
            ### ğŸ“Š Changes Summary
            - **Files Updated:** ${{ steps.update.outputs.files_updated }}
            - **Total Replacements:** ${{ steps.update.outputs.total_replacements }}
            
            ### ğŸ”— Related Links
            - [Docker Hub Image](https://hub.docker.com/r/${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}/tags)
            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *Auto-generated by `${{ github.workflow }}` triggered by @${{ github.actor }}*
          labels: |
            kubernetes
            deployment
            automated
            ${{ inputs.environment }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… PASO 8: REPORTE FINAL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Final Report
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š REPORTE FINAL DE ACTUALIZACIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Imagen: ${{ steps.find_image.outputs.full_image }}"
          echo "ğŸ·ï¸  Tag: ${{ steps.find_image.outputs.tag }}"
          echo "ğŸ“… Fecha imagen: ${{ steps.find_image.outputs.updated_date }}"
          echo "ğŸŒ Entorno: ${{ inputs.environment }}"
          echo "ğŸ“ Archivos actualizados: ${{ steps.update.outputs.files_updated }}"
          echo "ğŸ”„ Reemplazos totales: ${{ steps.update.outputs.total_replacements }}"
          echo "ğŸ’¾ Cambios detectados: ${{ steps.git_status.outputs.has_changes }}"
          echo "ğŸ”€ Crear PR: ${{ inputs.create_pr }}"
          echo "ğŸ‘¤ Ejecutado por: ${{ github.actor }}"
          echo "ğŸ• Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"