########################################
# ğŸ”„ WORKFLOW REUSABLE: Find Latest Image & Update K8s (GCP)
# Busca la Ãºltima imagen en GCP Artifact Registry creada por el pipeline
# y actualiza los manifiestos de Kubernetes automÃ¡ticamente
# deployment-qa.yml
########################################

name: Reusable Find & Update K8s Images (GCP)

# ğŸ”§ Definir como workflow reusable con inputs configurables
on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag, ej: mi-app)'
        required: true
        type: string
      gcp_project_id:
        description: 'ID del proyecto de GCP'
        required: true
        type: string
      gcp_region:
        description: 'RegiÃ³n de GCP donde estÃ¡ el Artifact Registry (ej: us-central1)'
        required: true
        type: string
      artifact_registry:
        description: 'Nombre del repositorio de Artifact Registry'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/dev)'
        required: true
        type: string
      k8s_manifests_path:
        description: 'Ruta a los manifiestos de Kubernetes'
        required: false
        type: string
        default: 'kubernetes/entornos'
      git_user_name:
        description: 'Nombre del usuario para el commit'
        required: false
        type: string
        default: 'GitHub Actions Bot'
      git_user_email:
        description: 'Email del usuario para el commit'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
      target_branch:
        description: 'Rama donde hacer el commit (default: rama actual)'
        required: false
        type: string
        default: ''
      create_pr:
        description: 'Crear PR en lugar de commit directo (true/false)'
        required: false
        type: boolean
        default: false
      tag_pattern:
        description: 'PatrÃ³n de tag a buscar (ej: pro-*, staging-*)'
        required: false
        type: string
        default: ''
    secrets:
      GCP_SA_KEY:
        description: 'Service Account Key JSON de GCP para autenticaciÃ³n'
        required: true
      GH_PAT:
        description: 'Personal Access Token para hacer commits (opcional si se usa GITHUB_TOKEN)'
        required: false

    outputs:
      full_image:
        description: 'Imagen completa actualizada'
        value: ${{ jobs.find-and-update.outputs.full_image }}
      image_tag:
        description: 'Tag de la imagen'
        value: ${{ jobs.find-and-update.outputs.image_tag }}
      files_updated:
        description: 'NÃºmero de archivos actualizados'
        value: ${{ jobs.find-and-update.outputs.files_updated }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB: FIND LATEST IMAGE & UPDATE K8S MANIFESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  find-and-update:
    name: Find Latest Image & Update K8s (GCP)
    runs-on: ubuntu-latest
    
    outputs:
      full_image: ${{ steps.find_image.outputs.full_image }}
      image_tag: ${{ steps.find_image.outputs.tag }}
      files_updated: ${{ steps.update.outputs.files_updated }}
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ PASO 1: CHECKOUT DEL REPOSITORIO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}
          ref: ${{ inputs.target_branch || github.ref }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 2: AUTENTICACIÃ“N CON GCP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš™ï¸ PASO 3: CONFIGURAR GCLOUD CLI
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ inputs.gcp_project_id }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ³ PASO 4: BUSCAR ÃšLTIMA IMAGEN EN GCP ARTIFACT REGISTRY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Find latest image in GCP Artifact Registry
        id: find_image
        env:
          GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
          GCP_REGION: ${{ inputs.gcp_region }}
          ARTIFACT_REGISTRY: ${{ inputs.artifact_registry }}
          DOCKER_IMAGE: ${{ inputs.docker_image }}
          ENVIRONMENT: ${{ inputs.environment }}
          TAG_PATTERN: ${{ inputs.tag_pattern }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” BUSCANDO ÃšLTIMA IMAGEN EN GCP ARTIFACT REGISTRY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜ï¸  Proyecto: ${GCP_PROJECT_ID}"
          echo "ğŸ“ RegiÃ³n: ${GCP_REGION}"
          echo "ğŸ“¦ Registry: ${ARTIFACT_REGISTRY}"
          echo "ğŸ³ Imagen: ${DOCKER_IMAGE}"
          echo "ğŸŒ Entorno: ${ENVIRONMENT}"
          
          # Construir la ruta completa del repositorio
          REGISTRY_URL="${GCP_REGION}-docker.pkg.dev"
          REPOSITORY_PATH="${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}/${DOCKER_IMAGE}"
          FULL_REPO="${REGISTRY_URL}/${REPOSITORY_PATH}"
          
          # Determinar patrÃ³n de bÃºsqueda
          if [[ -n "${TAG_PATTERN}" ]]; then
            SEARCH_PATTERN="${TAG_PATTERN}"
          else
            SEARCH_PATTERN="${ENVIRONMENT}-"
          fi
          echo "ğŸ” PatrÃ³n de bÃºsqueda: ${SEARCH_PATTERN}*"
          echo ""
          
          # Listar todas las imÃ¡genes del repositorio
          echo "ğŸ“‹ Consultando imÃ¡genes disponibles..."
          
          # Obtener lista de tags con gcloud
          TAGS_OUTPUT=$(gcloud artifacts docker tags list "${FULL_REPO}" \
            --format="json" \
            --sort-by="~UPDATE_TIME" \
            2>&1)
          
          if [[ $? -ne 0 ]]; then
            echo "âŒ Error al consultar Artifact Registry:"
            echo "${TAGS_OUTPUT}"
            echo ""
            echo "ğŸ” Verifica que:"
            echo "   â€¢ El repositorio existe: ${FULL_REPO}"
            echo "   â€¢ La imagen existe en el repositorio"
            echo "   â€¢ El Service Account tiene permisos de lectura"
            echo "   â€¢ El API de Artifact Registry estÃ¡ habilitado"
            exit 1
          fi
          
          # Verificar si hay tags disponibles
          TAG_COUNT=$(echo "${TAGS_OUTPUT}" | jq '. | length')
          
          if [[ "${TAG_COUNT}" -eq 0 ]]; then
            echo "âŒ No se encontraron tags en el repositorio"
            exit 1
          fi
          
          echo "âœ… Encontrados ${TAG_COUNT} tags totales"
          echo ""
          
          # Filtrar tags que coincidan con el patrÃ³n
          echo "ğŸ” Filtrando tags con patrÃ³n '${SEARCH_PATTERN}'..."
          
          # Extraer solo el tag (Ãºltima parte despuÃ©s de :) y filtrar por patrÃ³n
          MATCHING_TAGS=$(echo "${TAGS_OUTPUT}" | jq -r --arg pattern "${SEARCH_PATTERN}" \
            '.[] | select(.tag | startswith($pattern)) | "\(.updateTime)|\(.tag)"' | sort -r)
          
          if [[ -z "${MATCHING_TAGS}" ]]; then
            echo "âŒ No se encontraron tags que coincidan con el patrÃ³n '${SEARCH_PATTERN}'"
            echo ""
            echo "ğŸ“‹ Primeros 20 tags disponibles:"
            echo "${TAGS_OUTPUT}" | jq -r '.[].tag' | head -20
            echo ""
            echo "ğŸ’¡ Sugerencia: Verifica el patrÃ³n de bÃºsqueda o el entorno especificado"
            exit 1
          fi
          
          echo "âœ… Tags encontrados que coinciden:"
          echo "${MATCHING_TAGS}" | head -10
          echo ""
          
          # Obtener el tag mÃ¡s reciente (primera lÃ­nea despuÃ©s de ordenar)
          LATEST_TAG=$(echo "${MATCHING_TAGS}" | head -1 | cut -d'|' -f2)
          LATEST_DATE=$(echo "${MATCHING_TAGS}" | head -1 | cut -d'|' -f1)
          
          # Construir la imagen completa
          FULL_IMAGE="${FULL_REPO}:${LATEST_TAG}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… IMAGEN MÃS RECIENTE ENCONTRADA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Imagen completa: ${FULL_IMAGE}"
          echo "ğŸ·ï¸  Tag: ${LATEST_TAG}"
          echo "ğŸ“… Fecha: ${LATEST_DATE}"
          echo "ğŸ“ Registry: ${REGISTRY_URL}"
          echo "ğŸ“¦ Repositorio: ${REPOSITORY_PATH}"
          echo "ğŸ”— GCP Console: https://console.cloud.google.com/artifacts/docker/${GCP_PROJECT_ID}/${GCP_REGION}/${ARTIFACT_REGISTRY}/${DOCKER_IMAGE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Guardar outputs
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "updated_date=${LATEST_DATE}" >> $GITHUB_OUTPUT
          echo "registry_url=${REGISTRY_URL}" >> $GITHUB_OUTPUT
          echo "repository_path=${REPOSITORY_PATH}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 5: VERIFICAR ESTRUCTURA DE MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Verify manifests structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ ESTRUCTURA DE MANIFIESTOS KUBERNETES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ -d "${{ inputs.k8s_manifests_path }}" ]]; then
            echo "âœ… Directorio encontrado: ${{ inputs.k8s_manifests_path }}"
            echo ""
            echo "ğŸ“‹ Archivos YAML encontrados:"
            find "${{ inputs.k8s_manifests_path }}" -type f \( -name "*.yaml" -o -name "*.yml" \) -exec echo "   â€¢ {}" \;
            echo ""
            echo "ğŸ” Buscando referencias de imagen existentes:"
            grep -r "image:" "${{ inputs.k8s_manifests_path }}" --include="*.yaml" --include="*.yml" || echo "   â„¹ï¸  No se encontraron referencias 'image:'"
          else
            echo "âŒ Directorio no encontrado: ${{ inputs.k8s_manifests_path }}"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”„ PASO 6: ACTUALIZAR IMÃGENES EN MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Update image tags in manifests
        id: update
        env:
          MANIFESTS_PATH: ${{ inputs.k8s_manifests_path }}
          FULL_IMAGE: ${{ steps.find_image.outputs.full_image }}
          DOCKER_IMAGE: ${{ inputs.docker_image }}
          REGISTRY_URL: ${{ steps.find_image.outputs.registry_url }}
          REPOSITORY_PATH: ${{ steps.find_image.outputs.repository_path }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ ACTUALIZANDO MANIFIESTOS KUBERNETES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ ! -d "${MANIFESTS_PATH}" ]]; then
            echo "âŒ Error: Directorio ${MANIFESTS_PATH} no existe"
            exit 1
          fi
          
          # Construir patrÃ³n base para buscar (sin el tag)
          IMAGE_BASE="${REGISTRY_URL}/${REPOSITORY_PATH}"
          
          # Buscar y actualizar archivos YAML
          FILES_UPDATED=0
          TOTAL_REPLACEMENTS=0
          
          while IFS= read -r -d '' file; do
            echo ""
            echo "ğŸ“„ Procesando: ${file}"
            
            # Buscar lÃ­neas con 'image:' que contengan la imagen objetivo
            if grep -q "image:.*${IMAGE_BASE}" "${file}"; then
              # Crear backup
              cp "${file}" "${file}.bak"
              
              # Contar ocurrencias antes
              BEFORE_COUNT=$(grep -c "image:.*${IMAGE_BASE}" "${file}" || echo "0")
              
              # Actualizar imagen usando sed
              # Busca: image: region-docker.pkg.dev/project/registry/image:cualquier-tag
              # Reemplaza por: image: region-docker.pkg.dev/project/registry/image:nuevo-tag
              sed -i "s|image: ${IMAGE_BASE}:.*|image: ${FULL_IMAGE}|g" "${file}"
              
              # TambiÃ©n manejar casos sin espacios despuÃ©s de ':'
              sed -i "s|image:${IMAGE_BASE}:.*|image: ${FULL_IMAGE}|g" "${file}"
              
              # Contar ocurrencias despuÃ©s
              AFTER_COUNT=$(grep -c "image: ${FULL_IMAGE}" "${file}" || echo "0")
              
              if [[ "${AFTER_COUNT}" -gt 0 ]]; then
                echo "   âœ… Actualizado: ${AFTER_COUNT} ocurrencia(s)"
                FILES_UPDATED=$((FILES_UPDATED + 1))
                TOTAL_REPLACEMENTS=$((TOTAL_REPLACEMENTS + AFTER_COUNT))
                
                # Mostrar diferencias
                echo "   ğŸ“ Cambios realizados:"
                diff -u "${file}.bak" "${file}" | grep "^[-+]" | grep "image:" || echo "   â„¹ï¸  Sin cambios visibles"
              else
                echo "   â„¹ï¸  Sin cambios"
                mv "${file}.bak" "${file}"  # Restaurar si no hubo cambios
              fi
            else
              echo "   â­ï¸  No contiene la imagen ${IMAGE_BASE}"
            fi
          done < <(find "${MANIFESTS_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) -print0)
          
          # Limpiar backups
          find "${MANIFESTS_PATH}" -name "*.bak" -delete
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMEN DE ACTUALIZACIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Archivos actualizados: ${FILES_UPDATED}"
          echo "ğŸ”„ Total de reemplazos: ${TOTAL_REPLACEMENTS}"
          echo "ğŸ³ Nueva imagen: ${FULL_IMAGE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Guardar outputs
          echo "files_updated=${FILES_UPDATED}" >> $GITHUB_OUTPUT
          echo "total_replacements=${TOTAL_REPLACEMENTS}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 7: VERIFICAR CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Check for changes
        id: git_status
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT
          
          if git diff --quiet; then
            echo "â„¹ï¸  No hay cambios para commitear"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Se detectaron cambios en los manifiestos"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ“ Archivos modificados:"
            git diff --name-only
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 8: CONFIGURAR GIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Configure Git
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          git config --global user.name "${{ inputs.git_user_name }}"
          git config --global user.email "${{ inputs.git_user_email }}"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ PASO 9A: COMMIT DIRECTO (si create_pr = false)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Commit and push changes
        if: steps.git_status.outputs.has_changes == 'true' && inputs.create_pr == false
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          IMAGE_TAG="${{ steps.find_image.outputs.tag }}"
          UPDATED_DATE="${{ steps.find_image.outputs.updated_date }}"
          
          git add ${{ inputs.k8s_manifests_path }}
          git commit -m "ğŸš€ Update K8s image to ${IMAGE_TAG} [${ENVIRONMENT}]

          - Image: ${{ steps.find_image.outputs.full_image }}
          - Environment: ${ENVIRONMENT}
          - Image Date: ${UPDATED_DATE}
          - Registry: ${{ inputs.gcp_region }}-docker.pkg.dev
          - Project: ${{ inputs.gcp_project_id }}
          - Files updated: ${{ steps.update.outputs.files_updated }}
          - Total replacements: ${{ steps.update.outputs.total_replacements }}
          - Triggered by: ${{ github.actor }}
          
          Auto-generated by workflow: ${{ github.workflow }}"
          
          git push
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CAMBIOS COMMITEADOS Y PUSHEADOS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”€ PASO 9B: CREAR PULL REQUEST (si create_pr = true)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Create Pull Request
        if: steps.git_status.outputs.has_changes == 'true' && inputs.create_pr == true
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_PAT || github.token }}
          commit-message: |
            ğŸš€ Update K8s image to ${{ steps.find_image.outputs.tag }} [${{ inputs.environment }}]
          branch: update-k8s-image-${{ inputs.environment }}-${{ steps.find_image.outputs.tag }}
          delete-branch: true
          title: "ğŸš€ Update K8s Image: ${{ inputs.docker_image }}:${{ steps.find_image.outputs.tag }}"
          body: |
            ## ğŸ³ Kubernetes Image Update (GCP)
            
            **Environment:** `${{ inputs.environment }}`
            **New Image:** `${{ steps.find_image.outputs.full_image }}`
            **Image Date:** `${{ steps.find_image.outputs.updated_date }}`
            
            ### â˜ï¸ GCP Details
            - **Project:** `${{ inputs.gcp_project_id }}`
            - **Region:** `${{ inputs.gcp_region }}`
            - **Registry:** `${{ inputs.artifact_registry }}`
            
            ### ğŸ“Š Changes Summary
            - **Files Updated:** ${{ steps.update.outputs.files_updated }}
            - **Total Replacements:** ${{ steps.update.outputs.total_replacements }}
            
            ### ğŸ”— Related Links
            - [GCP Artifact Registry](https://console.cloud.google.com/artifacts/docker/${{ inputs.gcp_project_id }}/${{ inputs.gcp_region }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }})
            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *Auto-generated by `${{ github.workflow }}` triggered by @${{ github.actor }}*
          labels: |
            kubernetes
            deployment
            automated
            gcp
            ${{ inputs.environment }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… PASO 10: REPORTE FINAL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Final Report
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š REPORTE FINAL DE ACTUALIZACIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Imagen: ${{ steps.find_image.outputs.full_image }}"
          echo "ğŸ·ï¸  Tag: ${{ steps.find_image.outputs.tag }}"
          echo "ğŸ“… Fecha imagen: ${{ steps.find_image.outputs.updated_date }}"
          echo "ğŸŒ Entorno: ${{ inputs.environment }}"
          echo "â˜ï¸  GCP Project: ${{ inputs.gcp_project_id }}"
          echo "ğŸ“ GCP Region: ${{ inputs.gcp_region }}"
          echo "ğŸ“¦ Registry: ${{ inputs.artifact_registry }}"
          echo "ğŸ“ Archivos actualizados: ${{ steps.update.outputs.files_updated }}"
          echo "ğŸ”„ Reemplazos totales: ${{ steps.update.outputs.total_replacements }}"
          echo "ğŸ’¾ Cambios detectados: ${{ steps.git_status.outputs.has_changes }}"
          echo "ğŸ”€ Crear PR: ${{ inputs.create_pr }}"
          echo "ğŸ‘¤ Ejecutado por: ${{ github.actor }}"
          echo "ğŸ• Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“– EJEMPLO DE USO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# name: Update K8s Manifests
#
# on:
#   workflow_dispatch:
#
# jobs:
#   update-k8s:
#     uses: ./.github/workflows/deployment-qa.yml
#     with:
#       docker_image: mi-app
#       gcp_project_id: elite-ceremony-476307-s9
#       gcp_region: us-central1
#       artifact_registry: artifact_dariasmoises979
#       environment: production
#       k8s_manifests_path: kubernetes/overlays/production
#       create_pr: false
#     secrets:
#       GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
#       GH_PAT: ${{ secrets.GH_PAT }}
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•