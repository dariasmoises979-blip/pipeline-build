# .github/workflows/reusable-update-k8s.yml
name: Reusable - Actualizar Manifiestos K8s

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
        description: 'Nombre de la aplicaciÃ³n'
      environment:
        required: true
        type: string
        description: 'Entorno (dev, staging, prod)'
      image_tag:
        required: true
        type: string
        description: 'Tag de la imagen ya construida (ej: dev-abc1234)'
      docker_image:
        required: true
        type: string
        description: 'Nombre completo de la imagen (ej: usuario/app)'
    outputs:
      is_new_app:
        description: 'Indica si es una app nueva'
        value: ${{ jobs.update-manifests.outputs.is_new_app }}
      changes_made:
        description: 'Indica si se realizaron cambios'
        value: ${{ jobs.update-manifests.outputs.changes_made }}

jobs:
  update-manifests:
    name: Actualizar Manifiestos
    runs-on: ubuntu-latest
    outputs:
      is_new_app: ${{ steps.check-app.outputs.is_new }}
      changes_made: ${{ steps.check-changes.outputs.has_changes }}
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ CHECKOUT DEL REPOSITORIO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš™ï¸ CONFIGURAR GIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” VERIFICAR SI LA APP EXISTE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Verificar si la app existe
        id: check-app
        run: |
          APP_PATH="kubernetes/${{ inputs.environment }}/${{ inputs.app_name }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” VERIFICANDO APLICACIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ App: ${{ inputs.app_name }}"
          echo "ğŸŒ Entorno: ${{ inputs.environment }}"
          echo "ğŸ“ Path: $APP_PATH"
          
          if [ -d "$APP_PATH" ]; then
            echo "is_new=false" >> $GITHUB_OUTPUT
            echo "âœ… App EXISTENTE - Se actualizarÃ¡"
            echo ""
            echo "ğŸ“‹ Archivos encontrados:"
            find "$APP_PATH" -type f \( -name "*.yaml" -o -name "*.yml" \) | while read file; do
              echo "   â€¢ $file"
            done
          else
            echo "is_new=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• App NUEVA - Se crearÃ¡ estructura bÃ¡sica"
            mkdir -p "$APP_PATH"
            
            # Crear deployment bÃ¡sico
            cat > "$APP_PATH/deployment.yaml" <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ inputs.app_name }}
            namespace: ${{ inputs.environment }}
            labels:
              app: ${{ inputs.app_name }}
              environment: ${{ inputs.environment }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ${{ inputs.app_name }}
            template:
              metadata:
                labels:
                  app: ${{ inputs.app_name }}
                  environment: ${{ inputs.environment }}
              spec:
                containers:
                - name: ${{ inputs.app_name }}
                  image: ${{ inputs.docker_image }}:${{ inputs.image_tag }}
                  ports:
                  - containerPort: 8080
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
          EOF
            
            # Crear service bÃ¡sico
            cat > "$APP_PATH/service.yaml" <<EOF
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ inputs.app_name }}
            namespace: ${{ inputs.environment }}
            labels:
              app: ${{ inputs.app_name }}
          spec:
            selector:
              app: ${{ inputs.app_name }}
            ports:
            - protocol: TCP
              port: 80
              targetPort: 8080
            type: ClusterIP
          EOF
            
            echo ""
            echo "ğŸ“¦ Archivos creados:"
            echo "   â€¢ $APP_PATH/deployment.yaml"
            echo "   â€¢ $APP_PATH/service.yaml"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ–¼ï¸ ACTUALIZAR IMAGEN EN MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Actualizar imagen en manifiestos
        id: update-image
        run: |
          APP_PATH="kubernetes/${{ inputs.environment }}/${{ inputs.app_name }}"
          NEW_IMAGE="${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¼ï¸  ACTUALIZANDO IMAGEN DOCKER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ†• Nueva imagen: $NEW_IMAGE"
          echo ""
          
          UPDATED_COUNT=0
          OLD_IMAGE=""
          
          # Buscar y actualizar todos los archivos YAML
          for yaml_file in $(find "$APP_PATH" -type f \( -name "*.yaml" -o -name "*.yml" \)); do
            if grep -q "image:" "$yaml_file"; then
              # Capturar imagen anterior (solo la primera vez)
              if [ -z "$OLD_IMAGE" ]; then
                OLD_IMAGE=$(grep "image:" "$yaml_file" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
                echo "ğŸ“œ Imagen anterior: $OLD_IMAGE"
              fi
              
              # Actualizar imagen
              sed -i "s|image:.*|image: $NEW_IMAGE|g" "$yaml_file"
              
              echo "âœ… Actualizado: $(basename $yaml_file)"
              UPDATED_COUNT=$((UPDATED_COUNT + 1))
            fi
          done
          
          echo ""
          echo "ğŸ“Š Total archivos actualizados: $UPDATED_COUNT"
          echo "old_image=$OLD_IMAGE" >> $GITHUB_OUTPUT
          echo "updated_count=$UPDATED_COUNT" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” VERIFICAR SI HAY CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Verificar cambios
        id: check-changes
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” VERIFICANDO CAMBIOS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No hay cambios para commitear"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Cambios detectados"
            echo ""
            echo "ğŸ“‹ Archivos modificados:"
            git diff --name-only | while read file; do
              echo "   â€¢ $file"
            done
            echo ""
            echo "ğŸ“Š EstadÃ­sticas:"
            git diff --stat
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š GENERAR INFORME DE CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Generar informe
        if: steps.check-changes.outputs.has_changes == 'true'
        id: generate-report
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S %Z')
          REPORT_FILE="deployment-report.md"
          
          cat > "$REPORT_FILE" <<EOF
          # ğŸš€ Informe de Despliegue
          
          ## ğŸ“¦ InformaciÃ³n General
          | Campo | Valor |
          |-------|-------|
          | **AplicaciÃ³n** | \`${{ inputs.app_name }}\` |
          | **Entorno** | \`${{ inputs.environment }}\` |
          | **Tipo** | ${{ steps.check-app.outputs.is_new == 'true' && 'ğŸ†• Nueva AplicaciÃ³n' || 'ğŸ”„ ActualizaciÃ³n' }} |
          | **Usuario** | @${{ github.actor }} |
          | **Fecha** | ${TIMESTAMP} |
          | **Commit** | \`${{ github.sha }}\` |
          | **Rama** | \`${{ github.ref_name }}\` |
          
          ## ğŸ³ Imagen Docker
          | Concepto | Valor |
          |----------|-------|
          | **Nueva Imagen** | \`${{ inputs.docker_image }}:${{ inputs.image_tag }}\` |
          | **Imagen Anterior** | \`${{ steps.update-image.outputs.old_image || 'N/A (Nueva App)' }}\` |
          | **Archivos Actualizados** | ${{ steps.update-image.outputs.updated_count }} |
          
          ## ğŸ“ Archivos Modificados
          \`\`\`
          $(git diff --name-only)
          \`\`\`
          
          ## ğŸ” Cambios Detallados
          <details>
          <summary>Ver diff completo</summary>
          
          \`\`\`diff
          $(git diff)
          \`\`\`
          </details>
          
          ## ğŸ”— Links
          - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          
          ---
          *ğŸ¤– Generado automÃ¡ticamente por GitHub Actions*
          EOF
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š INFORME GENERADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat "$REPORT_FILE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ COMMIT Y PUSH DE CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Commit y Push cambios
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          APP_PATH="kubernetes/${{ inputs.environment }}/${{ inputs.app_name }}"
          
          git add "$APP_PATH/"
          
          COMMIT_MSG="ğŸš€ Deploy: ${{ inputs.app_name }} â†’ ${{ inputs.environment }}

          ğŸ“¦ App: ${{ inputs.app_name }}
          ğŸŒ Env: ${{ inputs.environment }}
          ğŸ³ Image: ${{ inputs.docker_image }}:${{ inputs.image_tag }}
          ${{ steps.check-app.outputs.is_new == 'true' && 'ğŸ†• Type: New Application' || 'ğŸ”„ Type: Update' }}
          ğŸ‘¤ User: ${{ github.actor }}
          ğŸ”— Commit: ${{ github.sha }}
          ğŸ“… Date: $(date '+%Y-%m-%d %H:%M:%S %Z')
          
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CAMBIOS PUSHEADOS AL REPOSITORIO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ ArgoCD detectarÃ¡ los cambios automÃ¡ticamente via webhook"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¬ COMENTAR EN PR (SI EXISTE)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Comentar en PR
        if: steps.check-changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const isNew = '${{ steps.check-app.outputs.is_new }}' === 'true';
            const timestamp = new Date().toLocaleString('es-ES', { 
              timeZone: 'Europe/Madrid',
              dateStyle: 'full',
              timeStyle: 'long'
            });
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ${isNew ? 'ğŸ†•' : 'ğŸ”„'} Despliegue ${isNew ? 'Inicial' : 'Actualizado'}
              
              | Campo | Valor |
              |-------|-------|
              | **AplicaciÃ³n** | \`${{ inputs.app_name }}\` |
              | **Entorno** | \`${{ inputs.environment }}\` |
              | **Imagen** | \`${{ inputs.docker_image }}:${{ inputs.image_tag }}\` |
              | **Usuario** | @${{ github.actor }} |
              | **Fecha** | ${timestamp} |
              
              ${isNew ? 'ğŸ“¦ Se ha creado la estructura inicial de la aplicaciÃ³n.' : 'âœ… Los manifiestos de Kubernetes han sido actualizados.'}
              
              ğŸ¯ **ArgoCD** detectarÃ¡ los cambios automÃ¡ticamente y sincronizarÃ¡ la aplicaciÃ³n.`
            })

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âŒ CREAR ISSUE SI FALLA
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Crear Issue si falla
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âŒ Fallo en actualizaciÃ³n de manifiestos: ${{ inputs.app_name }} (${{ inputs.environment }})`,
              body: `## âŒ Error en ActualizaciÃ³n de Manifiestos K8s
              
              El proceso de actualizaciÃ³n de manifiestos ha fallado.
              
              ### ğŸ“‹ Detalles
              | Campo | Valor |
              |-------|-------|
              | **AplicaciÃ³n** | \`${{ inputs.app_name }}\` |
              | **Entorno** | \`${{ inputs.environment }}\` |
              | **Imagen** | \`${{ inputs.docker_image }}:${{ inputs.image_tag }}\` |
              | **Usuario** | @${{ github.actor }} |
              | **Commit** | \`${{ github.sha }}\` |
              | **Workflow** | [Ver logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
              
              ### ğŸ” Acciones Recomendadas
              1. Revisar los logs del workflow
              2. Verificar permisos del token de GitHub
              3. Comprobar estructura del directorio \`kubernetes/${{ inputs.environment }}/\`
              4. Validar sintaxis de los archivos YAML
              
              ### ğŸ”— Links
              - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})`,
              labels: ['deployment', 'failed', 'kubernetes']
            })