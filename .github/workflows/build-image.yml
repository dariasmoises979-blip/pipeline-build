########################################
# ๐ณ WORKFLOW REUSABLE: Build & Push Docker Image
# Construye y publica imรกgenes Docker con tags automรกticos
# basados en el entorno (pro, pre, staging) y commit SHA
########################################

name: Reusable Build & Push Docker

# ๐ง Definir como workflow reusable con inputs configurables
on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag, ej: mi-app)'
        required: true
        type: string
      dockerhub_username:
        description: 'Usuario de Docker Hub (texto literal, no secret)'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/dev)'
        required: false
        type: string
        default: 'dev'
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ NUEVOS INPUTS PARA CLONAR REPOSITORIO EXTERNO
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      external_repo:
        description: 'Repositorio externo a clonar (ej: dariasmoises979-blip/app)'
        required: false
        type: string
        default: ''
      external_repo_ref:
        description: 'Branch/tag/SHA del repositorio externo (default: main)'
        required: false
        type: string
        default: 'main'
      external_repo_path:
        description: 'Directorio donde clonar el repo externo (default: ./external)'
        required: false
        type: string
        default: './external'
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      dockerfile_path:
        description: 'Ruta al Dockerfile (relativo al contexto)'
        required: false
        type: string
        default: './Dockerfile'
      build_context:
        description: 'Directorio de contexto para el build'
        required: false
        type: string
        default: '.'
      additional_tags:
        description: 'Tags adicionales separados por coma (ej: v1.0.0,stable)'
        required: false
        type: string
        default: ''
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ INPUTS PARA REPOSITORIO EXTERNO
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      external_repo:
        description: 'Repositorio externo a clonar (ej: dariasmoises979-blip/app)'
        required: false
        type: string
        default: ''
      external_repo_ref:
        description: 'Branch/tag/SHA del repositorio externo (default: main)'
        required: false
        type: string
        default: 'main'
      external_repo_path:
        description: 'Directorio donde clonar el repo externo (default: ./external)'
        required: false
        type: string
        default: './external'
    secrets:
      DOCKERHUB_TOKEN:
        description: 'Token de autenticaciรณn de Docker Hub'
        required: true
      EXTERNAL_REPO_TOKEN:
        description: 'Token para clonar repositorio privado (opcional)'
        required: false
      EXTERNAL_REPO_TOKEN:
        description: 'Token para clonar repositorio privado (opcional)'
        required: false

jobs:
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # ๐ณ JOB: BUILD & PUSH DOCKER IMAGE
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  docker-build-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ฅ PASO 1: CHECKOUT DEL REPOSITORIO ACTUAL
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ฅ PASO 2: CHECKOUT DEL REPOSITORIO EXTERNO (OPCIONAL)
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Solo se ejecuta si se especificรณ un repositorio externo
      - name: Checkout external repository
        if: inputs.external_repo != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.external_repo }}
          ref: ${{ inputs.external_repo_ref }}
          path: ${{ inputs.external_repo_path }}
          token: ${{ secrets.EXTERNAL_REPO_TOKEN || github.token }}
          fetch-depth: 0

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ PASO 3: VERIFICAR ESTRUCTURA DE ARCHIVOS
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Verify file structure
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ FILE STRUCTURE VERIFICATION"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Current directory:"
          pwd
          echo ""
          echo "๐ Directory listing:"
          ls -la
          echo ""
          if [[ -n "${{ inputs.external_repo }}" ]]; then
            echo "๐ฆ External repo directory (${{ inputs.external_repo_path }}):"
            ls -la ${{ inputs.external_repo_path }} || echo "โ Directory not found"
            echo ""
          fi
          echo "๐ Build context (${{ inputs.build_context }}):"
          ls -la ${{ inputs.build_context }} || echo "โ Directory not found"
          echo ""
          echo "๐ Dockerfile location (${{ inputs.dockerfile_path }}):"
          ls -la ${{ inputs.dockerfile_path }} || echo "โ File not found"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ท๏ธ PASO 4: GENERAR TAGS DINรMICOS
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Generate dynamic tags
        id: tags
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BRANCH_NAME="${{ github.ref_name }}"
          
          TAGS=()
          TAGS+=("${ENVIRONMENT}")
          TAGS+=("${ENVIRONMENT}-${SHORT_SHA}")
          TAGS+=("${COMMIT_SHA}")
          TAGS+=("${SHORT_SHA}")
          
          if [[ "${BRANCH_NAME}" == "main" || "${BRANCH_NAME}" == "master" ]]; then
            TAGS+=("latest")
          fi
          
          SAFE_BRANCH_NAME=$(echo "${BRANCH_NAME}" | sed 's/\//-/g')
          TAGS+=("${SAFE_BRANCH_NAME}-${SHORT_SHA}")
          
          if [[ -n "${{ inputs.additional_tags }}" ]]; then
            IFS=',' read -ra EXTRA_TAGS <<< "${{ inputs.additional_tags }}"
            for tag in "${EXTRA_TAGS[@]}"; do
              tag=$(echo "${tag}" | xargs)
              if [[ -n "${tag}" ]]; then
                TAGS+=("${tag}")
              fi
            done
          fi
          
          DOCKER_TAGS=""
          for tag in "${TAGS[@]}"; do
            DOCKER_TAGS="${DOCKER_TAGS}${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${tag},"
          done
          DOCKER_TAGS="${DOCKER_TAGS%,}"
          
          echo "tags=${DOCKER_TAGS}" >> $GITHUB_OUTPUT
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ท๏ธ  TAGS GENERADOS PARA LA IMAGEN DOCKER"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ Imagen base: ${{ inputs.docker_image }}"
          echo "๐ Entorno: ${ENVIRONMENT}"
          echo "๐ Commit SHA: ${COMMIT_SHA}"
          echo "๐ฟ Rama: ${BRANCH_NAME}"
          if [[ -n "${{ inputs.external_repo }}" ]]; then
            echo "๐ฆ Repositorio externo: ${{ inputs.external_repo }}"
            echo "๐ฟ Ref externo: ${{ inputs.external_repo_ref }}"
          fi
          echo ""
          echo "๐ Lista de tags:"
          for tag in "${TAGS[@]}"; do
            echo "   โข ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${tag}"
          done
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # โ๏ธ PASO 5: CONFIGURAR DOCKER BUILDX
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ PASO 6: LOGIN EN DOCKER HUB
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐๏ธ PASO 7: BUILD & PUSH DE LA IMAGEN DOCKER
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.build_context }}
          file: ${{ inputs.dockerfile_path }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ inputs.environment }}-${{ github.sha }}

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # ๐ PASO 8: REPORTE DE BUILD EXITOSO
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Build Summary Report
        if: success()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ DOCKER IMAGE BUILD & PUSH SUCCESSFUL"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ณ Docker Hub: https://hub.docker.com/r/${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}"
          echo "๐ฆ Image Name: ${{ inputs.docker_image }}"
          echo "๐ Environment: ${{ inputs.environment }}"
          echo "๐ Commit SHA: ${{ github.sha }}"
          echo "๐ค Triggered by: ${{ github.actor }}"
          echo "๐ Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          if [[ -n "${{ inputs.external_repo }}" ]]; then
            echo "๐ฆ External Repo: ${{ inputs.external_repo }} @ ${{ inputs.external_repo_ref }}"
          fi
          echo ""
          echo "๐ Pull Commands:"
          echo "   docker pull ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.environment }}"
          echo "   docker pull ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${GITHUB_SHA:0:7}"
          echo ""
          echo "๐ Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # โ PASO 9: MANEJO DE ERRORES
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: Build Failure Report
        if: failure()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ DOCKER BUILD FAILED"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ๏ธ  Possible reasons:"
          echo "   โข Dockerfile syntax errors"
          echo "   โข Missing dependencies in build context"
          echo "   โข Docker Hub authentication issues"
          echo "   โข Network or timeout problems"
          echo "   โข Insufficient disk space"
          echo "   โข External repository not accessible"
          echo ""
          echo "๐ Debug steps:"
          echo "   1. Check Dockerfile at: ${{ inputs.dockerfile_path }}"
          echo "   2. Verify build context: ${{ inputs.build_context }}"
          echo "   3. Review Docker Hub credentials"
          if [[ -n "${{ inputs.external_repo }}" ]]; then
            echo "   4. Verify external repo access: ${{ inputs.external_repo }}"
            echo "   5. Check EXTERNAL_REPO_TOKEN if repo is private"
          fi
          echo "   6. Check workflow logs above for specific errors"
          echo ""
          echo "๐ Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          exit 1