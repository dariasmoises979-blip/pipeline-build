########################################
# ğŸ³ WORKFLOW REUSABLE: Build & Push Docker Image
# Construye y publica imÃ¡genes Docker con tags automÃ¡ticos
# basados en el entorno (pro, pre, staging) y commit SHA
########################################

name: Reusable Build & Push Docker

# ğŸ”§ Definir como workflow reusable con inputs configurables
on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag, ej: mi-app)'
        required: true
        type: string
      dockerhub_username:
        description: 'Usuario de Docker Hub (texto literal, no secret)'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/dev)'
        required: false
        type: string
        default: 'dev'
      dockerfile_path:
        description: 'Ruta al Dockerfile (relativo al contexto)'
        required: false
        type: string
        default: './Dockerfile'
      build_context:
        description: 'Directorio de contexto para el build'
        required: false
        type: string
        default: '.'
      additional_tags:
        description: 'Tags adicionales separados por coma (ej: v1.0.0,stable)'
        required: false
        type: string
        default: ''
    secrets:
      DOCKERHUB_TOKEN:
        description: 'Token de autenticaciÃ³n de Docker Hub'
        required: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ³ JOB: BUILD & PUSH DOCKER IMAGE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker-build-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ PASO 1: CHECKOUT DEL CÃ“DIGO FUENTE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Clona el repositorio con todo el historial para tener
      # acceso completo a commits y tags
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ğŸ“š Obtiene todo el historial (necesario para tags y SHA)
          # Si es un PR, usa el SHA del head del PR, sino usa el SHA actual
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Debug credentials
        run: |
            echo "Username: ${{ inputs.dockerhub_username }}"
            echo "Token exists: ${{ secrets.DOCKERHUB_TOKEN != '' }}"
            echo "Token length: $(echo '${{ secrets.DOCKERHUB_TOKEN }}' | wc -c)"
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ·ï¸ PASO 2: GENERAR TAGS DINÃMICOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Crea tags basados en: entorno, SHA del commit, rama, etc.
      - name: Generate dynamic tags
        id: tags
        run: |
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Variables bÃ¡sicas del contexto
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ENVIRONMENT="${{ inputs.environment }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"  # Primeros 7 caracteres del SHA
          BRANCH_NAME="${{ github.ref_name }}"
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Construir array de tags
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          TAGS=()
          
          # Tag 1: Entorno (pro, pre, staging, dev)
          TAGS+=("${ENVIRONMENT}")
          
          # Tag 2: Entorno + SHA corto (ej: pro-a1b2c3d)
          TAGS+=("${ENVIRONMENT}-${SHORT_SHA}")
          
          # Tag 3: SHA completo (ej: a1b2c3d4e5f6g7h8...)
          TAGS+=("${COMMIT_SHA}")
          
          # Tag 4: SHA corto (ej: a1b2c3d)
          TAGS+=("${SHORT_SHA}")
          
          # Tag 5: Si es la rama principal, aÃ±adir "latest"
          if [[ "${BRANCH_NAME}" == "main" || "${BRANCH_NAME}" == "master" ]]; then
            TAGS+=("latest")
          fi
          
          # Tag 6: Rama + SHA (ej: develop-a1b2c3d)
          # Reemplazar '/' por '-' en el nombre de la rama
          SAFE_BRANCH_NAME=$(echo "${BRANCH_NAME}" | sed 's/\//-/g')
          TAGS+=("${SAFE_BRANCH_NAME}-${SHORT_SHA}")
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # AÃ±adir tags adicionales si se proporcionaron
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [[ -n "${{ inputs.additional_tags }}" ]]; then
            IFS=',' read -ra EXTRA_TAGS <<< "${{ inputs.additional_tags }}"
            for tag in "${EXTRA_TAGS[@]}"; do
              # Eliminar espacios en blanco
              tag=$(echo "${tag}" | xargs)
              if [[ -n "${tag}" ]]; then
                TAGS+=("${tag}")
              fi
            done
          fi
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Formatear tags para Docker (username/image:tag)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          DOCKER_TAGS=""
          for tag in "${TAGS[@]}"; do
            DOCKER_TAGS="${DOCKER_TAGS}${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${tag},"
          done
          # Eliminar la Ãºltima coma
          DOCKER_TAGS="${DOCKER_TAGS%,}"
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Guardar tags para usar en steps posteriores
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "tags=${DOCKER_TAGS}" >> $GITHUB_OUTPUT
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Log: Mostrar todos los tags generados
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ·ï¸  TAGS GENERADOS PARA LA IMAGEN DOCKER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Imagen base: ${{ inputs.docker_image }}"
          echo "ğŸŒ Entorno: ${ENVIRONMENT}"
          echo "ğŸ”— Commit SHA: ${COMMIT_SHA}"
          echo "ğŸŒ¿ Rama: ${BRANCH_NAME}"
          echo ""
          echo "ğŸ“‹ Lista de tags:"
          for tag in "${TAGS[@]}"; do
            echo "   â€¢ ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${tag}"
          done
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš™ï¸ PASO 3: CONFIGURAR DOCKER BUILDX
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Docker Buildx permite builds mÃ¡s eficientes con cache
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container  # ğŸš€ Evita errores de cache y mejora performance

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 4: LOGIN EN DOCKER HUB
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Autentica con Docker Hub para poder hacer push de imÃ¡genes
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true  # ğŸ”’ Logout automÃ¡tico al finalizar (seguridad)

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ—ï¸ PASO 5: BUILD & PUSH DE LA IMAGEN DOCKER
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Construye la imagen y la sube a Docker Hub con todos los tags
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.build_context }}      # ğŸ“‚ Directorio de contexto
          file: ${{ inputs.dockerfile_path }}        # ğŸ“„ Ruta al Dockerfile
          push: true                                 # â¬†ï¸ Hacer push a Docker Hub
          tags: ${{ steps.tags.outputs.tags }}      # ğŸ·ï¸ Todos los tags generados
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Cache de GitHub Actions para acelerar builds
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          cache-from: type=gha                       # ğŸ“¥ Usar cache de builds previos
          cache-to: type=gha,mode=max               # ğŸ“¤ Guardar cache para futuros builds
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Build args opcionales (se pueden pasar variables)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ inputs.environment }}-${{ github.sha }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 6: REPORTE DE BUILD EXITOSO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Muestra informaciÃ³n detallada del build completado
      - name: Build Summary Report
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DOCKER IMAGE BUILD & PUSH SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Docker Hub: https://hub.docker.com/r/${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}"
          echo "ğŸ“¦ Image Name: ${{ inputs.docker_image }}"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ”— Commit SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ• Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ“‹ Pull Commands:"
          echo "   docker pull ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.environment }}"
          echo "   docker pull ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${GITHUB_SHA:0:7}"
          echo ""
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âŒ PASO 7: MANEJO DE ERRORES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Si el build falla, proporciona informaciÃ³n Ãºtil para debugging
      - name: Build Failure Report
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DOCKER BUILD FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  Possible reasons:"
          echo "   â€¢ Dockerfile syntax errors"
          echo "   â€¢ Missing dependencies in build context"
          echo "   â€¢ Docker Hub authentication issues"
          echo "   â€¢ Network or timeout problems"
          echo "   â€¢ Insufficient disk space"
          echo ""
          echo "ğŸ” Debug steps:"
          echo "   1. Check Dockerfile at: ${{ inputs.dockerfile_path }}"
          echo "   2. Verify build context: ${{ inputs.build_context }}"
          echo "   3. Review Docker Hub credentials"
          echo "   4. Check workflow logs above for specific errors"
          echo ""
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1