########################################
# ğŸš€ MAIN PIPELINE - Build & Deploy to GCP Artifact Registry
# Pipeline principal reusable que construye imÃ¡genes Docker
# y las despliega en Google Artifact Registry con anÃ¡lisis de seguridad
########################################

name: Main Pipeline (Reusable - GCP)

on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag)'
        required: false
        type: string
        default: 'mi-aplicacion'
      
      gcp_project_id:
        description: "ID del proyecto de GCP"
        required: true
        type: string
      
      gcp_region:
        description: "RegiÃ³n de GCP (ej: us-central1, europe-west1)"
        required: true
        type: string
      
      artifact_registry:
        description: 'Nombre del repositorio de Artifact Registry'
        required: true
        type: string
      
      environment:
        description: 'Entorno de despliegue (pro/pre/staging/dev)'
        required: false
        type: string
        default: 'dev'
      
      external_repo:
        description: 'Repositorio externo para clonar'
        required: false
        type: string
        default: ''
      
      external_repo_ref:
        description: 'Branch/tag del repositorio externo'
        required: false
        type: string
        default: 'main'
      
      external_repo_path:
        description: 'Ruta donde clonar el repo externo'
        required: false
        type: string
        default: './external'
      
      dockerfile_path:
        description: 'Ruta al Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      
      build_context:
        description: 'Contexto para el build de Docker'
        required: false
        type: string
        default: '.'
      
      additional_tags:
        description: 'Tags adicionales separados por coma'
        required: false
        type: string
        default: ''
      
      enable_security_scan:
        description: 'Habilitar escaneo de seguridad con Trivy'
        required: false
        type: boolean
        default: true
      
      enable_sonar:
        description: 'Habilitar anÃ¡lisis de SonarCloud'
        required: false
        type: boolean
        default: false
      
      sonar_args:
        description: 'Argumentos adicionales para SonarCloud (formato: -Dsonar.key=value)'
        required: false
        type: string
        default: ''
      
      projectBaseDir:
        description: 'Directorio base del proyecto para SonarCloud'
        required: false
        type: string
        default: '.'

    secrets:
      GCP_SA_KEY:
        required: true
        description: "Service Account Key de GCP en formato JSON"
      
      EXTERNAL_REPO_TOKEN:
        required: false
        description: 'Token para acceder al repositorio externo'
      
      SONAR_TOKEN:
        required: false
        description: 'Token de SonarCloud'

    outputs:
      image_tag:
        description: 'Tag principal generado'
        value: ${{ jobs.build-and-deploy.outputs.image_tag }}
      full_image:
        description: 'Imagen completa con tag'
        value: ${{ jobs.build-and-deploy.outputs.full_image }}
      short_sha:
        description: 'SHA corto del commit'
        value: ${{ jobs.build-and-deploy.outputs.short_sha }}

permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.tags.outputs.primary_tag }}
      full_image: ${{ steps.tags.outputs.full_image }}
      short_sha: ${{ steps.tags.outputs.short_sha }}
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ CHECKOUT DEL REPOSITORIO ACTUAL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Checkout repositorio actual
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ CHECKOUT DEL REPOSITORIO EXTERNO (OPCIONAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”„ Clonar el repositorio externo (app)
        if: inputs.external_repo != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.external_repo }}
          ref: ${{ inputs.external_repo_ref }}
          path: ${{ inputs.external_repo_path }}
          fetch-depth: 0
          token: ${{ secrets.EXTERNAL_REPO_TOKEN || github.token }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” AUTENTICACIÃ“N CON GCP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš™ï¸ CONFIGURAR GCLOUD CLI
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ inputs.gcp_project_id }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” VERIFICAR ESTRUCTURA DE ARCHIVOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Verify file structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ FILE STRUCTURE VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Current directory:"
          pwd
          echo ""
          echo "ğŸ“‹ Directory listing:"
          ls -la
          echo ""
          if [[ -n "${{ inputs.external_repo }}" ]]; then
            echo "ğŸ“¦ External repo directory (${{ inputs.external_repo_path }}):"
            ls -la ${{ inputs.external_repo_path }} || echo "âŒ Directory not found"
            echo ""
          fi
          echo "ğŸ” Build context (${{ inputs.build_context }}):"
          ls -la ${{ inputs.build_context }} || echo "âŒ Directory not found"
          echo ""
          echo "ğŸ“„ Dockerfile location (${{ inputs.dockerfile_path }}):"
          ls -la ${{ inputs.dockerfile_path }} || echo "âŒ File not found"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ·ï¸ GENERAR TAGS DINÃMICOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ·ï¸ Generate dynamic tags
        id: tags
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Base URL del Artifact Registry
          REGISTRY_URL="${{ inputs.gcp_region }}-docker.pkg.dev"
          IMAGE_BASE="${REGISTRY_URL}/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}"
          
          # TAG PRINCIPAL (formato: environment-shortsha)
          PRIMARY_TAG="${ENVIRONMENT}-${SHORT_SHA}"
          
          TAGS=()
          TAGS+=("${PRIMARY_TAG}")           # dev-abc1234 (PRINCIPAL)
          TAGS+=("${ENVIRONMENT}")           # dev
          
          if [[ "${BRANCH_NAME}" == "main" || "${BRANCH_NAME}" == "master" ]]; then
            TAGS+=("latest")
          fi
          
          SAFE_BRANCH_NAME=$(echo "${BRANCH_NAME}" | sed 's/\//-/g')
          TAGS+=("${SAFE_BRANCH_NAME}-${SHORT_SHA}")
          
          if [[ -n "${{ inputs.additional_tags }}" ]]; then
            IFS=',' read -ra EXTRA_TAGS <<< "${{ inputs.additional_tags }}"
            for tag in "${EXTRA_TAGS[@]}"; do
              tag=$(echo "${tag}" | xargs)
              if [[ -n "${tag}" ]]; then
                TAGS+=("${tag}")
              fi
            done
          fi
          
          # Construir string de tags para Docker
          DOCKER_TAGS=""
          for tag in "${TAGS[@]}"; do
            DOCKER_TAGS="${DOCKER_TAGS}${IMAGE_BASE}:${tag},"
          done
          DOCKER_TAGS="${DOCKER_TAGS%,}"
          
          # EXPORTAR OUTPUTS
          echo "tags=${DOCKER_TAGS}" >> $GITHUB_OUTPUT
          echo "primary_tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${IMAGE_BASE}:${PRIMARY_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_base=${IMAGE_BASE}" >> $GITHUB_OUTPUT
          
          # REPORTE DE TAGS
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ·ï¸  TAGS GENERADOS PARA LA IMAGEN DOCKER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Imagen: ${{ inputs.docker_image }}"
          echo "ğŸŒ Entorno: ${ENVIRONMENT}"
          echo "ğŸ”— Commit: ${SHORT_SHA}"
          echo "ğŸŒ¿ Rama: ${BRANCH_NAME}"
          echo ""
          echo "ğŸ¯ TAG PRINCIPAL: ${PRIMARY_TAG}"
          echo ""
          echo "ğŸ“‹ Todos los tags:"
          for tag in "${TAGS[@]}"; do
            echo "   â€¢ ${IMAGE_BASE}:${tag}"
          done
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” CONFIGURAR DOCKER PARA ARTIFACT REGISTRY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ inputs.gcp_region }}-docker.pkg.dev --quiet
          echo "âœ… Docker configured for GCP Artifact Registry"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ³ SETUP DOCKER BUILDX
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ—ï¸ BUILD & PUSH DOCKER IMAGE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ—ï¸ Build y Push Docker Image a GCP
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.build_context }}
          file: ${{ inputs.dockerfile_path }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ inputs.environment }}-${{ github.sha }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” SECURITY SCAN CON TRIVY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Security Scan con Trivy
        if: inputs.enable_security_scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.tags.outputs.full_image }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“¤ Upload Trivy results to GitHub Security
        if: inputs.enable_security_scan
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š SONARCLOUD SCAN (OPCIONAL)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š SonarCloud Scan
        if: inputs.enable_sonar
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: ${{ inputs.projectBaseDir }}
          args: ${{ inputs.sonar_args }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… RESUMEN DE BUILD
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Resumen de Build
        if: success()
        run: |
          echo "# ğŸ‰ Build Completado - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ Imagen Docker" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry**: \`${{ inputs.gcp_region }}-docker.pkg.dev\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Imagen completa**: \`${{ steps.tags.outputs.full_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag principal**: \`${{ steps.tags.outputs.primary_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SHA**: \`${{ steps.tags.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ inputs.external_repo }}" ]]; then
            echo "**Repo externo**: \`${{ inputs.external_repo }}@${{ inputs.external_repo_ref }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— GCP Console" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[Ver en Artifact Registry](https://console.cloud.google.com/artifacts/docker/${{ inputs.gcp_project_id }}/${{ inputs.gcp_region }}/${{ inputs.artifact_registry }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Pull Commands:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Configurar autenticaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "gcloud auth configure-docker ${{ inputs.gcp_region }}-docker.pkg.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pull de la imagen" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.tags.outputs.full_image }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.enable_security_scan }}" == "true" ]]; then
            echo "### ğŸ” Security Scan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… AnÃ¡lisis de seguridad con Trivy completado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ inputs.enable_sonar }}" == "true" ]]; then
            echo "### ğŸ“Š Code Quality" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… AnÃ¡lisis de SonarCloud completado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âŒ MANEJO DE ERRORES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âŒ Build Failure Report
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ BUILD FAILED - ${{ inputs.environment }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  Posibles causas:"
          echo "   â€¢ Errores en el Dockerfile"
          echo "   â€¢ Faltan dependencias en el contexto"
          echo "   â€¢ Problemas de autenticaciÃ³n con GCP"
          echo "   â€¢ Artifact Registry no existe o no estÃ¡ habilitado"
          echo "   â€¢ Service Account sin permisos suficientes"
          echo "   â€¢ Repositorio externo no accesible"
          echo ""
          echo "ğŸ” Pasos de debug:"
          echo "   1. Verificar Dockerfile: ${{ inputs.dockerfile_path }}"
          echo "   2. Verificar contexto: ${{ inputs.build_context }}"
          echo "   3. Verificar permisos del SA: 'Artifact Registry Writer'"
          echo "   4. Verificar API habilitada: Artifact Registry API"
          echo "   5. Verificar registry: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}"
          if [[ -n "${{ inputs.external_repo }}" ]]; then
            echo "   6. Verificar acceso: ${{ inputs.external_repo }}"
            echo "   7. Verificar EXTERNAL_REPO_TOKEN si es privado"
          fi
          echo ""
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“– EJEMPLO DE USO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# name: Deploy to Production
#
# on:
#   push:
#     branches: [main]
#
# jobs:
#   deploy:
#     uses: ./.github/workflows/main-pipeline.yml
#     with:
#       docker_image: mi-app
#       gcp_project_id: elite-ceremony-476307-s9
#       gcp_region: us-central1
#       artifact_registry: artifact_dariasmoises979
#       environment: production
#       enable_security_scan: true
#       enable_sonar: false
#     secrets:
#       GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•