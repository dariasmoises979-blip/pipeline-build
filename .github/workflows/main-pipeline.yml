########################################
# ðŸš€ PIPELINE QA - Con Modelo HÃ­brido
# Tests â†’ Build HÃ­brido (con security) â†’ AnÃ¡lisis Completo
########################################

name: QA Pipeline with Hybrid Security

on:
  push:
    branches:
      - integration
  pull_request:
    branches:
      - integration
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ§ª JOB 1: TESTS DE INTEGRACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  integration-tests:
    name: ðŸ§ª Tests de IntegraciÃ³n
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/integration.yml@main
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸŽ¯ JOB 2: BUILD HÃBRIDO CON SEGURIDAD (Multi-Environment)
  # Build â†’ Quick Scan â†’ Push â†’ Full Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-hybrid-security:
    name: ðŸŽ¯ Hybrid Build - ${{ matrix.environment }}
    needs: integration-tests
    strategy:
      matrix:
        environment: [pre, staging, pro]
      fail-fast: false  # ContinÃºa aunque falle un entorno
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-hybrid.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: ${{ matrix.environment }}
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app  
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH2_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“Š JOB 3: REPORTE CONSOLIDADO FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  final-consolidated-report:
    name: ðŸ“Š Reporte Consolidado
    needs: [integration-tests, build-hybrid-security]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Descargar todos los reportes de seguridad
        uses: actions/download-artifact@v4
        with:
          path: ./all-reports

      - name: ðŸ“Š Generar resumen ejecutivo
        run: |
          echo "# ðŸŽ¯ Resumen Ejecutivo del Pipeline QA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âœ… Estado de Jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests de IntegraciÃ³n | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Build HÃ­brido (pre) | $(echo '${{ toJSON(needs.build-hybrid-security.result) }}' | jq -r '. // "unknown"') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Build HÃ­brido (staging) | $(echo '${{ toJSON(needs.build-hybrid-security.result) }}' | jq -r '. // "unknown"') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Build HÃ­brido (pro) | $(echo '${{ toJSON(needs.build-hybrid-security.result) }}' | jq -r '. // "unknown"') |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ³ Analizar reportes de seguridad
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Resumen de Seguridad por Entorno" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for env in pre staging pro; do
            REPORT_FILE="./all-reports/security-reports-${env}/trivy-report-${env}.json"
            
            if [ -f "$REPORT_FILE" ]; then
              CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' $REPORT_FILE)
              HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' $REPORT_FILE)
              MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' $REPORT_FILE)
              
              echo "### ðŸ·ï¸ Entorno: \`$env\`" >> $GITHUB_STEP_SUMMARY
              echo "| Severidad | Cantidad |" >> $GITHUB_STEP_SUMMARY
              echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
              echo "| ðŸ”´ CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
              echo "| ðŸŸ  HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
              echo "| ðŸŸ¡ MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ðŸ·ï¸ Entorno: \`$env\`" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ No se encontrÃ³ reporte de seguridad" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: ðŸ“¦ Listar imÃ¡genes generadas
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ ImÃ¡genes Publicadas en DockerHub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Entorno | Imagen | Comando Pull |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| pre | \`dariasmoises979/mi-aplicacion:pre\` | \`docker pull dariasmoises979/mi-aplicacion:pre\` |" >> $GITHUB_STEP_SUMMARY
          echo "| staging | \`dariasmoises979/mi-aplicacion:staging\` | \`docker pull dariasmoises979/mi-aplicacion:staging\` |" >> $GITHUB_STEP_SUMMARY
          echo "| pro | \`dariasmoises979/mi-aplicacion:pro\` | \`docker pull dariasmoises979/mi-aplicacion:pro\` |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”— Enlaces Ãºtiles
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Enlaces Ãštiles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ [DockerHub Repository](https://hub.docker.com/r/dariasmoises979/mi-aplicacion)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” [Security Alerts](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ [Artifacts de este run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [Todos los workflows](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ‰ Mensaje final
        if: needs.build-hybrid-security.result == 'success'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Pipeline Completado Exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ Logros:" >> $GITHUB_STEP_SUMMARY
          echo