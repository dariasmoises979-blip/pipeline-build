########################################
# ğŸš€ WORKFLOW REUSABLE: GitOps Deployment
# Actualiza manifiestos YAML con nuevo tag de imagen
# y hace push para que ArgoCD detecte y despliegue
########################################

name: Reusable GitOps Deployment

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Target environment (dev, staging, pre, prod)'
      image_tag:
        required: true
        type: string
        description: 'Docker image tag to deploy (recibido del workflow de build)'
      dockerhub_username:
        required: true
        type: string
        description: 'Usuario de Docker Hub'
      docker_image:
        required: true
        type: string
        description: 'Nombre de la imagen Docker'
      manifests_path:
        required: false
        type: string
        default: 'k8s'
        description: 'Ruta donde estÃ¡n los manifiestos YAML (ej: k8s, manifests, deploy)'
      manifest_file_pattern:
        required: false
        type: string
        default: '*.yaml'
        description: 'PatrÃ³n de archivos a actualizar (ej: deployment.yaml, *.yml)'
      git_user_name:
        required: false
        type: string
        default: 'github-actions[bot]'
        description: 'Nombre del usuario Git para el commit'
      git_user_email:
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
        description: 'Email del usuario Git para el commit'
      commit_message_prefix:
        required: false
        type: string
        default: '[GitOps]'
        description: 'Prefijo para el mensaje del commit'
      requires_approval:
        required: false
        type: boolean
        default: false
        description: 'Si requiere aprobaciÃ³n manual (pre/prod)'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 1: MOSTRAR INFORMACIÃ“N DEL DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  show-deployment-info:
    name: ğŸ“¦ Deployment Information
    runs-on: ubuntu-latest
    steps:
      - name: Display Deployment Information
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ GITOPS DEPLOYMENT INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ·ï¸  Image Tag: ${{ inputs.image_tag }}"
          echo "ğŸ“¦ Docker Image: ${{ inputs.docker_image }}"
          echo "ğŸ‘¤ Docker Hub User: ${{ inputs.dockerhub_username }}"
          echo "ğŸ“‚ Manifests Path: ${{ inputs.manifests_path }}"
          echo "ğŸ“„ File Pattern: ${{ inputs.manifest_file_pattern }}"
          echo "ğŸ” Requires Approval: ${{ inputs.requires_approval }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— Triggered by: ${{ github.event_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Show Full Image Path
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ DOCKER IMAGE TO DEPLOY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Full Image:"
          echo "   ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo ""
          echo "ğŸ”— Docker Hub URL:"
          echo "   https://hub.docker.com/r/${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}/tags?name=${{ inputs.image_tag }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”„ JOB 2: ACTUALIZAR MANIFIESTOS (AUTOMÃTICO: DEV/STAGING)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests-auto:
    name: ğŸ”„ Update Manifests (${{ inputs.environment }})
    if: inputs.environment == 'dev' || inputs.environment == 'staging'
    needs: show-deployment-info
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Verify Manifests Directory
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ VERIFYING MANIFESTS STRUCTURE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ ! -d "${{ inputs.manifests_path }}/${{ inputs.environment }}" ]; then
            echo "âŒ Error: Directory ${{ inputs.manifests_path }}/${{ inputs.environment }} not found!"
            echo ""
            echo "ğŸ“‹ Available structure:"
            pwd
            ls -la ${{ inputs.manifests_path }} || echo "âŒ ${{ inputs.manifests_path }} directory not found"
            echo ""
            echo "ğŸ’¡ Expected structure:"
            echo "   ${{ inputs.manifests_path }}/"
            echo "   â”œâ”€â”€ dev/"
            echo "   â”œâ”€â”€ staging/"
            echo "   â”œâ”€â”€ pre/"
            echo "   â””â”€â”€ prod/"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          echo "âœ… Directory found: ${{ inputs.manifests_path }}/${{ inputs.environment }}"
          echo ""
          echo "ğŸ“‹ Files in directory:"
          ls -la ${{ inputs.manifests_path }}/${{ inputs.environment }}
          pwd
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Update Image Tag in Manifests
        id: update
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ UPDATING IMAGE TAGS IN MANIFESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MANIFESTS_DIR="${{ inputs.manifests_path }}/${{ inputs.environment }}"
          NEW_IMAGE="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          IMAGE_NAME="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}"
          UPDATED_FILES=""
          CHANGES_MADE=false
          
          echo "ğŸ” Searching for YAML files matching: ${{ inputs.manifest_file_pattern }}"
          echo "ğŸ“‚ In directory: ${MANIFESTS_DIR}"
          echo "ğŸ¯ Image to update: ${IMAGE_NAME}"
          echo "ğŸ·ï¸  New tag: ${{ inputs.image_tag }}"
          echo ""
          
          # Buscar archivos YAML que contengan referencias a la imagen
          for file in ${MANIFESTS_DIR}/${{ inputs.manifest_file_pattern }}; do
            if [ -f "$file" ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“„ Processing: $(basename $file)"
              
              # Verificar si el archivo contiene la imagen
              if grep -q "${IMAGE_NAME}" "$file"; then
                echo "   âœ… Image reference found"
                
                # Mostrar lÃ­nea actual
                echo "   ğŸ“‹ Current image line(s):"
                grep "${IMAGE_NAME}" "$file" | sed 's/^/      /'
                
                # Actualizar el tag usando sed
                # Busca patrones como: image: user/image:old-tag
                sed -i.bak "s|image: ${IMAGE_NAME}:[^[:space:]]*|image: ${NEW_IMAGE}|g" "$file"
                
                # TambiÃ©n buscar patrones sin 'image:' explÃ­cito (para valores en values.yaml)
                sed -i.bak "s|${IMAGE_NAME}:[^[:space:]]*|${NEW_IMAGE}|g" "$file"
                
                # Verificar si hubo cambios
                if ! cmp -s "$file" "$file.bak"; then
                  echo "   âœ… File updated successfully"
                  echo "   ğŸ“‹ New image line(s):"
                  grep "${IMAGE_NAME}" "$file" | sed 's/^/      /'
                  UPDATED_FILES="${UPDATED_FILES}$(basename $file) "
                  CHANGES_MADE=true
                  rm "$file.bak"
                else
                  echo "   â„¹ï¸  No changes needed (already up to date)"
                  rm "$file.bak"
                fi
              else
                echo "   âš ï¸  Image reference not found in this file"
              fi
            fi
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$CHANGES_MADE" = true ]; then
            echo "âœ… MANIFEST UPDATE COMPLETED"
            echo "ğŸ“ Updated files: ${UPDATED_FILES}"
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "updated_files=${UPDATED_FILES}" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  NO CHANGES MADE"
            echo "   All manifests are already using tag: ${{ inputs.image_tag }}"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Configure Git
        if: steps.update.outputs.changes_made == 'true'
        run: |
          git config --global user.name "${{ inputs.git_user_name }}"
          git config --global user.email "${{ inputs.git_user_email }}"

      - name: Commit and Push Changes
        if: steps.update.outputs.changes_made == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ COMMITTING AND PUSHING CHANGES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Agregar cambios
          git add ${{ inputs.manifests_path }}/${{ inputs.environment }}
          
          # Crear mensaje de commit detallado
          COMMIT_MSG="${{ inputs.commit_message_prefix }} Update ${{ inputs.environment }} to ${{ inputs.image_tag }}

          Environment: ${{ inputs.environment }}
          Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}
          Tag: ${{ inputs.image_tag }}
          Updated files: ${{ steps.update.outputs.updated_files }}
          Triggered by: ${{ github.actor }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git commit -m "${COMMIT_MSG}"
          
          echo "âœ… Changes committed"
          echo ""
          echo "ğŸ“‹ Commit details:"
          git log -1 --stat
          echo ""
          
          # Push changes
          echo "â¬†ï¸  Pushing to remote..."
          git push
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CHANGES PUSHED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ ArgoCD will detect changes and deploy automatically"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸ“ Changes Made: ${{ steps.update.outputs.changes_made }}"
          if [ "${{ steps.update.outputs.changes_made }}" = "true" ]; then
            echo "ğŸ“„ Updated Files: ${{ steps.update.outputs.updated_files }}"
          fi
          echo "ğŸ‘¤ Executed by: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 3: ACTUALIZAR MANIFIESTOS (MANUAL: PRE/PROD)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests-manual:
    name: ğŸ” Update Manifests (${{ inputs.environment }}) - Requires Approval
    if: inputs.environment == 'pre' || inputs.environment == 'prod'
    needs: show-deployment-info
    runs-on: ubuntu-latest
    environment: 
      name: ${{ inputs.environment }}
    
    steps:
      - name: Manual Approval Notice
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  MANUAL APPROVAL REQUIRED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Image to deploy: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "â³ Waiting for approval through GitHub Environments..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Verify Manifests Directory
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ VERIFYING MANIFESTS STRUCTURE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ ! -d "${{ inputs.manifests_path }}/${{ inputs.environment }}" ]; then
            echo "âŒ Error: Directory ${{ inputs.manifests_path }}/${{ inputs.environment }} not found!"
            echo ""
            echo "ğŸ“‹ Available structure:"
            pwd
            ls -la ${{ inputs.manifests_path }} || echo "âŒ ${{ inputs.manifests_path }} directory not found"
            echo ""
            echo "ğŸ’¡ Expected structure:"
            echo "   ${{ inputs.manifests_path }}/"
            echo "   â”œâ”€â”€ dev/"
            echo "   â”œâ”€â”€ staging/"
            echo "   â”œâ”€â”€ pre/"
            echo "   â””â”€â”€ prod/"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          echo "âœ… Directory found: ${{ inputs.manifests_path }}/${{ inputs.environment }}"
          echo ""
          echo "ğŸ“‹ Files in directory:"
          pwd
          ls -la ${{ inputs.manifests_path }}/${{ inputs.environment }}
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Update Image Tag in Manifests
        id: update
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ UPDATING IMAGE TAGS IN MANIFESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MANIFESTS_DIR="${{ inputs.manifests_path }}/${{ inputs.environment }}"
          NEW_IMAGE="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          IMAGE_NAME="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}"
          UPDATED_FILES=""
          CHANGES_MADE=false
          
          echo "ğŸ” Searching for YAML files matching: ${{ inputs.manifest_file_pattern }}"
          echo "ğŸ“‚ In directory: ${MANIFESTS_DIR}"
          echo "ğŸ¯ Image to update: ${IMAGE_NAME}"
          echo "ğŸ·ï¸  New tag: ${{ inputs.image_tag }}"
          echo ""
          
          for file in ${MANIFESTS_DIR}/${{ inputs.manifest_file_pattern }}; do
            if [ -f "$file" ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“„ Processing: $(basename $file)"
              
              if grep -q "${IMAGE_NAME}" "$file"; then
                echo "   âœ… Image reference found"
                echo "   ğŸ“‹ Current image line(s):"
                grep "${IMAGE_NAME}" "$file" | sed 's/^/      /'
                
                sed -i.bak "s|image: ${IMAGE_NAME}:[^[:space:]]*|image: ${NEW_IMAGE}|g" "$file"
                sed -i.bak "s|${IMAGE_NAME}:[^[:space:]]*|${NEW_IMAGE}|g" "$file"
                
                if ! cmp -s "$file" "$file.bak"; then
                  echo "   âœ… File updated successfully"
                  echo "   ğŸ“‹ New image line(s):"
                  grep "${IMAGE_NAME}" "$file" | sed 's/^/      /'
                  UPDATED_FILES="${UPDATED_FILES}$(basename $file) "
                  CHANGES_MADE=true
                  rm "$file.bak"
                else
                  echo "   â„¹ï¸  No changes needed (already up to date)"
                  rm "$file.bak"
                fi
              else
                echo "   âš ï¸  Image reference not found in this file"
              fi
            fi
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$CHANGES_MADE" = true ]; then
            echo "âœ… MANIFEST UPDATE COMPLETED"
            echo "ğŸ“ Updated files: ${UPDATED_FILES}"
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "updated_files=${UPDATED_FILES}" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  NO CHANGES MADE"
            echo "   All manifests are already using tag: ${{ inputs.image_tag }}"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Configure Git
        if: steps.update.outputs.changes_made == 'true'
        run: |
          git config --global user.name "${{ inputs.git_user_name }}"
          git config --global user.email "${{ inputs.git_user_email }}"

      - name: Commit and Push Changes
        if: steps.update.outputs.changes_made == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ COMMITTING AND PUSHING CHANGES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          git add ${{ inputs.manifests_path }}/${{ inputs.environment }}
          
          COMMIT_MSG="${{ inputs.commit_message_prefix }} Update ${{ inputs.environment }} to ${{ inputs.image_tag }}

          Environment: ${{ inputs.environment }}
          Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}
          Tag: ${{ inputs.image_tag }}
          Updated files: ${{ steps.update.outputs.updated_files }}
          Approved by: ${{ github.actor }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git commit -m "${COMMIT_MSG}"
          
          echo "âœ… Changes committed"
          echo ""
          echo "ğŸ“‹ Commit details:"
          git log -1 --stat
          echo ""
          
          echo "â¬†ï¸  Pushing to remote..."
          git push
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CHANGES PUSHED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ ArgoCD will detect changes and deploy automatically"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸ“ Changes Made: ${{ steps.update.outputs.changes_made }}"
          if [ "${{ steps.update.outputs.changes_made }}" = "true" ]; then
            echo "ğŸ“„ Updated Files: ${{ steps.update.outputs.updated_files }}"
          fi
          echo "ğŸ‘¤ Approved by: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 4: NOTIFICACIÃ“N FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“Š Final Notification
    needs: [show-deployment-info, update-manifests-auto, update-manifests-manual]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Notification
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š GITOPS DEPLOYMENT COMPLETED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸ“‚ Manifests: ${{ inputs.manifests_path }}/${{ inputs.environment }}"
          echo "ğŸ‘¤ Executed by: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ”„ Next Steps:"
          echo "   1. âœ… Manifests updated in repository"
          echo "   2. ğŸ”„ ArgoCD will detect changes"
          echo "   3. ğŸš€ ArgoCD will sync and deploy automatically"
          echo ""
          echo "ğŸ”— Resources:"
          echo "   â€¢ Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "   â€¢ Docker Hub: https://hub.docker.com/r/${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}/tags"
          echo "   â€¢ Repository: ${{ github.server_url }}/${{ github.repository }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"