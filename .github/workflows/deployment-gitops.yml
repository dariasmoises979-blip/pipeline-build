########################################
# ğŸ”„ WORKFLOW REUSABLE: Update Kubernetes & Helm Manifests
# Actualiza imÃ¡genes Docker en manifiestos de Kubernetes y Helm
# con bÃºsqueda inteligente y validaciÃ³n robusta
# update-k8s-manifests.yml v2.0
########################################

name: Reusable Update K8s & Helm Manifests

on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin usuario/tag)'
        required: true
        type: string
      dockerhub_username:
        description: 'Usuario de Docker Hub'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/qa/devops)'
        required: true
        type: string
      image_tag:
        description: 'Tag de la imagen Docker a usar'
        required: true
        type: string
      project_name:
        description: 'Nombre del proyecto (debe coincidir con github.event.repository.name)'
        required: true
        type: string
      commit_message:
        description: 'Mensaje de commit personalizado'
        required: false
        type: string
        default: ''
      create_pr:
        description: 'Crear Pull Request en lugar de commit directo'
        required: false
        type: boolean
        default: false
      target_branch:
        description: 'Rama objetivo para el commit/PR'
        required: false
        type: string
        default: 'main'
      dry_run:
        description: 'Modo dry-run (solo mostrar cambios sin aplicar)'
        required: false
        type: boolean
        default: false
    secrets:
      GH_TOKEN:
        description: 'Token de GitHub con permisos de escritura'
        required: true
    
    outputs:
      commit_sha:
        description: 'SHA del commit generado'
        value: ${{ jobs.update-manifests.outputs.commit_sha }}
      pr_number:
        description: 'NÃºmero del PR creado (si create_pr=true)'
        value: ${{ jobs.update-manifests.outputs.pr_number }}
      files_updated:
        description: 'Lista de archivos actualizados'
        value: ${{ jobs.update-manifests.outputs.files_updated }}
      k8s_files_count:
        description: 'NÃºmero de archivos Kubernetes actualizados'
        value: ${{ jobs.update-manifests.outputs.k8s_files_count }}
      helm_files_count:
        description: 'NÃºmero de archivos Helm actualizados'
        value: ${{ jobs.update-manifests.outputs.helm_files_count }}

permissions:
  contents: write
  pull-requests: write

jobs:
  update-manifests:
    name: ğŸ”„ Update Manifests - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    outputs:
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      files_updated: ${{ steps.update_files.outputs.files_updated }}
      k8s_files_count: ${{ steps.update_files.outputs.k8s_files_count }}
      helm_files_count: ${{ steps.update_files.outputs.helm_files_count }}
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ PASO 1: CHECKOUT DEL REPOSITORIO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”§ PASO 2: INSTALAR DEPENDENCIAS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y yq jq
          echo "âœ… Dependencies installed: yq (YAML processor), jq (JSON processor)"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 3: VERIFICAR ESTRUCTURA DE DIRECTORIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Verify directory structure
        id: verify_structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ DIRECTORY STRUCTURE VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ENV="${{ inputs.environment }}"
          PROJECT="${{ inputs.project_name }}"
          
          # Rutas a verificar
          K8S_PATH="kubernetes/${ENV}/${PROJECT}"
          HELM_PATH="helm/override/${ENV}"
          
          echo "ğŸ” Searching for manifests in:"
          echo "   ğŸ“ Kubernetes: ${K8S_PATH}"
          echo "   ğŸ“ Helm: ${HELM_PATH}"
          echo ""
          
          K8S_EXISTS=false
          HELM_EXISTS=false
          
          # Verificar Kubernetes
          if [ -d "${K8S_PATH}" ]; then
            echo "âœ… Kubernetes path found: ${K8S_PATH}"
            echo "ğŸ“‹ Contents:"
            ls -la "${K8S_PATH}"
            K8S_EXISTS=true
          else
            echo "âš ï¸  Kubernetes path not found: ${K8S_PATH}"
          fi
          echo ""
          
          # Verificar Helm
          if [ -d "${HELM_PATH}" ]; then
            echo "âœ… Helm path found: ${HELM_PATH}"
            echo "ğŸ“‹ Contents:"
            ls -la "${HELM_PATH}"
            HELM_EXISTS=true
          else
            echo "âš ï¸  Helm path not found: ${HELM_PATH}"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Exportar paths y existencia
          echo "k8s_path=${K8S_PATH}" >> $GITHUB_OUTPUT
          echo "helm_path=${HELM_PATH}" >> $GITHUB_OUTPUT
          echo "k8s_exists=${K8S_EXISTS}" >> $GITHUB_OUTPUT
          echo "helm_exists=${HELM_EXISTS}" >> $GITHUB_OUTPUT
          
          # Validar que al menos uno existe
          if [[ "${K8S_EXISTS}" == "false" ]] && [[ "${HELM_EXISTS}" == "false" ]]; then
            echo "âŒ ERROR: Neither Kubernetes nor Helm paths exist!"
            echo "   Expected one of:"
            echo "   â€¢ ${K8S_PATH}"
            echo "   â€¢ ${HELM_PATH}"
            exit 1
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”„ PASO 4: ACTUALIZAR MANIFIESTOS DE KUBERNETES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”„ Update Kubernetes manifests
        id: update_k8s
        if: steps.verify_structure.outputs.k8s_exists == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ UPDATING KUBERNETES MANIFESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          K8S_PATH="${{ steps.verify_structure.outputs.k8s_path }}"
          NEW_IMAGE="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          DRY_RUN="${{ inputs.dry_run }}"
          
          echo "ğŸ³ New image: ${NEW_IMAGE}"
          echo "ğŸ“ K8s path: ${K8S_PATH}"
          echo "ğŸ” Dry-run mode: ${DRY_RUN}"
          echo ""
          
          K8S_FILES_UPDATED=()
          K8S_CHANGED=false
          
          # Buscar todos los archivos YAML recursivamente
          find "${K8S_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) | while read -r file; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Processing: ${file}"
            
            # Backup
            cp "${file}" "${file}.bak"
            
            # Buscar lÃ­neas con 'image:' que contengan nuestro usuario/imagen
            OLD_IMAGE=$(grep -E "^\s*image:\s*${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:" "${file}" 2>/dev/null | head -1 | sed 's/^[[:space:]]*image:[[:space:]]*//')
            
            if [ -n "${OLD_IMAGE}" ]; then
              echo "ğŸ” Found image line"
              echo "   Old: ${OLD_IMAGE}"
              echo "   New: ${NEW_IMAGE}"
              
              if [[ "${OLD_IMAGE}" == "${NEW_IMAGE}" ]]; then
                echo "â„¹ï¸  No change needed (same image)"
                rm "${file}.bak"
                continue
              fi
              
              if [[ "${DRY_RUN}" == "true" ]]; then
                echo "ğŸ” [DRY-RUN] Would update image"
                rm "${file}.bak"
                continue
              fi
              
              # Actualizar usando yq para mantener formato YAML
              yq eval -i "(..|select(has(\"image\"))|select(.image == \"${OLD_IMAGE}\")).image = \"${NEW_IMAGE}\"" "${file}"
              
              # Verificar cambio
              if ! diff -q "${file}" "${file}.bak" > /dev/null 2>&1; then
                echo "âœ… File updated successfully"
                K8S_FILES_UPDATED+=("${file}")
                K8S_CHANGED=true
                
                # Validar YAML
                if ! yq eval "${file}" > /dev/null 2>&1; then
                  echo "âŒ YAML validation failed! Rolling back..."
                  mv "${file}.bak" "${file}"
                  exit 1
                fi
              fi
              
              rm "${file}.bak"
            else
              echo "â„¹ï¸  No matching image found"
              rm "${file}.bak"
            fi
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Kubernetes Update Summary:"
          echo "   â€¢ Files processed: $(find "${K8S_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) | wc -l)"
          echo "   â€¢ Files updated: ${#K8S_FILES_UPDATED[@]}"
          echo ""
          
          # Exportar resultados
          echo "k8s_changed=${K8S_CHANGED}" >> $GITHUB_OUTPUT
          echo "k8s_files_count=${#K8S_FILES_UPDATED[@]}" >> $GITHUB_OUTPUT
          printf '%s\n' "${K8S_FILES_UPDATED[@]}" > /tmp/k8s_files.txt

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ¯ PASO 5: ACTUALIZAR HELM VALUES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¯ Update Helm values
        id: update_helm
        if: steps.verify_structure.outputs.helm_exists == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ UPDATING HELM VALUES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          HELM_PATH="${{ steps.verify_structure.outputs.helm_path }}"
          NEW_REPO="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}"
          NEW_TAG="${{ inputs.image_tag }}"
          DRY_RUN="${{ inputs.dry_run }}"
          
          echo "ğŸ³ New repository: ${NEW_REPO}"
          echo "ğŸ·ï¸  New tag: ${NEW_TAG}"
          echo "ğŸ“ Helm path: ${HELM_PATH}"
          echo "ğŸ” Dry-run mode: ${DRY_RUN}"
          echo ""
          
          HELM_FILES_UPDATED=()
          HELM_CHANGED=false
          
          # Buscar todos los archivos values recursivamente
          find "${HELM_PATH}" -type f \( -name "*values*.yaml" -o -name "*values*.yml" \) | while read -r file; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Processing: ${file}"
            
            # Backup
            cp "${file}" "${file}.bak"
            
            # Verificar si tiene estructura de imagen Helm
            HAS_IMAGE_REPO=$(yq eval '.image.repository' "${file}" 2>/dev/null)
            HAS_IMAGE_TAG=$(yq eval '.image.tag' "${file}" 2>/dev/null)
            
            if [[ "${HAS_IMAGE_REPO}" != "null" ]] && [[ "${HAS_IMAGE_TAG}" != "null" ]]; then
              OLD_REPO=$(yq eval '.image.repository' "${file}")
              OLD_TAG=$(yq eval '.image.tag' "${file}")
              
              echo "ğŸ” Found Helm image structure:"
              echo "   Old repository: ${OLD_REPO}"
              echo "   Old tag: ${OLD_TAG}"
              echo "   New repository: ${NEW_REPO}"
              echo "   New tag: ${NEW_TAG}"
              
              NEEDS_UPDATE=false
              
              if [[ "${OLD_REPO}" != "${NEW_REPO}" ]]; then
                NEEDS_UPDATE=true
              fi
              
              if [[ "${OLD_TAG}" != "${NEW_TAG}" ]]; then
                NEEDS_UPDATE=true
              fi
              
              if [[ "${NEEDS_UPDATE}" == "false" ]]; then
                echo "â„¹ï¸  No change needed (same image)"
                rm "${file}.bak"
                continue
              fi
              
              if [[ "${DRY_RUN}" == "true" ]]; then
                echo "ğŸ” [DRY-RUN] Would update:"
                echo "   repository: ${OLD_REPO} â†’ ${NEW_REPO}"
                echo "   tag: ${OLD_TAG} â†’ ${NEW_TAG}"
                rm "${file}.bak"
                continue
              fi
              
              # Actualizar repository y tag
              yq eval -i ".image.repository = \"${NEW_REPO}\"" "${file}"
              yq eval -i ".image.tag = \"${NEW_TAG}\"" "${file}"
              
              # Verificar cambio
              if ! diff -q "${file}" "${file}.bak" > /dev/null 2>&1; then
                echo "âœ… File updated successfully"
                HELM_FILES_UPDATED+=("${file}")
                HELM_CHANGED=true
                
                # Validar YAML
                if ! yq eval "${file}" > /dev/null 2>&1; then
                  echo "âŒ YAML validation failed! Rolling back..."
                  mv "${file}.bak" "${file}"
                  exit 1
                fi
              fi
              
              rm "${file}.bak"
            else
              echo "â„¹ï¸  No Helm image structure found (skipping)"
              rm "${file}.bak"
            fi
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Helm Update Summary:"
          echo "   â€¢ Files processed: $(find "${HELM_PATH}" -type f \( -name "*values*.yaml" -o -name "*values*.yml" \) 2>/dev/null | wc -l)"
          echo "   â€¢ Files updated: ${#HELM_FILES_UPDATED[@]}"
          echo ""
          
          # Exportar resultados
          echo "helm_changed=${HELM_CHANGED}" >> $GITHUB_OUTPUT
          echo "helm_files_count=${#HELM_FILES_UPDATED[@]}" >> $GITHUB_OUTPUT
          printf '%s\n' "${HELM_FILES_UPDATED[@]}" > /tmp/helm_files.txt

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 6: CONSOLIDAR RESULTADOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Consolidate results
        id: update_files
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CONSOLIDATING UPDATE RESULTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ALL_FILES=()
          
          # Agregar archivos K8s
          if [ -f /tmp/k8s_files.txt ]; then
            while IFS= read -r line; do
              ALL_FILES+=("${line}")
            done < /tmp/k8s_files.txt
          fi
          
          # Agregar archivos Helm
          if [ -f /tmp/helm_files.txt ]; then
            while IFS= read -r line; do
              ALL_FILES+=("${line}")
            done < /tmp/helm_files.txt
          fi
          
          K8S_CHANGED="${{ steps.update_k8s.outputs.k8s_changed }}"
          HELM_CHANGED="${{ steps.update_helm.outputs.helm_changed }}"
          K8S_COUNT="${{ steps.update_k8s.outputs.k8s_files_count }}"
          HELM_COUNT="${{ steps.update_helm.outputs.helm_files_count }}"
          
          # Determinar si hubo cambios
          CHANGED=false
          if [[ "${K8S_CHANGED}" == "true" ]] || [[ "${HELM_CHANGED}" == "true" ]]; then
            CHANGED=true
          fi
          
          echo "ğŸ“‹ Summary:"
          echo "   â€¢ Total files updated: ${#ALL_FILES[@]}"
          echo "   â€¢ Kubernetes files: ${K8S_COUNT:-0}"
          echo "   â€¢ Helm files: ${HELM_COUNT:-0}"
          echo "   â€¢ Changes detected: ${CHANGED}"
          echo ""
          
          if [ ${#ALL_FILES[@]} -gt 0 ]; then
            echo "ğŸ“„ Updated files:"
            for file in "${ALL_FILES[@]}"; do
              echo "   â€¢ ${file}"
            done
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Exportar outputs
          echo "changed=${CHANGED}" >> $GITHUB_OUTPUT
          echo "files_updated=${ALL_FILES[*]}" >> $GITHUB_OUTPUT
          echo "k8s_files_count=${K8S_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "helm_files_count=${HELM_COUNT:-0}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 7: MOSTRAR CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Show changes
        if: steps.update_files.outputs.changed == 'true' && inputs.dry_run == false
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š GIT DIFF - CHANGES PREVIEW"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ "${{ steps.verify_structure.outputs.k8s_exists }}" == "true" ]]; then
            echo ""
            echo "ğŸ”· Kubernetes Changes:"
            git diff ${{ steps.verify_structure.outputs.k8s_path }} || echo "No changes"
          fi
          
          if [[ "${{ steps.verify_structure.outputs.helm_exists }}" == "true" ]]; then
            echo ""
            echo "ğŸ¯ Helm Changes:"
            git diff ${{ steps.verify_structure.outputs.helm_path }} || echo "No changes"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”§ PASO 8: CONFIGURAR GIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Configure Git
        if: steps.update_files.outputs.changed == 'true' && inputs.dry_run == false
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ PASO 9A: COMMIT DIRECTO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¾ Commit changes
        id: commit
        if: steps.update_files.outputs.changed == 'true' && inputs.create_pr == false && inputs.dry_run == false
        run: |
          if [ -n "${{ inputs.commit_message }}" ]; then
            COMMIT_MSG="${{ inputs.commit_message }}"
          else
            COMMIT_MSG="ğŸ”„ Update manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ COMMITTING CHANGES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Commit message: ${COMMIT_MSG}"
          echo "ğŸŒ¿ Target branch: ${{ inputs.target_branch }}"
          echo ""
          
          # Agregar solo los archivos modificados
          if [[ "${{ steps.verify_structure.outputs.k8s_exists }}" == "true" ]]; then
            git add ${{ steps.verify_structure.outputs.k8s_path }}
          fi
          
          if [[ "${{ steps.verify_structure.outputs.helm_exists }}" == "true" ]]; then
            git add ${{ steps.verify_structure.outputs.helm_path }}
          fi
          
          git commit -m "${COMMIT_MSG}" \
            -m "Environment: ${{ inputs.environment }}" \
            -m "Project: ${{ inputs.project_name }}" \
            -m "Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}" \
            -m "Kubernetes files updated: ${{ steps.update_files.outputs.k8s_files_count }}" \
            -m "Helm files updated: ${{ steps.update_files.outputs.helm_files_count }}" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run ID: ${{ github.run_id }}"
          
          git push origin HEAD:${{ inputs.target_branch }}
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Changes committed and pushed successfully"
          echo "ğŸ”— Commit SHA: ${COMMIT_SHA}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”€ PASO 9B: CREAR PULL REQUEST
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”€ Create Pull Request
        id: create_pr
        if: steps.update_files.outputs.changed == 'true' && inputs.create_pr == true && inputs.dry_run == false
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: |
            ğŸ”„ Update K8s & Helm manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}
            
            Environment: ${{ inputs.environment }}
            Project: ${{ inputs.project_name }}
            Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}
            K8s files: ${{ steps.update_files.outputs.k8s_files_count }}
            Helm files: ${{ steps.update_files.outputs.helm_files_count }}
          branch: manifests-update-${{ inputs.environment }}-${{ github.run_id }}
          delete-branch: true
          base: ${{ inputs.target_branch }}
          title: "ğŸ”„ Update Manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}"
          body: |
            ## ğŸ”„ Kubernetes & Helm Manifests Update
            
            This PR updates both Kubernetes and Helm manifests with the new Docker image.
            
            ### ğŸ“‹ Details
            - **Environment**: `${{ inputs.environment }}`
            - **Project**: `${{ inputs.project_name }}`
            - **New Image**: `${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}`
            - **K8s Files Updated**: ${{ steps.update_files.outputs.k8s_files_count }}
            - **Helm Files Updated**: ${{ steps.update_files.outputs.helm_files_count }}
            - **Triggered by**: @${{ github.actor }}
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ“‚ Paths Updated
            ${{ steps.verify_structure.outputs.k8s_exists == 'true' && format('- ğŸ”· Kubernetes: `{0}`', steps.verify_structure.outputs.k8s_path) || '' }}
            ${{ steps.verify_structure.outputs.helm_exists == 'true' && format('- ğŸ¯ Helm: `{0}`', steps.verify_structure.outputs.helm_path) || '' }}
            
            ### ğŸ¤– Automated Changes
            This PR was automatically generated by the CI/CD pipeline after a successful build.
            All manifests have been validated for YAML syntax.
            
            ---
            
            Please review and merge to apply the changes to the `${{ inputs.target_branch }}` branch.
          labels: |
            automated
            manifests-update
            ${{ inputs.environment }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 10: RESUMEN FINAL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Summary Report
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š MANIFESTS UPDATE SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Project: ${{ inputs.project_name }}"
          echo "ğŸ³ New Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸŒ¿ Target Branch: ${{ inputs.target_branch }}"
          echo "ğŸ” Dry-run Mode: ${{ inputs.dry_run }}"
          echo ""
          
          if [ "${{ steps.update_files.outputs.changed }}" = "true" ]; then
            echo "âœ… Status: Changes detected"
            echo ""
            echo "ğŸ“Š Files Updated:"
            echo "   â€¢ Kubernetes: $