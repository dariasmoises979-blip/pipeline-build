########################################
# ğŸš€ WORKFLOW REUSABLE: GitOps Deployment (GCP Artifact Registry) - FLEXIBLE
# Orchestrador principal para despliegues GitOps
# Actualiza manifiestos de Kubernetes y Helm
# deployment-gitops.yml v3.2 - FLEXIBLE IMAGE MATCHING
########################################

name: Reusable GitOps Deployment (GCP)

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Nombre del proyecto (coincide con github.event.repository.name)'
        required: true
        type: string
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag)'
        required: true
        type: string
      gcp_project_id:
        description: 'ID del proyecto de GCP'
        required: true
        type: string
      gcp_region:
        description: 'RegiÃ³n de GCP donde estÃ¡ el Artifact Registry (ej: europe-west1)'
        required: true
        type: string
      artifact_registry:
        description: 'Nombre del repositorio de Artifact Registry'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/qa/devops)'
        required: true
        type: string
      image_tag:
        description: 'Tag de la imagen Docker a usar'
        required: true
        type: string
      target_branch:
        description: 'Rama objetivo para el commit'
        required: false
        type: string
        default: 'main'
    secrets:
      GH_TOKEN:
        description: 'Token de GitHub con permisos de escritura'
        required: true
    
    outputs:
      commit_sha:
        description: 'SHA del commit generado'
        value: ${{ jobs.gitops-deployment.outputs.commit_sha }}
      files_updated:
        description: 'Lista de archivos actualizados'
        value: ${{ jobs.gitops-deployment.outputs.files_updated }}
      k8s_files_count:
        description: 'NÃºmero de archivos Kubernetes actualizados'
        value: ${{ jobs.gitops-deployment.outputs.k8s_files_count }}
      helm_files_count:
        description: 'NÃºmero de archivos Helm actualizados'
        value: ${{ jobs.gitops-deployment.outputs.helm_files_count }}
      deployment_status:
        description: 'Estado del deployment (success/failed/skipped)'
        value: ${{ jobs.gitops-deployment.outputs.deployment_status }}

permissions:
  contents: write
  pull-requests: write

jobs:
  gitops-deployment:
    name: ğŸš€ GitOps Deploy - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    outputs:
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
      files_updated: ${{ steps.deploy.outputs.files_updated }}
      k8s_files_count: ${{ steps.consolidate.outputs.k8s_files_count }}
      helm_files_count: ${{ steps.consolidate.outputs.helm_files_count }}
      deployment_status: ${{ steps.status.outputs.status }}
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 1: INFORMACIÃ“N DEL DEPLOYMENT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Deployment Information
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ GITOPS DEPLOYMENT ORCHESTRATION (GCP)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Project: ${{ inputs.project_name }}"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â˜ï¸  GCP Project: ${{ inputs.gcp_project_id }}"
          echo "ğŸ“ Registry: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}"
          echo "ğŸ³ Target Image: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸŒ¿ Target Branch: ${{ inputs.target_branch }}"
          echo ""
          echo "ğŸ“‚ Target Repository: dariasmoises979-blip/pipeline-build"
          echo "ğŸ“‚ Expected paths:"
          echo "   â€¢ Kubernetes: kubernetes/${{ inputs.environment }}/${{ inputs.project_name }}/"
          echo "   â€¢ Helm: helm/override/${{ inputs.environment }}/"
          echo ""
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ• Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ PASO 2: CHECKOUT DEL REPOSITORIO DE MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Checkout manifests repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          repository: dariasmoises979-blip/pipeline-build
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0
     
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”§ PASO 3: INSTALAR DEPENDENCIAS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Install dependencies
        run: |
          sudo apt-get update
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”§ PASO 3.5: CONFIGURAR GIT (ANTES DE CUALQUIER CAMBIO)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 4: VERIFICAR ESTRUCTURA
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Verify directory structure
        id: verify
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ DIRECTORY STRUCTURE VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Current directory: $(pwd)"
          echo ""
          
          K8S_PATH="kubernetes/${{ inputs.environment }}/${{ inputs.project_name }}"
          HELM_PATH="helm/override/${{ inputs.environment }}"
          
          K8S_EXISTS=false
          HELM_EXISTS=false
          
          if [ -d "${K8S_PATH}" ]; then
            echo "âœ… Kubernetes path found: ${K8S_PATH}"
            echo "   Files:"
            find "${K8S_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) -exec basename {} \; || echo "   (no YAML files)"
            K8S_EXISTS=true
          else
            echo "âš ï¸  Kubernetes path not found: ${K8S_PATH}"
          fi
          
          echo ""
          
          if [ -d "${HELM_PATH}" ]; then
            echo "âœ… Helm path found: ${HELM_PATH}"
            echo "   Files:"
            find "${HELM_PATH}" -type f \( -name "*values*.yaml" -o -name "*values*.yml" \) -exec basename {} \; || echo "   (no values files)"
            HELM_EXISTS=true
          else
            echo "âš ï¸  Helm path not found: ${HELM_PATH}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "k8s_path=${K8S_PATH}" >> $GITHUB_OUTPUT
          echo "helm_path=${HELM_PATH}" >> $GITHUB_OUTPUT
          echo "k8s_exists=${K8S_EXISTS}" >> $GITHUB_OUTPUT
          echo "helm_exists=${HELM_EXISTS}" >> $GITHUB_OUTPUT
          
          if [[ "${K8S_EXISTS}" == "false" ]] && [[ "${HELM_EXISTS}" == "false" ]]; then
            echo "âŒ ERROR: Neither Kubernetes nor Helm paths exist!"
            echo "   This might be a new project. Creating directory structure..."
            mkdir -p "${K8S_PATH}"
            echo "   Created: ${K8S_PATH}"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”„ PASO 5: ACTUALIZAR KUBERNETES (FLEXIBLE MATCHING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”„ Update Kubernetes manifests
        id: update_k8s
        if: steps.verify.outputs.k8s_exists == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ UPDATING KUBERNETES MANIFESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          K8S_PATH="${{ steps.verify.outputs.k8s_path }}"
          NEW_IMAGE="${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          IMAGE_NAME="${{ inputs.docker_image }}"
          
          echo "ğŸ¯ Target image: ${NEW_IMAGE}"
          echo "ğŸ” Looking for images containing: ${IMAGE_NAME}"
          echo ""
          
          # Usar archivo temporal para el contador
          TEMP_FILE=$(mktemp)
          echo "0" > "$TEMP_FILE"
          
          # Buscar todos los archivos YAML/YML
          find "${K8S_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) | while read -r file; do
            echo "ğŸ“ Processing: ${file}"
            
            # ESTRATEGIA FLEXIBLE: Buscar cualquier imagen que contenga el nombre de la imagen
            # Esto captura: dariasmoises979/mi-aplicacion, us-central1-docker.pkg.dev/.../mi-aplicacion, etc.
            OLD_IMAGE=$(grep -E "^\s*image:\s*.*${IMAGE_NAME}" "${file}" 2>/dev/null | head -1 | sed 's/^[[:space:]]*image:[[:space:]]*//' | tr -d '"' | tr -d "'")
            
            if [ -n "${OLD_IMAGE}" ]; then
              echo "   ğŸ“Œ Found: ${OLD_IMAGE}"
              
              if [[ "${OLD_IMAGE}" != "${NEW_IMAGE}" ]]; then
                echo "   âœ¨ Updating to: ${NEW_IMAGE}"
                
                # Crear backup
                cp "${file}" "${file}.bak"
                
                # Actualizar usando sed (mÃ¡s robusto que yq para este caso)
                sed -i "s|image:.*${IMAGE_NAME}.*|image: ${NEW_IMAGE}|g" "${file}"
                
                # Validar YAML
                if yq eval "${file}" > /dev/null 2>&1; then
                  echo "   âœ… Updated successfully"
                  rm "${file}.bak"
                  
                  # Incrementar contador
                  COUNT=$(cat "$TEMP_FILE")
                  echo $((COUNT + 1)) > "$TEMP_FILE"
                else
                  echo "   âŒ YAML validation failed, rolling back"
                  mv "${file}.bak" "${file}"
                fi
              else
                echo "   â­ï¸  Already up to date"
              fi
            else
              echo "   â­ï¸  No matching image found"
            fi
            echo ""
          done
          
          # Leer el contador final
          K8S_COUNT=$(cat "$TEMP_FILE")
          rm "$TEMP_FILE"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Total Kubernetes files updated: ${K8S_COUNT}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "k8s_count=${K8S_COUNT}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ¯ PASO 6: ACTUALIZAR HELM (FLEXIBLE MATCHING)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¯ Update Helm values
        id: update_helm
        if: steps.verify.outputs.helm_exists == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ UPDATING HELM VALUES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          HELM_PATH="${{ steps.verify.outputs.helm_path }}"
          NEW_REPO="${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}"
          NEW_TAG="${{ inputs.image_tag }}"
          IMAGE_NAME="${{ inputs.docker_image }}"
          
          echo "ğŸ¯ Target repository: ${NEW_REPO}"
          echo "ğŸ¯ Target tag: ${NEW_TAG}"
          echo "ğŸ” Looking for images containing: ${IMAGE_NAME}"
          echo ""
          
          # Usar archivo temporal para el contador
          TEMP_FILE=$(mktemp)
          echo "0" > "$TEMP_FILE"
          
          find "${HELM_PATH}" -type f \( -name "*values*.yaml" -o -name "*values*.yml" \) | while read -r file; do
            echo "ğŸ“ Processing: ${file}"
            
            # Verificar si existe configuraciÃ³n de imagen
            HAS_IMAGE=$(yq eval '.image.repository' "${file}" 2>/dev/null)
            
            if [[ "${HAS_IMAGE}" != "null" ]] && [[ -n "${HAS_IMAGE}" ]]; then
              OLD_REPO=$(yq eval '.image.repository' "${file}")
              OLD_TAG=$(yq eval '.image.tag' "${file}")
              
              echo "   ğŸ“Œ Current: ${OLD_REPO}:${OLD_TAG}"
              
              # Verificar si la imagen actual contiene el nombre que buscamos
              if [[ "${OLD_REPO}" == *"${IMAGE_NAME}"* ]]; then
                if [[ "${OLD_REPO}" != "${NEW_REPO}" ]] || [[ "${OLD_TAG}" != "${NEW_TAG}" ]]; then
                  echo "   âœ¨ Updating to: ${NEW_REPO}:${NEW_TAG}"
                  
                  # Crear backup
                  cp "${file}" "${file}.bak"
                  
                  # Actualizar repository y tag
                  yq eval -i ".image.repository = \"${NEW_REPO}\"" "${file}"
                  yq eval -i ".image.tag = \"${NEW_TAG}\"" "${file}"
                  
                  # Validar YAML
                  if yq eval "${file}" > /dev/null 2>&1; then
                    echo "   âœ… Updated successfully"
                    rm "${file}.bak"
                    
                    # Incrementar contador
                    COUNT=$(cat "$TEMP_FILE")
                    echo $((COUNT + 1)) > "$TEMP_FILE"
                  else
                    echo "   âŒ YAML validation failed, rolling back"
                    mv "${file}.bak" "${file}"
                  fi
                else
                  echo "   â­ï¸  Already up to date"
                fi
              else
                echo "   â­ï¸  Image name doesn't match, skipping"
              fi
            else
              echo "   â­ï¸  No image configuration found"
            fi
            echo ""
          done
          
          # Leer contador final
          HELM_COUNT=$(cat "$TEMP_FILE")
          rm "$TEMP_FILE"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Total Helm files updated: ${HELM_COUNT}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "helm_count=${HELM_COUNT}" >> $GITHUB_OUTPUT

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 7: CONSOLIDAR RESULTADOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Consolidate results
        id: consolidate
        run: |
          K8S_COUNT="${{ steps.update_k8s.outputs.k8s_count || '0' }}"
          HELM_COUNT="${{ steps.update_helm.outputs.helm_count || '0' }}"
          TOTAL=$((K8S_COUNT + HELM_COUNT))
          
          echo "k8s_files_count=${K8S_COUNT}" >> $GITHUB_OUTPUT
          echo "helm_files_count=${HELM_COUNT}" >> $GITHUB_OUTPUT
          echo "total_files=${TOTAL}" >> $GITHUB_OUTPUT
          
          # Verificar si Git detecta cambios
          echo ""
          echo "ğŸ” Checking for Git changes..."
          git status --short
          echo ""
          
          if git diff --quiet && git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No Git changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Git changes detected"
            echo ""
            echo "ğŸ“ Changed files:"
            git diff --name-only
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š SUMMARY: K8s=${K8S_COUNT}, Helm=${HELM_COUNT}, Total=${TOTAL}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ PASO 8: COMMIT Y PUSH
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¾ Commit and push changes
        id: commit
        if: steps.consolidate.outputs.changed == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ COMMITTING CHANGES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Agregar todos los cambios
          git add -A
          
          echo "ğŸ“ Changed files to commit:"
          git diff --cached --name-only
          echo ""
          
          # Crear commit
          git commit -m "ğŸ”„ Update manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}" \
            -m "Project: ${{ inputs.project_name }}" \
            -m "Image: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}" \
            -m "K8s files: ${{ steps.consolidate.outputs.k8s_files_count }}" \
            -m "Helm files: ${{ steps.consolidate.outputs.helm_files_count }}" \
            -m "" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Repository: ${{ github.repository }}"
          
          # Push con retry
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸš€ Pushing changes (attempt $((RETRY_COUNT + 1))/${MAX_RETRIES})..."
            
            if git push origin HEAD:${{ inputs.target_branch }}; then
              echo "âœ… Push successful!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸  Push failed, retrying in 5 seconds..."
                sleep 5
                git pull --rebase origin ${{ inputs.target_branch }}
              else
                echo "âŒ Push failed after ${MAX_RETRIES} attempts"
                exit 1
              fi
            fi
          done
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Changes committed and pushed successfully"
          echo "   Commit: ${COMMIT_SHA}"
          echo "   Branch: ${{ inputs.target_branch }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âš ï¸ PASO 8.5: DEBUG SI NO HAY CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âš ï¸ Debug - No changes detected
        if: steps.consolidate.outputs.changed == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  DEBUG: NO CHANGES WERE DETECTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Counters:"
          echo "   K8s files: ${{ steps.consolidate.outputs.k8s_files_count }}"
          echo "   Helm files: ${{ steps.consolidate.outputs.helm_files_count }}"
          echo ""
          echo "ğŸ“‚ Kubernetes directory content:"
          if [ -d "kubernetes/${{ inputs.environment }}/${{ inputs.project_name }}" ]; then
            find "kubernetes/${{ inputs.environment }}/${{ inputs.project_name }}" -type f -name "*.yaml" -o -name "*.yml" | while read f; do
              echo "   ğŸ“„ $f"
              echo "      Content:"
              grep -E "^\s*image:" "$f" || echo "      (no image field found)"
            done
          else
            echo "   âŒ Directory not found"
          fi
          echo ""
          echo "ğŸ“‚ Helm directory content:"
          if [ -d "helm/override/${{ inputs.environment }}" ]; then
            find "helm/override/${{ inputs.environment }}" -type f -name "*values*.yaml" | while read f; do
              echo "   ğŸ“„ $f"
              echo "      Repository:"
              yq eval '.image.repository' "$f" 2>/dev/null || echo "      (not found)"
              echo "      Tag:"
              yq eval '.image.tag' "$f" 2>/dev/null || echo "      (not found)"
            done
          else
            echo "   âŒ Directory not found"
          fi
          echo ""
          echo "ğŸ’¡ Target image: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸ’¡ Image name to match: ${{ inputs.docker_image }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… PASO 9: ESTADO FINAL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Set deployment status
        id: status
        if: always()
        run: |
          if [ "${{ steps.consolidate.outputs.changed }}" == "false" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes were needed"
          elif [ "${{ steps.commit.outcome }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Deployment completed successfully"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Deployment failed"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 10: OUTPUTS PARA EL JOB
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Export deployment outputs
        id: deploy
        if: always()
        run: |
          echo "commit_sha=${{ steps.commit.outputs.commit_sha || 'none' }}" >> $GITHUB_OUTPUT
          echo "k8s_files_count=${{ steps.consolidate.outputs.k8s_files_count }}" >> $GITHUB_OUTPUT
          echo "helm_files_count=${{ steps.consolidate.outputs.helm_files_count }}" >> $GITHUB_OUTPUT
          echo "files_updated=kubernetes+helm" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Final Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Project: ${{ inputs.project_name }}"
          echo "â˜ï¸  GCP Project: ${{ inputs.gcp_project_id }}"
          echo "ğŸ“ Registry: ${{ inputs.artifact_registry }}"
          echo "ğŸ³ Image: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo ""
          echo "ğŸ“Š Files Updated:"
          echo "   â€¢ Kubernetes: ${{ steps.consolidate.outputs.k8s_files_count }}"
          echo "   â€¢ Helm: ${{ steps.consolidate.outputs.helm_files_count }}"
          echo "   â€¢ Total: ${{ steps.consolidate.outputs.total_files }}"
          echo ""
          echo "ğŸ“Œ Status: ${{ steps.status.outputs.status }}"
          
          if [ "${{ steps.commit.outputs.commit_sha }}" != "" ] && [ "${{ steps.commit.outputs.commit_sha }}" != "none" ]; then
          echo "âœ… Commit: ${{ steps.commit.outputs.commit_sha }}"
          echo "ğŸ”— https://github.com/dariasmoises979-blip/pipeline-build"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"