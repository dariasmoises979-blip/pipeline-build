########################################
# ğŸš€ WORKFLOW REUSABLE: GitOps Deployment
# Actualiza manifiestos YAML en kubernetes/{environment}
# Compatible con estructura: kubernetes/pre, kubernetes/staging, kubernetes/pro
#deployment-gitops.yml
########################################

name: Reusable GitOps Deployment

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Target environment (pre, staging, pro)'
      image_tag:
        required: true
        type: string
        description: 'Docker image tag to deploy'
      dockerhub_username:
        required: true
        type: string
        description: 'Usuario de Docker Hub'
      docker_image:
        required: true
        type: string
        description: 'Nombre de la imagen Docker'
      manifests_path:
        required: false
        type: string
        default: 'kubernetes'
        description: 'Ruta base de manifiestos (default: kubernetes)'
      manifest_file_pattern:
        required: false
        type: string
        default: '*.yaml'
        description: 'PatrÃ³n de archivos a actualizar'
      git_user_name:
        required: false
        type: string
        default: 'github-actions[bot]'
      git_user_email:
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
      commit_message_prefix:
        required: false
        type: string
        default: '[GitOps]'
      requires_approval:
        required: false
        type: boolean
        default: false

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 1: INFORMACIÃ“N DEL DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  show-deployment-info:
    name: ğŸ“¦ Deployment Info
    runs-on: ubuntu-latest
    steps:
      - name: Display Information
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ GITOPS DEPLOYMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ·ï¸  Image Tag: ${{ inputs.image_tag }}"
          echo "ğŸ“¦ Docker Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}"
          echo "ğŸ“‚ Manifests Path: ${{ inputs.manifests_path }}/${{ inputs.environment }}"
          echo "ğŸ“„ File Pattern: ${{ inputs.manifest_file_pattern }}"
          echo "ğŸ” Requires Approval: ${{ inputs.requires_approval }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”„ JOB 2: ACTUALIZAR MANIFIESTOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests:
    name: ğŸ”„ Update Manifests
    needs: show-deployment-info
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Show Repository Structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ REPOSITORY STRUCTURE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Current directory: $(pwd)"
          echo ""
          echo "ğŸ“ Root structure:"
          ls -la
          echo ""
          if [ -d "${{ inputs.manifests_path }}" ]; then
            echo "âœ… Manifests directory found: ${{ inputs.manifests_path }}"
            echo ""
            echo "ğŸ“‹ Environments available:"
            ls -la ${{ inputs.manifests_path }}
          else
            echo "âŒ Manifests directory not found: ${{ inputs.manifests_path }}"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify Environment Directory
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” VERIFYING ENVIRONMENT DIRECTORY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          TARGET_DIR="${{ inputs.manifests_path }}/${{ inputs.environment }}"
          
          if [ ! -d "${TARGET_DIR}" ]; then
            echo "âŒ ERROR: Directory ${TARGET_DIR} not found!"
            echo ""
            echo "ğŸ“‹ Available structure:"
            ls -la ${{ inputs.manifests_path }} 2>/dev/null || echo "Base manifests directory not found"
            echo ""
            echo "ğŸ’¡ Expected: ${TARGET_DIR}"
            echo ""
            echo "ğŸ”§ Available environments:"
            find ${{ inputs.manifests_path }} -maxdepth 1 -type d 2>/dev/null || echo "No subdirectories found"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          echo "âœ… Environment directory found: ${TARGET_DIR}"
          echo ""
          echo "ğŸ“‹ Files in directory:"
          ls -la "${TARGET_DIR}"
          echo ""
          echo "ğŸ“„ YAML files:"
          find "${TARGET_DIR}" -name "${{ inputs.manifest_file_pattern }}" -type f || echo "No YAML files found"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Update Image Tags
        id: update
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ UPDATING IMAGE TAGS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MANIFESTS_DIR="${{ inputs.manifests_path }}/${{ inputs.environment }}"
          NEW_IMAGE="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          IMAGE_NAME="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}"
          UPDATED_FILES=""
          CHANGES_MADE=false
          
          echo "ğŸ¯ Target directory: ${MANIFESTS_DIR}"
          echo "ğŸ·ï¸  New image: ${NEW_IMAGE}"
          echo "ğŸ” Looking for image: ${IMAGE_NAME}"
          echo "ğŸ“„ File pattern: ${{ inputs.manifest_file_pattern }}"
          echo ""
          
          # Buscar recursivamente todos los archivos YAML en el directorio del ambiente
          while IFS= read -r -d '' file; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ Processing: ${file#${MANIFESTS_DIR}/}"
            
            # Verificar si contiene la imagen
            if grep -q "${IMAGE_NAME}" "$file"; then
              echo "   âœ… Image reference found"
              echo "   ğŸ“‹ Current image:"
              grep "${IMAGE_NAME}" "$file" | sed 's/^/      /'
              
              # Actualizar el tag
              # PatrÃ³n 1: image: user/image:tag
              sed -i.bak "s|image: ${IMAGE_NAME}:[^[:space:]\"']*|image: ${NEW_IMAGE}|g" "$file"
              # PatrÃ³n 2: image: "user/image:tag"
              sed -i.bak "s|image: \"${IMAGE_NAME}:[^\"]*\"|image: \"${NEW_IMAGE}\"|g" "$file"
              # PatrÃ³n 3: image: 'user/image:tag'
              sed -i.bak "s|image: '${IMAGE_NAME}:[^']*'|image: '${NEW_IMAGE}'|g" "$file"
              # PatrÃ³n 4: valor directo sin "image:" (para values.yaml)
              sed -i.bak "s|${IMAGE_NAME}:[^[:space:]\"']*|${NEW_IMAGE}|g" "$file"
              
              # Verificar si hubo cambios
              if ! cmp -s "$file" "$file.bak"; then
                echo "   âœ… Updated successfully"
                echo "   ğŸ“‹ New image:"
                grep "${IMAGE_NAME}" "$file" | sed 's/^/      /'
                UPDATED_FILES="${UPDATED_FILES}$(basename $file) "
                CHANGES_MADE=true
                rm "$file.bak"
              else
                echo "   â„¹ï¸  Already up to date"
                rm "$file.bak"
              fi
            else
              echo "   âš ï¸  No image reference found"
            fi
          done < <(find "${MANIFESTS_DIR}" -name "${{ inputs.manifest_file_pattern }}" -type f -print0)
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$CHANGES_MADE" = true ]; then
            echo "âœ… UPDATES COMPLETED"
            echo "ğŸ“ Updated files: ${UPDATED_FILES}"
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "updated_files=${UPDATED_FILES}" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  NO CHANGES NEEDED"
            echo "   All manifests already using: ${{ inputs.image_tag }}"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Show Git Diff
        if: steps.update.outputs.changes_made == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š GIT DIFF - CHANGES TO BE COMMITTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          git diff ${{ inputs.manifests_path }}/${{ inputs.environment }}
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Configure Git
        if: steps.update.outputs.changes_made == 'true'
        run: |
          git config --global user.name "${{ inputs.git_user_name }}"
          git config --global user.email "${{ inputs.git_user_email }}"

      - name: Commit and Push Changes
        if: steps.update.outputs.changes_made == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ COMMITTING AND PUSHING"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Add changes
          git add ${{ inputs.manifests_path }}/${{ inputs.environment }}
          
          # Create detailed commit message
          COMMIT_MSG="${{ inputs.commit_message_prefix }} Deploy ${{ inputs.environment }}: ${{ inputs.image_tag }}

          Environment: ${{ inputs.environment }}
          Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}
          Tag: ${{ inputs.image_tag }}
          Files: ${{ steps.update.outputs.updated_files }}
          
          Triggered by: ${{ github.actor }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git commit -m "${COMMIT_MSG}"
          
          echo "âœ… Changes committed"
          echo ""
          echo "ğŸ“‹ Commit details:"
          git log -1 --stat
          echo ""
          
          # Push
          echo "â¬†ï¸  Pushing to origin..."
          git push origin ${{ github.ref_name }}
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PUSHED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ ArgoCD will detect and sync changes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸ“‚ Path: ${{ inputs.manifests_path }}/${{ inputs.environment }}"
          echo "ğŸ“ Changes: ${{ steps.update.outputs.changes_made }}"
          if [ "${{ steps.update.outputs.changes_made }}" = "true" ]; then
            echo "ğŸ“„ Files: ${{ steps.update.outputs.updated_files }}"
          fi
          echo "ğŸ‘¤ By: ${{ github.actor }}"
          echo "ğŸ• Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 3: NOTIFICACIÃ“N FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“Š Notification
    needs: [show-deployment-info, update-manifests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Final Status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ GITOPS DEPLOYMENT COMPLETED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸ“‚ Location: ${{ inputs.manifests_path }}/${{ inputs.environment }}"
          echo "âœ… Status: ${{ needs.update-manifests.result }}"
          echo ""
          echo "ğŸ”„ Next: ArgoCD will sync the changes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"