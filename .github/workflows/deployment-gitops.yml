########################################
# ğŸš€ WORKFLOW REUSABLE: GitOps Deployment (GCP Artifact Registry)
# Orchestrador principal para despliegues GitOps
# Actualiza manifiestos de Kubernetes y Helm
# deployment-gitops.yml v3.0 - GCP ARTIFACT REGISTRY
########################################

name: Reusable GitOps Deployment (GCP)

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Nombre del proyecto (coincide con github.event.repository.name)'
        required: true
        type: string
      docker_image:
        description: 'Nombre de la imagen Docker (sin tag)'
        required: true
        type: string
      gcp_project_id:
        description: 'ID del proyecto de GCP'
        required: true
        type: string
      gcp_region:
        description: 'RegiÃ³n de GCP donde estÃ¡ el Artifact Registry (ej: europe-west1)'
        required: true
        type: string
      artifact_registry:
        description: 'Nombre del repositorio de Artifact Registry'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging/qa/devops)'
        required: true
        type: string
      image_tag:
        description: 'Tag de la imagen Docker a usar'
        required: true
        type: string
      target_branch:
        description: 'Rama objetivo para el commit'
        required: false
        type: string
        default: 'main'
    secrets:
      GH_TOKEN:
        description: 'Token de GitHub con permisos de escritura'
        required: true
    
    outputs:
      commit_sha:
        description: 'SHA del commit generado'
        value: ${{ jobs.gitops-deployment.outputs.commit_sha }}
      files_updated:
        description: 'Lista de archivos actualizados'
        value: ${{ jobs.gitops-deployment.outputs.files_updated }}
      k8s_files_count:
        description: 'NÃºmero de archivos Kubernetes actualizados'
        value: ${{ jobs.gitops-deployment.outputs.k8s_files_count }}
      helm_files_count:
        description: 'NÃºmero de archivos Helm actualizados'
        value: ${{ jobs.gitops-deployment.outputs.helm_files_count }}
      deployment_status:
        description: 'Estado del deployment (success/failed/skipped)'
        value: ${{ jobs.gitops-deployment.outputs.deployment_status }}

permissions:
  contents: write
  pull-requests: write

jobs:
  gitops-deployment:
    name: ğŸš€ GitOps Deploy - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    outputs:
      commit_sha: ${{ steps.deploy.outputs.commit_sha }}
      files_updated: ${{ steps.deploy.outputs.files_updated }}
      k8s_files_count: ${{ steps.deploy.outputs.k8s_files_count }}
      helm_files_count: ${{ steps.deploy.outputs.helm_files_count }}
      deployment_status: ${{ steps.status.outputs.status }}
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 1: INFORMACIÃ“N DEL DEPLOYMENT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Deployment Information
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ GITOPS DEPLOYMENT ORCHESTRATION (GCP)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Project: ${{ inputs.project_name }}"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â˜ï¸  GCP Project: ${{ inputs.gcp_project_id }}"
          echo "ğŸ“ Registry: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}"
          echo "ğŸ³ Image: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸŒ¿ Target Branch: ${{ inputs.target_branch }}"
          echo ""
          echo "ğŸ“‚ Target Repository: dariasmoises979-blip/pipeline-build"
          echo "ğŸ“‚ Expected paths:"
          echo "   â€¢ Kubernetes: kubernetes/${{ inputs.environment }}/${{ inputs.project_name }}/"
          echo "   â€¢ Helm: helm/override/${{ inputs.environment }}/"
          echo ""
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ• Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ PASO 2: CHECKOUT DEL REPOSITORIO DE MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Checkout manifests repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          repository: dariasmoises979-blip/pipeline-build
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0
     
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”§ PASO 3: INSTALAR DEPENDENCIAS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Install dependencies
        run: |
          sudo apt-get update
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 4: VERIFICAR ESTRUCTURA
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Verify directory structure
        id: verify
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ DIRECTORY STRUCTURE VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Current directory: $(pwd)"
          echo ""
          ls -la
          
          K8S_PATH="kubernetes/${{ inputs.environment }}/${{ inputs.project_name }}"
          HELM_PATH="helm/override/${{ inputs.environment }}"
          
          K8S_EXISTS=false
          HELM_EXISTS=false
          
          if [ -d "${K8S_PATH}" ]; then
            echo "âœ… Kubernetes path found: ${K8S_PATH}"
            echo "   Files:"
            ls -la "${K8S_PATH}" | grep -E '\.(yaml|yml)$' || echo "   (no YAML files)"
            K8S_EXISTS=true
          else
            echo "âš ï¸  Kubernetes path not found: ${K8S_PATH}"
          fi
          
          echo ""
          
          if [ -d "${HELM_PATH}" ]; then
            echo "âœ… Helm path found: ${HELM_PATH}"
            echo "   Files:"
            ls -la "${HELM_PATH}" | grep -E 'values.*\.(yaml|yml)$' || echo "   (no values files)"
            HELM_EXISTS=true
          else
            echo "âš ï¸  Helm path not found: ${HELM_PATH}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "k8s_path=${K8S_PATH}" >> $GITHUB_OUTPUT
          echo "helm_path=${HELM_PATH}" >> $GITHUB_OUTPUT
          echo "k8s_exists=${K8S_EXISTS}" >> $GITHUB_OUTPUT
          echo "helm_exists=${HELM_EXISTS}" >> $GITHUB_OUTPUT
          
          if [[ "${K8S_EXISTS}" == "false" ]] && [[ "${HELM_EXISTS}" == "false" ]]; then
            echo "âŒ ERROR: Neither Kubernetes nor Helm paths exist!"
            echo "   This might be a new project. Creating directory structure..."
            mkdir -p "${K8S_PATH}"
            echo "   Created: ${K8S_PATH}"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”„ PASO 5: ACTUALIZAR KUBERNETES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”„ Update Kubernetes manifests
        id: update_k8s
        if: steps.verify.outputs.k8s_exists == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ UPDATING KUBERNETES MANIFESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          K8S_PATH="${{ steps.verify.outputs.k8s_path }}"
          # Construir la imagen completa en formato GCP Artifact Registry
          NEW_IMAGE="${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          IMAGE_PREFIX="${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}"
          
          K8S_COUNT=0
          
          find "${K8S_PATH}" -type f \( -name "*.yaml" -o -name "*.yml" \) | while read -r file; do
            echo "ğŸ“ Processing: ${file}"
            
            # Buscar cualquier imagen que coincida con nuestro patrÃ³n (sin importar el tag)
            OLD_IMAGE=$(grep -E "^\s*image:\s*${IMAGE_PREFIX}:" "${file}" 2>/dev/null | head -1 | sed 's/^[[:space:]]*image:[[:space:]]*//')
            
            if [ -n "${OLD_IMAGE}" ] && [[ "${OLD_IMAGE}" != "${NEW_IMAGE}" ]]; then
              echo "   ğŸ“Œ Old: ${OLD_IMAGE}"
              echo "   âœ¨ New: ${NEW_IMAGE}"
              
              cp "${file}" "${file}.bak"
              yq eval -i "(..|select(has(\"image\"))|select(.image == \"${OLD_IMAGE}\")).image = \"${NEW_IMAGE}\"" "${file}"
              
              if yq eval "${file}" > /dev/null 2>&1; then
                echo "   âœ… Updated successfully"
                rm "${file}.bak"
                K8S_COUNT=$((K8S_COUNT + 1))
              else
                echo "   âŒ YAML validation failed, rolling back"
                mv "${file}.bak" "${file}"
              fi
            else
              echo "   â­ï¸  No changes needed"
            fi
          done
          
          echo ""
          echo "ğŸ“Š Total Kubernetes files updated: ${K8S_COUNT}"
          echo "k8s_count=${K8S_COUNT}" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ¯ PASO 6: ACTUALIZAR HELM
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¯ Update Helm values
        id: update_helm
        if: steps.verify.outputs.helm_exists == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ UPDATING HELM VALUES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          HELM_PATH="${{ steps.verify.outputs.helm_path }}"
          # Formato GCP: region-docker.pkg.dev/project-id/registry/image
          NEW_REPO="${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}"
          NEW_TAG="${{ inputs.image_tag }}"
          
          HELM_COUNT=0
          
          find "${HELM_PATH}" -type f \( -name "*values*.yaml" -o -name "*values*.yml" \) | while read -r file; do
            echo "ğŸ“ Processing: ${file}"
            
            HAS_IMAGE=$(yq eval '.image.repository' "${file}" 2>/dev/null)
            
            if [[ "${HAS_IMAGE}" != "null" ]]; then
              OLD_REPO=$(yq eval '.image.repository' "${file}")
              OLD_TAG=$(yq eval '.image.tag' "${file}")
              
              if [[ "${OLD_REPO}" != "${NEW_REPO}" ]] || [[ "${OLD_TAG}" != "${NEW_TAG}" ]]; then
                echo "   ğŸ“Œ Old: ${OLD_REPO}:${OLD_TAG}"
                echo "   âœ¨ New: ${NEW_REPO}:${NEW_TAG}"
                
                cp "${file}" "${file}.bak"
                yq eval -i ".image.repository = \"${NEW_REPO}\"" "${file}"
                yq eval -i ".image.tag = \"${NEW_TAG}\"" "${file}"
                
                if yq eval "${file}" > /dev/null 2>&1; then
                  echo "   âœ… Updated successfully"
                  rm "${file}.bak"
                  HELM_COUNT=$((HELM_COUNT + 1))
                else
                  echo "   âŒ YAML validation failed, rolling back"
                  mv "${file}.bak" "${file}"
                fi
              else
                echo "   â­ï¸  No changes needed"
              fi
            else
              echo "   â­ï¸  No image configuration found"
            fi
          done
          
          echo ""
          echo "ğŸ“Š Total Helm files updated: ${HELM_COUNT}"
          echo "helm_count=${HELM_COUNT}" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 7: CONSOLIDAR RESULTADOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Consolidate results
        id: consolidate
        run: |
          K8S_COUNT="${{ steps.update_k8s.outputs.k8s_count || '0' }}"
          HELM_COUNT="${{ steps.update_helm.outputs.helm_count || '0' }}"
          TOTAL=$((K8S_COUNT + HELM_COUNT))
          
          echo "k8s_files_count=${K8S_COUNT}" >> $GITHUB_OUTPUT
          echo "helm_files_count=${HELM_COUNT}" >> $GITHUB_OUTPUT
          echo "total_files=${TOTAL}" >> $GITHUB_OUTPUT
          
          if [ ${TOTAL} -gt 0 ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š SUMMARY: K8s=${K8S_COUNT}, Helm=${HELM_COUNT}, Total=${TOTAL}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ PASO 8: COMMIT CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ’¾ Commit changes directly
        id: commit
        if: steps.consolidate.outputs.changed == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ COMMITTING CHANGES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          git add .
          
          echo "ğŸ“ Changed files:"
          git diff --cached --name-only
          echo ""
          
          git commit -m "ğŸ”„ Update manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}" \
            -m "Project: ${{ inputs.project_name }}" \
            -m "Image: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}" \
            -m "K8s files: ${{ steps.consolidate.outputs.k8s_files_count }}" \
            -m "Helm files: ${{ steps.consolidate.outputs.helm_files_count }}" \
            -m "" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Repository: ${{ github.repository }}"
          
          git push origin HEAD:${{ inputs.target_branch }}
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          
          echo "âœ… Committed and pushed successfully"
          echo "   Commit: ${COMMIT_SHA}"
          echo "   Branch: ${{ inputs.target_branch }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # âœ… PASO 9: ESTADO FINAL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Set deployment status
        id: status
        run: |
          TOTAL="${{ steps.consolidate.outputs.total_files }}"
          
          if [ "${TOTAL}" -eq 0 ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes were needed"
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Deployment completed successfully"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 10: OUTPUTS PARA EL JOB
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Export deployment outputs
        id: deploy
        run: |
          echo "commit_sha=${{ steps.commit.outputs.commit_sha }}" >> $GITHUB_OUTPUT
          echo "k8s_files_count=${{ steps.consolidate.outputs.k8s_files_count }}" >> $GITHUB_OUTPUT
          echo "helm_files_count=${{ steps.consolidate.outputs.helm_files_count }}" >> $GITHUB_OUTPUT
          echo "files_updated=kubernetes+helm" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Final Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ“¦ Project: ${{ inputs.project_name }}"
          echo "â˜ï¸  GCP Project: ${{ inputs.gcp_project_id }}"
          echo "ğŸ“ Registry: ${{ inputs.artifact_registry }}"
          echo "ğŸ³ Image: ${{ inputs.gcp_region }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.artifact_registry }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo ""
          echo "ğŸ“Š Files Updated:"
          echo "   â€¢ Kubernetes: ${{ steps.consolidate.outputs.k8s_files_count }}"
          echo "   â€¢ Helm: ${{ steps.consolidate.outputs.helm_files_count }}"
          echo "   â€¢ Total: ${{ steps.consolidate.outputs.total_files }}"
          echo ""
          echo "ğŸ“Œ Status: ${{ steps.status.outputs.status }}"
          
          if [ "${{ steps.commit.outputs.commit_sha }}" != "" ]; then
            echo "âœ… Commit: ${{ steps.commit.outputs.commit_sha }}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"


# #############################################
# ğŸ“‹ EJEMPLO DE USO
# #############################################
#
# jobs:
#   deploy-to-staging:
#     uses: ./.github/workflows/deployment-gitops.yml
#     with:
#       project_name: mi-aplicacion
#       docker_image: mi-app
#       gcp_project_id: elite-ceremony-476307-s9
#       gcp_region: us-central1
#       artifact_registry: artifact_dariasmoises979
#       environment: staging
#       image_tag: staging-abc1234  # Tag generado por build-image.yml
#       target_branch: main
#     secrets:
#       GH_TOKEN: ${{ secrets.GH_TOKEN }}