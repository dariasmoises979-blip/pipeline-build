########################################
# ğŸ”„ WORKFLOW REUSABLE: Update Kubernetes Manifests
# Actualiza imÃ¡genes Docker en manifiestos de Kubernetes
# y sube los cambios al repositorio
# update-k8s-manifests.yml
########################################

name: Reusable Update K8s Manifests

# ğŸ”§ Definir como workflow reusable con inputs configurables
on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Nombre de la imagen Docker (sin usuario/tag)'
        required: true
        type: string
      dockerhub_username:
        description: 'Usuario de Docker Hub'
        required: true
        type: string
      environment:
        description: 'Entorno de deployment (pro/pre/staging)'
        required: true
        type: string
      image_tag:
        description: 'Tag de la imagen Docker a usar'
        required: true
        type: string
      manifests_path:
        description: 'Ruta a los manifiestos de Kubernetes (relativo al repo)'
        required: false
        type: string
        default: 'k8s/manifests'
      manifest_files:
        description: 'Archivos a actualizar (separados por coma, ej: deployment.yaml,statefulset.yaml)'
        required: false
        type: string
        default: 'deployment.yaml'
      commit_message:
        description: 'Mensaje de commit personalizado'
        required: false
        type: string
        default: ''
      create_pr:
        description: 'Crear Pull Request en lugar de commit directo'
        required: false
        type: boolean
        default: false
      target_branch:
        description: 'Rama objetivo para el commit/PR'
        required: false
        type: string
        default: 'main'
    secrets:
      GH_TOKEN:
        description: 'Token de GitHub con permisos de escritura'
        required: true
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ†• OUTPUTS: INFORMACIÃ“N DEL UPDATE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    outputs:
      commit_sha:
        description: 'SHA del commit generado'
        value: ${{ jobs.update-manifests.outputs.commit_sha }}
      pr_number:
        description: 'NÃºmero del PR creado (si create_pr=true)'
        value: ${{ jobs.update-manifests.outputs.pr_number }}
      files_updated:
        description: 'Lista de archivos actualizados'
        value: ${{ jobs.update-manifests.outputs.files_updated }}

permissions:
  contents: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”„ JOB: UPDATE KUBERNETES MANIFESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests:
    name: ğŸ”„ Update K8s Manifests - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    outputs:
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      files_updated: ${{ steps.update_files.outputs.files_updated }}
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“¥ PASO 1: CHECKOUT DEL REPOSITORIO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ” PASO 2: VERIFICAR ESTRUCTURA DE ARCHIVOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Verify manifests structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‚ KUBERNETES MANIFESTS VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Manifests path: ${{ inputs.manifests_path }}"
          echo ""
          
          if [ -d "${{ inputs.manifests_path }}" ]; then
            echo "âœ… Manifests directory exists"
            echo ""
            echo "ğŸ“‹ Directory contents:"
            ls -la ${{ inputs.manifests_path }}
          else
            echo "âŒ Manifests directory not found"
            echo "Creating directory..."
            mkdir -p ${{ inputs.manifests_path }}
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”„ PASO 3: ACTUALIZAR IMÃGENES EN MANIFIESTOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”„ Update image tags in manifests
        id: update_files
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ UPDATING KUBERNETES MANIFESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Variables
          NEW_IMAGE="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          MANIFESTS_PATH="${{ inputs.manifests_path }}"
          FILES="${{ inputs.manifest_files }}"
          
          echo "ğŸ³ New image: ${NEW_IMAGE}"
          echo "ğŸ“ Manifests path: ${MANIFESTS_PATH}"
          echo "ğŸ“„ Files to update: ${FILES}"
          echo ""
          
          # Convertir la lista de archivos separada por comas en array
          IFS=',' read -ra FILE_ARRAY <<< "${FILES}"
          
          UPDATED_FILES=()
          CHANGED=false
          
          for file in "${FILE_ARRAY[@]}"; do
            file=$(echo "${file}" | xargs)  # Trim whitespace
            FULL_PATH="${MANIFESTS_PATH}/${file}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Processing: ${file}"
            
            if [ ! -f "${FULL_PATH}" ]; then
              echo "âš ï¸  File not found: ${FULL_PATH}"
              continue
            fi
            
            # Hacer backup
            cp "${FULL_PATH}" "${FULL_PATH}.bak"
            
            # Buscar y reemplazar la imagen
            # PatrÃ³n: busca lÃ­neas con "image:" que contengan el nombre de la imagen
            OLD_IMAGE=$(grep -E "^\s*image:\s*${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:" "${FULL_PATH}" | head -1 | sed 's/^[[:space:]]*image:[[:space:]]*//')
            
            if [ -n "${OLD_IMAGE}" ]; then
              echo "ğŸ” Old image: ${OLD_IMAGE}"
              echo "ğŸ†• New image: ${NEW_IMAGE}"
              
              # Reemplazar la imagen
              sed -i "s|image: ${OLD_IMAGE}|image: ${NEW_IMAGE}|g" "${FULL_PATH}"
              
              # Verificar si hubo cambios
              if ! diff -q "${FULL_PATH}" "${FULL_PATH}.bak" > /dev/null; then
                echo "âœ… File updated successfully"
                UPDATED_FILES+=("${file}")
                CHANGED=true
              else
                echo "â„¹ï¸  No changes needed (same image)"
              fi
              
              rm "${FULL_PATH}.bak"
            else
              echo "âš ï¸  No image line found matching pattern"
              rm "${FULL_PATH}.bak"
            fi
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Update Summary:"
          echo "   â€¢ Files processed: ${#FILE_ARRAY[@]}"
          echo "   â€¢ Files updated: ${#UPDATED_FILES[@]}"
          echo "   â€¢ Changed: ${CHANGED}"
          echo ""
          
          if [ "${CHANGED}" = true ]; then
            echo "âœ… Changes detected and applied"
            echo "ğŸ“‹ Updated files:"
            for updated_file in "${UPDATED_FILES[@]}"; do
              echo "   â€¢ ${updated_file}"
            done
          else
            echo "â„¹ï¸  No changes needed"
          fi
          
          # Exportar outputs
          echo "changed=${CHANGED}" >> $GITHUB_OUTPUT
          echo "files_updated=${UPDATED_FILES[*]}" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 4: MOSTRAR CAMBIOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Show changes
        if: steps.update_files.outputs.changed == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š GIT DIFF - CHANGES PREVIEW"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          git diff ${{ inputs.manifests_path }}
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”§ PASO 5: CONFIGURAR GIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Configure Git
        if: steps.update_files.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ’¾ PASO 6A: COMMIT DIRECTO (SI NO SE CREA PR)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¾ Commit changes
        id: commit
        if: steps.update_files.outputs.changed == 'true' && inputs.create_pr == false
        run: |
          # Mensaje de commit personalizado o por defecto
          if [ -n "${{ inputs.commit_message }}" ]; then
            COMMIT_MSG="${{ inputs.commit_message }}"
          else
            COMMIT_MSG="ğŸ”„ Update K8s manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ COMMITTING CHANGES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Commit message: ${COMMIT_MSG}"
          echo "ğŸŒ¿ Target branch: ${{ inputs.target_branch }}"
          echo ""
          
          git add ${{ inputs.manifests_path }}
          git commit -m "${COMMIT_MSG}" \
            -m "Environment: ${{ inputs.environment }}" \
            -m "Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}" \
            -m "Updated files: ${{ steps.update_files.outputs.files_updated }}" \
            -m "Triggered by: ${{ github.actor }}" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run ID: ${{ github.run_id }}"
          
          git push origin HEAD:${{ inputs.target_branch }}
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Changes committed and pushed successfully"
          echo "ğŸ”— Commit SHA: ${COMMIT_SHA}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”€ PASO 6B: CREAR PULL REQUEST (SI create_pr=true)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”€ Create Pull Request
        id: create_pr
        if: steps.update_files.outputs.changed == 'true' && inputs.create_pr == true
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: |
            ğŸ”„ Update K8s manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}
            
            Environment: ${{ inputs.environment }}
            Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}
            Updated files: ${{ steps.update_files.outputs.files_updated }}
          branch: k8s-update-${{ inputs.environment }}-${{ github.run_id }}
          delete-branch: true
          base: ${{ inputs.target_branch }}
          title: "ğŸ”„ Update K8s manifests - ${{ inputs.environment }} - ${{ inputs.image_tag }}"
          body: |
            ## ğŸ”„ Kubernetes Manifests Update
            
            This PR updates the Kubernetes manifests with the new Docker image tag.
            
            ### ğŸ“‹ Details
            - **Environment**: `${{ inputs.environment }}`
            - **New Image**: `${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}`
            - **Updated Files**: ${{ steps.update_files.outputs.files_updated }}
            - **Triggered by**: @${{ github.actor }}
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ¤– Automated Changes
            This PR was automatically generated by the CI/CD pipeline after a successful build and deployment.
            
            ---
            
            Please review and merge to apply the changes to the `${{ inputs.target_branch }}` branch.
          labels: |
            automated
            k8s-update
            ${{ inputs.environment }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ“Š PASO 7: RESUMEN FINAL
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Summary Report
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š KUBERNETES MANIFESTS UPDATE SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸ³ New Image: ${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.image_tag }}"
          echo "ğŸ“ Manifests Path: ${{ inputs.manifests_path }}"
          echo "ğŸ“„ Target Files: ${{ inputs.manifest_files }}"
          echo "ğŸŒ¿ Target Branch: ${{ inputs.target_branch }}"
          echo ""
          
          if [ "${{ steps.update_files.outputs.changed }}" = "true" ]; then
            echo "âœ… Status: Changes applied"
            echo "ğŸ“‹ Updated Files: ${{ steps.update_files.outputs.files_updated }}"
            echo ""
            
            if [ "${{ inputs.create_pr }}" = "true" ]; then
              echo "ğŸ”€ Action: Pull Request created"
              echo "ğŸ”— PR Number: ${{ steps.create_pr.outputs.pull-request-number }}"
              echo "ğŸ”— PR URL: ${{ steps.create_pr.outputs.pull-request-url }}"
            else
              echo "ğŸ’¾ Action: Direct commit"
              echo "ğŸ”— Commit SHA: ${{ steps.commit.outputs.commit_sha }}"
            fi
          else
            echo "â„¹ï¸  Status: No changes needed"
            echo "   The manifests already have the correct image tag"
          fi
          
          echo ""
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ• Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"