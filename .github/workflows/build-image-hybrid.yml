########################################
# ðŸŽ¯ WORKFLOW REUSABLE: Build HÃ­brido con Seguridad
# Build â†’ Quick Test â†’ Push â†’ Full Security Scan
########################################

name: Hybrid Build & Security Pipeline

on:
  workflow_call:
    inputs:
      docker_image:
        required: true
        type: string
      dockerhub_username:
        required: true
        type: string
      environment:
        required: true
        type: string
      external_repo:
        required: true
        type: string
      external_repo_ref:
        required: false
        type: string
        default: main
      external_repo_path:
        required: false
        type: string
        default: ./app-repo
      dockerfile_path:
        required: true
        type: string
      build_context:
        required: true
        type: string
    secrets:
      DOCKERHUB_TOKEN:
        required: true
      EXTERNAL_REPO_TOKEN:
        required: true

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ”¨ FASE 1: BUILD + QUICK SECURITY SCAN (Local)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-quick-scan:
    name: ðŸ”¨ Build & Quick Scan (${{ inputs.environment }})
    runs-on: ubuntu-latest
    outputs:
      image_full: ${{ steps.meta.outputs.image_full }}
      should_continue: ${{ steps.quick_scan_result.outputs.passed }}
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. PreparaciÃ³n
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¦ Checkout cÃ³digo fuente
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.external_repo }}
          ref: ${{ inputs.external_repo_ref }}
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}
          path: ${{ inputs.external_repo_path }}
          fetch-depth: 1
      - name: ðŸ” Verificar repo clonado
        run: |
            echo "Contenido de ${{ inputs.external_repo_path }}:"
            ls -la ${{ inputs.external_repo_path }}
            
            echo -e "\nVerificando Dockerfile:"
            test -f "${{ inputs.external_repo_path }}/${{ inputs.dockerfile_path }}" && echo "âœ… Dockerfile OK" || (echo "âŒ Dockerfile no encontrado" && exit 1)

      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“ Generar metadata
        id: meta
        run: |
          IMAGE_FULL="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.environment }}"
          echo "image_full=$IMAGE_FULL" >> $GITHUB_OUTPUT
          
          echo "### ðŸ—ï¸ Build de Imagen - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositorio**: ${{ inputs.external_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockerfile**: ${{ inputs.dockerfile_path }}" >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Build de la imagen
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”¨ Construir imagen Docker
        run: |
            docker build \
              -t ${{ steps.meta.outputs.image_full }} \
              -f ${{ inputs.dockerfile_path }} \
              --label "build.timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
              --label "build.environment=${{ inputs.environment }}" \
              --label "build.ref=${{ github.sha }}" \
              ${{ inputs.build_context }}
                .
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Imagen construida exitosamente**" >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. TEST RÃPIDO 1: Hadolint (Dockerfile lint)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ§© Hadolint - Validar Dockerfile
        id: hadolint
        continue-on-error: true
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ inputs.dockerfile_path }}
          failure-threshold: warning
          ignore: DL3018,DL3008

      - name: ðŸ“Š Resultado Hadolint
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Test 1: Hadolint (Dockerfile Best Practices)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.hadolint.outcome }}" == "success" ]; then
            echo "âœ… **PASSED** - Dockerfile cumple con best practices" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **WARNINGS** - Revisa las recomendaciones de Hadolint" >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. TEST RÃPIDO 2: Trivy - Solo CRITICAL
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”Ž Trivy - Quick Scan (Solo CRITICAL)
        id: trivy_quick
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.image_full }}
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
          timeout: '5m'

      - name: ðŸ“Š Resultado Trivy Quick
        id: quick_scan_result
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Test 2: Trivy Quick Scan (Vulnerabilidades CRITICAL)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.trivy_quick.outcome }}" == "success" ]; then
            echo "âœ… **PASSED** - Sin vulnerabilidades CRITICAL detectadas" >> $GITHUB_STEP_SUMMARY
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ **FAILED** - Se detectaron vulnerabilidades CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš¨ **La imagen NO se subirÃ¡ a DockerHub hasta corregir los problemas**" >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. DecisiÃ³n: Â¿Continuar o detener?
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âš–ï¸ Evaluar resultados
        if: steps.quick_scan_result.outputs.passed != 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ Pipeline Detenido" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**RazÃ³n**: Vulnerabilidades CRITICAL detectadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Acciones Requeridas:" >> $GITHUB_STEP_SUMMARY
          echo "1. Revisa los logs de Trivy arriba" >> $GITHUB_STEP_SUMMARY
          echo "2. Actualiza las dependencias vulnerables" >> $GITHUB_STEP_SUMMARY
          echo "3. Reconstruye la imagen" >> $GITHUB_STEP_SUMMARY
          echo "4. Vuelve a ejecutar el pipeline" >> $GITHUB_STEP_SUMMARY
          exit 1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Push a DockerHub (SOLO si pasÃ³ validaciÃ³n)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Login en DockerHub
        if: steps.quick_scan_result.outputs.passed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ“¤ Push a DockerHub
        if: steps.quick_scan_result.outputs.passed == 'true'
        run: |
          docker push ${{ steps.meta.outputs.image_full }}
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Imagen Publicada en DockerHub" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: DockerHub" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen**: \`${{ steps.meta.outputs.image_full }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Pull command**:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.meta.outputs.image_full }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Siguiente paso**: AnÃ¡lisis completo de seguridad desde DockerHub" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” FASE 2: FULL SECURITY SCAN (Desde DockerHub)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  full-security-scan:
    name: ðŸ” Full Security Scan (${{ inputs.environment }})
    needs: build-and-quick-scan
    if: needs.build-and-quick-scan.outputs.should_continue == 'true'
    runs-on: ubuntu-latest
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Pull imagen desde DockerHub
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Login en DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ“¥ Pull imagen desde DockerHub
        run: |
          IMAGE_FULL="${{ needs.build-and-quick-scan.outputs.image_full }}"
          echo "ðŸ“¥ Descargando imagen desde DockerHub..."
          docker pull $IMAGE_FULL
          
          echo "### ðŸ” AnÃ¡lisis Completo de Seguridad - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Trivy FULL (Todas las severidades)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”Ž Trivy - Full Scan (SARIF para GitHub Security)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-and-quick-scan.outputs.image_full }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          vuln-type: 'os,library'

      - name: ðŸ“¤ Subir Trivy a GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-${{ inputs.environment }}'

      - name: ðŸ“Š Trivy - Reporte Visual (Tabla)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-and-quick-scan.outputs.image_full }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: ðŸ“‹ Trivy - Reporte JSON (Para anÃ¡lisis)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-and-quick-scan.outputs.image_full }}
          format: 'json'
          output: 'trivy-report-${{ inputs.environment }}.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Grype - AnÃ¡lisis complementario
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ§¬ Grype - Escaneo de vulnerabilidades
        uses: anchore/scan-action@v4
        id: grype
        with:
          image: ${{ needs.build-and-quick-scan.outputs.image_full }}
          fail-build: false
          severity-cutoff: medium
          output-format: sarif

      - name: ðŸ“¤ Subir Grype a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
          category: 'grype-${{ inputs.environment }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Dockle - Docker best practices
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ‹ Dockle - Docker Best Practices
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | \
            grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -L -o dockle.deb https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.deb
          sudo dpkg -i dockle.deb
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ‹ Dockle - Docker Best Practices" >> $GITHUB_STEP_SUMMARY
          dockle --exit-code 0 --exit-level warn ${{ needs.build-and-quick-scan.outputs.image_full }} | tee dockle-report-${{ inputs.environment }}.txt
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat dockle-report-${{ inputs.environment }}.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. AnÃ¡lisis de tamaÃ±o y eficiencia
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š AnÃ¡lisis de tamaÃ±o de imagen
        run: |
          IMAGE_FULL="${{ needs.build-and-quick-scan.outputs.image_full }}"
          
          SIZE=$(docker images $IMAGE_FULL --format "{{.Size}}")
          LAYERS=$(docker history $IMAGE_FULL --no-trunc | wc -l)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ MÃ©tricas de Imagen" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| TamaÃ±o | $SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| Capas | $LAYERS |" >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Generar resumen de vulnerabilidades
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Generar resumen de vulnerabilidades
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Resumen de Vulnerabilidades" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f trivy-report-${{ inputs.environment }}.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report-${{ inputs.environment }}.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report-${{ inputs.environment }}.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-report-${{ inputs.environment }}.json)
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-report-${{ inputs.environment }}.json)
            
            echo "| Severidad | Cantidad | Estado |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ CRITICAL | $CRITICAL | $([ $CRITICAL -eq 0 ] && echo 'âœ… OK' || echo 'âŒ REVISAR') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  HIGH | $HIGH | $([ $HIGH -eq 0 ] && echo 'âœ… OK' || echo 'âš ï¸ REVISAR') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ MEDIUM | $MEDIUM | $([ $MEDIUM -le 10 ] && echo 'âœ… Aceptable' || echo 'âš ï¸ Mejorable') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”µ LOW | $LOW | â„¹ï¸ Informativo |" >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Subir artefactos
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¤ Subir reportes como artefactos
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ inputs.environment }}
          path: |
            trivy-results.sarif
            trivy-report-${{ inputs.environment }}.json
            dockle-report-${{ inputs.environment }}.txt
          retention-days: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Resumen final
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Resumen Final
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… AnÃ¡lisis Completo Finalizado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Descargas" >> $GITHUB_STEP_SUMMARY
          echo "- [Reportes de seguridad en Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Vulnerabilidades en Security Tab](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ PrÃ³ximos Pasos" >> $GITHUB_STEP_SUMMARY
          echo "1. Revisa las vulnerabilidades detectadas" >> $GITHUB_STEP_SUMMARY
          echo "2. Prioriza correcciÃ³n de CRITICAL y HIGH" >> $GITHUB_STEP_SUMMARY
          echo "3. Implementa las recomendaciones de Dockle" >> $GITHUB_STEP_SUMMARY