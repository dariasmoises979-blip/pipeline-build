# build-image-hybrid.yml
# 🎯 CAMBIO CRÍTICO: Prefijo "hybrid-" para evitar conflictos

name: Hybrid Build & Security Pipeline

on:
  workflow_call:
    inputs:
      docker_image:
        required: true
        type: string
      dockerhub_username:
        required: true
        type: string
      environment:
        required: true
        type: string
      external_repo:
        required: true
        type: string
      external_repo_ref:
        required: false
        type: string
        default: main
      external_repo_path:
        required: false
        type: string
        default: ./app-repo
      dockerfile_path:
        required: true
        type: string
      build_context:
        required: true
        type: string
    secrets:
      DOCKERHUB_TOKEN:
        required: true
      EXTERNAL_REPO_TOKEN:
        required: true

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write

jobs:
  build-and-quick-scan:
    name: 🔨 Build & Quick Scan (${{ inputs.environment }})
    runs-on: ubuntu-latest
    outputs:
      image_full: ${{ steps.meta.outputs.image_full }}
      should_continue: ${{ steps.quick_scan_result.outputs.passed }}
    
    steps:
      - name: 📦 Checkout código fuente
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.external_repo }}
          ref: ${{ inputs.external_repo_ref }}
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}
          path: ${{ inputs.external_repo_path }}
          fetch-depth: 1

      - name: 🔍 Verificar repo clonado
        run: |
            echo "Contenido de ${{ inputs.external_repo_path }}:"
            ls -la ${{ inputs.external_repo_path }}
            pwd
            
            echo -e "\nVerificando Dockerfile:"
            DOCKERFILE_FULL_PATH="${{ inputs.external_repo_path }}/${{ inputs.dockerfile_path }}"
            echo "Buscando: $DOCKERFILE_FULL_PATH"
            test -f "$DOCKERFILE_FULL_PATH" && echo "✅ Dockerfile OK" || (echo "❌ Dockerfile no encontrado" && exit 1)
      
      - name: 🐳 Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 📝 Generar metadata
        id: meta
        run: |
          IMAGE_FULL="${{ inputs.dockerhub_username }}/${{ inputs.docker_image }}:${{ inputs.environment }}"
          echo "image_full=$IMAGE_FULL" >> $GITHUB_OUTPUT
          
          echo "### 🏗️ Build de Imagen - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositorio**: ${{ inputs.external_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockerfile**: ${{ inputs.dockerfile_path }}" >> $GITHUB_STEP_SUMMARY

      - name: 🔨 Construir imagen Docker
        run: |
          DOCKERFILE_FULL_PATH="${{ inputs.external_repo_path }}/${{ inputs.dockerfile_path }}"
          
          docker build \
            -t ${{ steps.meta.outputs.image_full }} \
            -f "$DOCKERFILE_FULL_PATH" \
            --label "build.timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "build.environment=${{ inputs.environment }}" \
            --label "build.ref=${{ github.sha }}" \
            ${{ inputs.build_context }}
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Imagen construida exitosamente**" >> $GITHUB_STEP_SUMMARY
          
      - name: 🧩 Hadolint - Validar Dockerfile
        id: hadolint
        continue-on-error: true
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ inputs.dockerfile_path }}
          failure-threshold: warning
          ignore: DL3018,DL3008

      - name: 📊 Resultado Hadolint
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Test 1: Hadolint (Dockerfile Best Practices)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.hadolint.outcome }}" == "success" ]; then
            echo "✅ **PASSED** - Dockerfile cumple con best practices" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **WARNINGS** - Revisa las recomendaciones de Hadolint" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 🔎 Trivy - Quick Scan (Solo CRITICAL)
        id: trivy_quick
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.image_full }}
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
          timeout: '5m'

      - name: 📊 Resultado Trivy Quick
        id: quick_scan_result
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔍 Test 2: Trivy Quick Scan (Vulnerabilidades CRITICAL)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.trivy_quick.outcome }}" == "success" ]; then
            echo "✅ **PASSED** - Sin vulnerabilidades CRITICAL detectadas" >> $GITHUB_STEP_SUMMARY
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ **FAILED** - Se detectaron vulnerabilidades CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "🚨 **La imagen NO se subirá a DockerHub hasta corregir los problemas**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ⚖️ Evaluar resultados
        if: steps.quick_scan_result.outputs.passed != 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ❌ Pipeline Detenido" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: 🔐 Login en DockerHub
        if: steps.quick_scan_result.outputs.passed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 📤 Push a DockerHub
        if: steps.quick_scan_result.outputs.passed == 'true'
        run: |
          docker push ${{ steps.meta.outputs.image_full }}
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ✅ Imagen Publicada en DockerHub" >> $GITHUB_STEP_SUMMARY

  full-security-scan:
    name: 🔐 Full Security Scan (${{ inputs.environment }})
    needs: build-and-quick-scan
    if: needs.build-and-quick-scan.outputs.should_continue == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: 🔐 Login en DockerHub
        uses: actions/upload-artifact@v4
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 📥 Pull imagen desde DockerHub
        run: |
          IMAGE_FULL="${{ needs.build-and-quick-scan.outputs.image_full }}"
          docker pull $IMAGE_FULL
          
          echo "### 🔍 Análisis Completo de Seguridad - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY

      - name: 🔎 Trivy - Full Scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-and-quick-scan.outputs.image_full }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: 📤 Subir Trivy a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-hybrid-${{ inputs.environment }}'

      - name: 📊 Trivy - Reporte Tabla
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-and-quick-scan.outputs.image_full }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: 📋 Trivy - Reporte JSON
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-and-quick-scan.outputs.image_full }}
          format: 'json'
          output: 'trivy-report-${{ inputs.environment }}.json'

      - name: 🧬 Grype - Escaneo
        uses: anchore/scan-action@v4
        id: grype
        with:
          image: ${{ needs.build-and-quick-scan.outputs.image_full }}
          fail-build: false
          severity-cutoff: medium
          output-format: sarif

      - name: 📤 Subir Grype a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
          category: 'grype-hybrid-${{ inputs.environment }}'

      - name: 🐋 Dockle - Best Practices
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | \
            grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -L -o dockle.deb https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.deb
          sudo dpkg -i dockle.deb
          dockle --exit-code 0 ${{ needs.build-and-quick-scan.outputs.image_full }} | tee dockle-report-${{ inputs.environment }}.txt

      - name: 📊 Generar resumen
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔐 Resumen de Vulnerabilidades" >> $GITHUB_STEP_SUMMARY
          
          if [ -f trivy-report-${{ inputs.environment }}.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report-${{ inputs.environment }}.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report-${{ inputs.environment }}.json)
            
            echo "| Severidad | Cantidad |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
          fi

      # 🔧 CAMBIO CRÍTICO: Usar prefijo "hybrid-" para artifacts
      - name: 📤 Subir reportes
        uses: actions/upload-artifact@v4
        with:
          name: hybrid-security-${{ inputs.environment }}-${{ github.run_id }}
          path: |
            trivy-results.sarif
            trivy-report-${{ inputs.environment }}.json
            dockle-report-${{ inputs.environment }}.txt
          retention-days: 30